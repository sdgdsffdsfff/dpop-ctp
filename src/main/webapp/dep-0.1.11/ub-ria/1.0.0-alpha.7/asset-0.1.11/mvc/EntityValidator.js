define("ub-ria/mvc/EntityValidator",["require","../util","underscore","./checker/requiredChecker","./checker/typeChecker","./checker/rangeLengthChecker","./checker/maxLengthChecker","./checker/minLengthChecker","./checker/rangeChecker","./checker/maxChecker","./checker/minChecker","./checker/enumChecker","./checker/patternChecker"],function(require){function e(){this.initCheckers()}function t(e,n,i,a){for(var r in e)if("id"!==r){var o=n[r],s=e[r],h=this.getFieldCheckers(s),d=a.length>0?a.join(".")+"."+r:r,m={value:o,fieldPath:d,fieldSchema:s},u=this.excuteCheckers(h,m);if(!u)if(!l.isEmpty(o)){if("object"===s[0])a.push(r),t.call(this,s[2].content,n[r],i,a),a.pop();else if("array"===s[0]){a.push(r);for(var c=0;c<o.length;c++){var p={};p[c]=s[2].item,t.call(this,p,o,i,a)}a.pop()}}else;else i.push(u)}else;}function n(e,t){for(var n={},i=/\$\{(.+?)\}/g,a=i.exec(e),r=t[2]||{};a;){var o=a[1];if(n[o]=r[o],!n[o])n[o]=t[1];a=i.exec(e)}return l.template(e,n,{interpolate:i})}function i(e){var t=e[2];if(!t)return e;for(var n=["maxLength","minLength","min","max","pattern"],i=l.keys(t),r=l.intersection(n,i),o=0;o<r.length;o++){var s=r[o],h=t[s];if(l.isString(h)){var d=h.split(".");d=d.slice(1);var m=this.rule[d[0]];m=d.length>1?a(m,d.slice(1)):m,t[s]=m}else;}return e}function a(e,t){for(var n=e,i=0;i<t.length;i++)n=n[t[i]];return n}function r(e){var t=["content","item","datasource"],n=[],i=e[0],a=e[2]||{};if(a=l.omit(a,t),a.required===!1)delete a.required;if([].push.apply(n,l.keys(a)),"reference"!==i&&"reference-set"!==i)n.push("type");return n=o(n,"rangeLength","minLength","maxLength"),n=o(n,"range","min","max")}function o(e,t,n,i){if(l.indexOf(e,n)>=0&&l.indexOf(e,i)>=0)e=l.without(e,n,i),e.push(t);return e}var s=require("../util"),l=require("underscore"),h={required:require("./checker/requiredChecker"),type:require("./checker/typeChecker"),rangeLength:require("./checker/rangeLengthChecker"),maxLength:require("./checker/maxLengthChecker"),minLength:require("./checker/minLengthChecker"),range:require("./checker/rangeChecker"),max:require("./checker/maxChecker"),min:require("./checker/minChecker"),"enum":require("./checker/enumChecker"),pattern:require("./checker/patternChecker")};return e.prototype.initCheckers=function(){this.checkers=s.deepClone(h)},e.prototype.setErrorMessages=function(e){if(e){var t=this.getCheckers();l.each(e,function(e,n){var i=t[n];if(i)i.errorMessage=e})}},e.prototype.addChecker=function(e){if(e&&e.name&&e.errorMessage&&e.check&&e.priority){var t=this.getCheckers();return t[e.name]=e,this.checkers[e.name]}return null},e.prototype.removeChecker=function(e){var t=this.getCheckers();return delete t[e]},e.prototype.getCheckers=function(){return this.checkers||{}},e.prototype.setSchema=function(e){this.schema=e},e.prototype.getSchema=function(){return this.schema},e.prototype.setRule=function(e){this.rule=e},e.prototype.getRule=function(){return this.rule},e.prototype.validate=function(e){var n=this.getSchema(),i=[],a=[];return t.call(this,n,e,i,a),i},e.prototype.excuteCheckers=function(e,t){var a=t.value,r=t.fieldPath,o=s.deepClone(t.fieldSchema);o=i.call(this,o);for(var h=0;h<e.length;h++){var d=e[h],m=d.check(a,o);if(!m){var u=d.errorMessage;if("object"==typeof u)u=u[o[0]];if(!l.isString(u))throw new Error("未找到对应错误信息模板");var c=n(u,o),p={field:r,message:c};return p}}return null},e.prototype.getFieldCheckers=function(e){for(var t=r(e),n=this.getCheckers(),i=[],a=0;a<t.length;a++)if(n[t[a]])i.push(n[t[a]]);return i.sort(function(e,t){return e.priority-t.priority}),i},e});