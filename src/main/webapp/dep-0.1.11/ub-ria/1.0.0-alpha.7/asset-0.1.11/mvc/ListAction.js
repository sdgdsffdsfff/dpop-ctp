define("ub-ria/mvc/ListAction",["require","./BaseAction","er/util","underscore","er/URL","../util"],function(require){function e(){m.apply(this,arguments)}function t(){this.performSearch()}function n(e){this.model.updatePageSize(e.pageSize).then(c.bind(i,this,e.pageSize))}function i(){var e=this.fire("pagesizechange");if(!e.isDefaultPrevented()){var t=this.getSearchQuery();t.page=1,this.reloadWithQueryUpdate(t)}}function a(){var e=this.fire("pagechange");if(!e.isDefaultPrevented()){var t=this.getSearchQuery();this.reloadWithQueryUpdate(t)}}function r(){var e=this.fire("tablesort");if(!e.isDefaultPrevented()){var t=this.getSearchQuery();t.page=1,this.reloadWithQueryUpdate(t)}}function o(e){var t=this.view.getSelectedItems();this.modifyStatus(t,e.status)}function s(e){this.model[e.statusName](e.ids).then(c.bind(h,this,e),c.bind(this.notifyModifyFail,this,e))}function l(e,t){var n={title:e.command+this.getEntityDescription(),content:t.message};return this.view.waitConfirm(n)}function h(e){this.notifyModifySuccess(e);var t=this.fire("statusupdate",e);if(!t.isDefaultPrevented())this.reload()}function d(e){var t=this.context.url,n=t.getPath(),i=this.model.getDefaultArgs();return e=require("../util").purify(e,i),require("er/URL").withQuery(n,e).toString()}var m=require("./BaseAction"),u=require("er/util"),c=require("underscore"),p=require("er/URL");return u.inherits(e,m),e.prototype.modelType="./ListModel",e.prototype.category="list",e.prototype.performSearch=function(){var e=this.fire("search");if(!e.isDefaultPrevented()){var t=this.getSearchQuery();t.page=1,this.reloadWithQueryUpdate(t)}},e.prototype.redirectForSearch=function(e){var t=this.model.get("url").getPath(),n=p.withQuery(t,e);this.redirect(n,{force:!0})},e.prototype.getURLForPage=function(e){var t=this.context.url,n=t.getPath(),i=t.getQuery();if(1===e)i=c.omit(i,"page");else i.page=e;return require("er/URL").withQuery(n,i).toString()},e.prototype.getSearchQuery=function(){var e=this.view.getSearchArgs();return e.page=this.view.getPageIndex(),e},e.prototype.reloadWithQueryUpdate=function(e){var t=d.call(this,e);this.redirect(t,{force:!0})},e.prototype.modifyStatus=function(e,t){var n=c.pluck(e,"id"),i=c.findWhere(this.model.getStatusTransitions(),{status:t}),a={ids:n,items:e,status:t,statusName:i.statusName,command:i.command};if(this.requireAdviceFor(a)){var r=require("../util").pascalize(a.statusName),o="get"+r+"Advice";this.model[o](a.ids,a.items).then(c.bind(l,this,a)).then(c.bind(s,this,a))}else s.call(this,a)},e.prototype.notifyModifySuccess=function(){},e.prototype.notifyModifyFail=function(e){var t=this.getEntityDescription();if(e.ids.length>1)this.view.alert("无法"+e.command+"部分或全部"+t,e.command+t);else this.view.alert("无法"+e.command+"该"+t,e.command+t)},e.prototype.requireAdviceFor=function(e){return"remove"===e.statusName},e.prototype.initBehavior=function(){m.prototype.initBehavior.apply(this,arguments),this.view.on("search",t,this),this.view.on("pagesizechange",n,this),this.view.on("batchmodify",o,this),this.view.on("pagechange",a,this),this.view.on("tablesort",r,this)},e.prototype.adjustLayout=function(){this.view.adjustLayout()},e});