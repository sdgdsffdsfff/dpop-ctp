define("ub-ria/ui/TreeRichSelector",["require","esui/Tree","esui/painters","esui/main","esui/lib","underscore","../util","./RichSelector","./SelectorTreeStrategy","esui"],function(require){function e(){f.apply(this,arguments)}function t(e,t,n){var a=e.getQueryList().getChild("tree"),r=e.indexData,o=r[t];if(o){if(!e.multi&&n)i(e),e.currentSeletedId=t;if(e.setItemState(t,"isSelected",n),n)a.selectNode(t,!0);else a.unselectNode(t,!0)}}function i(e){var t=e.currentSeletedId;if(t){var i=e.getQueryList().getChild("tree");i.unselectNode(t),e.currentSeletedId=null}}function n(e,i,n){if(e.needSyncParentChild){var a=e.indexData,r=i.node,o=r.children||[];c.each(o,function(i){if(t(e,i.id,n),i.children)c.each(i.children,function(i){t(e,i.id,n)})});var s=i.parentId,l=a[s];if(l){var h=l.node.children||[],d=!0;c.each(h,function(t){if(!e.getItemState(t.id,"isSelected"))d=!1}),t(e,s,d)}}}function a(e,t){var i,n=e.indexData,r=n[t],o=r.parentId,s=n[o];if(!s)i=e.allData;else i=s.node;var l=i.children||[],d=c.without(l,r.node);if(0===d.length&&o!==h(e))a(e,o);else i.children=d,e.refresh()}function r(e){var t=e.children;return c.filter(t,function(e){return this.getItemState(e.id,"isSelected")},this)}function o(e,t){var i=[],n=t.children;return c.each(n,function(t){var n;if(-1!==t.text.indexOf(e))n=c.clone(t);if(t.children&&t.children.length){var a=o(e,t);if(a.length>0){if(!n)n=c.clone(t);n.children=a}}if(n)i.push(n)}),i}function s(e){return!e.children}function l(e,t,i){var n=1;if(i){if(s(t))if(!t.id||t.id===h(e))return 0;else return 1;n=0}else if(t.id===h(e))n=0;return n+=c.reduce(t.children,function(t,n){return t+l(e,n,i)},0)}function h(e){return e.datasource.id}require("esui/Tree");var d=require("esui/painters"),u=require("esui/main"),m=require("esui/lib"),c=require("underscore"),p=require("../util"),f=require("./RichSelector"),V=require("./SelectorTreeStrategy");return m.inherits(e,f),e.prototype.type="TreeRichSelector",e.prototype.styleType="RichSelector",e.prototype.initOptions=function(e){var t={datasource:null,orientExpand:!1,wideToggleArea:!1,onlyLeafSelect:!0,allowUnselectNode:!1,hideRoot:!0,needSyncParentChild:!0};if(m.extend(t,e),"false"===t.onlyLeafSelect)t.onlyLeafSelect=!1;if("false"===t.orientExpand)t.orientExpand=!1;if("false"===t.hideRoot)t.hideRoot=!1;if("false"===t.wideToggleArea)t.wideToggleArea=!1;if("false"===t.multi)t.multi=!1;if(t.multi===!1)t.onlyLeafSelect=!0;if("false"===t.needSyncParentChild)t.needSyncParentChild=!1;f.prototype.initOptions.call(this,t)},e.prototype.initStructure=function(){if(f.prototype.initStructure.apply(this,arguments),m.addClass(this.main,"ui-tree-richselector"),this.onlyLeafSelect)this.addState("only-leaf-selectable")},e.prototype.repaint=d.createRepaint(f.prototype.repaint,{name:"datasource",paint:function(e){e.refresh()}},{name:"selectedData",paint:function(e,t){var i=e.allData;if(i&&i.children){var n=e.getSelectedItems();e.selectItems(n,!1),e.selectItems(t,!0),e.fire("add"),e.fire("change")}}}),e.prototype.adaptData=function(){var e=[];this.allData=this.datasource;var t={};if(this.allData&&this.allData.children)this.walkTree(this.allData,this.allData.children,function(i,n){if(t[n.id]={parentId:i.id,node:n,isSelected:!1},n.hasOwnProperty("isSelected"))t[n.id].isSelected=n.isSelected;if(t[n.id].isSelected===!0)e.push(n)});return this.indexData=t,{indexData:t,selectedData:e}},e.prototype.processDataAfterRefresh=function(e){if("delete"!==this.mode)this.selectItems(e.selectedData,!0)},e.prototype.refreshContent=function(){var e=this.isQuery()?this.queriedData:this.allData;if(!e||!e.children||!e.children.length)this.addState("empty");else this.removeState("empty");if(e&&e.children){var t=this.getQueryList(),i=t.getChild("tree");if(!i){var n={childName:"tree",datasource:e,allowUnselectNode:this.allowUnselectNode,strategy:new V({mode:this.mode,onlyLeafSelect:this.onlyLeafSelect,orientExpand:this.orientExpand}),wideToggleArea:this.wideToggleArea,hideRoot:this.hideRoot,selectMode:this.multi?"multiple":"single"};if(this.getItemHTML)n.getItemHTML=this.getItemHTML;if(this.itemTemplate)n.itemTemplate=this.itemTemplate;i=u.create("Tree",n),t.addChild(i),i.appendTo(t.main);var a=this;i.on("selectnode",function(e){var t=e.node;a.handlerAfterClickNode(t)}),i.on("unselectnode",function(e){a.setItemState(e.node.id,"isSelected",!1)})}else i.setProperties({datasource:p.deepClone(e),keyword:this.getKeyword()})}},e.prototype.getStateNode=function(e){return this.indexData[e]},e.prototype.getItemState=function(e,t){if(this.indexData[e]){var i=this.getStateNode(e);return i[t]}return null},e.prototype.setItemState=function(e,t,i){if(this.indexData[e]){var n=this.getStateNode(e);n[t]=i}},e.prototype.getDatasourceWithState=function(){var e=c.deepClone(this.datasource),t=this.indexData;return this.walkTree(e,e.children,function(e,i){i.isSelected=t[i.id].isSelected}),e},e.prototype.handlerAfterClickNode=function(e){var t=this.indexData[e.id];if(t)if("add"===this.mode)this.actionForAdd(t);else if("delete"===this.mode)this.actionForDelete(t);else if("load"===this.mode)this.actionForLoad(t)},e.prototype.actionForAdd=function(e){if(this.setItemState(e.node.id,"isSelected",!0),!this.multi){if(this.currentSeletedId)this.setItemState(this.currentSeletedId,"isSelected",!1);this.currentSeletedId=e.node.id}else n(this,e,!0);this.fire("add",{item:e.node}),this.fire("change")},e.prototype.selectAll=function(){var e=this.isQuery()?this.queriedData:this.allData,i=e.children,n=this.getLeafItems(i,!1),a=this;c.each(n,function(e){t(a,e.id,!0)}),this.fire("add"),this.fire("change")},e.prototype.selectItems=function(e,i){var a=this.indexData;if(a){var r=this;c.each(e,function(e){var o=void 0!==e.id?e.id:e,s=a[o];if(null!=s&&void 0!==s)t(r,o,i),n(r,s,i)})}},e.prototype.actionForDelete=function(e){var t=this.fire("delete",{items:[e.node]});if(!t.isDefaultPrevented())a(this,e.node.id),this.fire("change")},e.prototype.deleteAll=function(){var e=this.fire("delete",{items:this.allData.children});if(!e.isDefaultPrevented())this.set("datasource",null),this.fire("change")},e.prototype.actionForLoad=function(e){if(this.setItemState(e.node.id,"isActive",!0),this.currentActiveId)if(this.setItemState(this.currentActiveId,"isActive",!1),!this.getStateNode(this.currentActiveId).isSelected){var t=this.getQueryList().getChild("tree");t.unselectNode(this.currentActiveId,!0)}this.currentActiveId=e.node.id,this.fire("load",{item:e.node}),this.fire("change")},e.prototype.getLeafItems=function(e,t){e=e||this.allData&&this.allData.children||[];var i=[],n=this;return c.each(e,function(e){if(s(e)){var a=t===this.getItemState(e.id,"isSelected");if("delete"===n.mode||a)i.push(e)}else i=c.union(i,n.getLeafItems(e.children,t))},this),i},e.prototype.getSelectedItems=function(){if(!this.allData)return[];var e=[],t=this;return this.walkTree(this.allData,this.allData.children,function(i,n){if(t.getStateNode(n.id).isSelected)e.push(n)}),e},e.prototype.getSelectedTree=function(){var e=this,t=p.deepClone(this.allData),i=t.children;c.each(i,function(t){var i=r(t,e);if(i.length)t.children=i;else t.children=null});var n=c.filter(i,function(e){return e.children});return t.children=n,t},e.prototype.clearQuery=function(){if(f.prototype.clearQuery.apply(this,arguments),"delete"!==this.mode){var e=this.getSelectedItems();this.selectItems(e,!0)}return!1},e.prototype.clearData=function(){this.queriedData={}},e.prototype.queryItem=function(e){var t=e[0].value,i=[];i=o(t,this.allData),this.queriedData={id:h(this),text:"符合条件的结果",children:i},this.addState("queried"),this.refreshContent();var n=this.getSelectedItems();if("delete"!==this.mode)this.selectItems(n,!0)},e.prototype.walkTree=function(e,t,i){c.each(t,function(t){i(e,t),this.walkTree(t,t.children,i)},this)},e.prototype.getFilteredItemsCount=function(){var e=this.isQuery()?this.queriedData:this.allData,t=l(this,e,!0);return t},e.prototype.getCurrentStateItemsCount=function(){var e=this.isQuery()?this.queriedData:this.allData;if(!e)return 0;var t=l(this,e,!0);return t},require("esui").register(e),e});