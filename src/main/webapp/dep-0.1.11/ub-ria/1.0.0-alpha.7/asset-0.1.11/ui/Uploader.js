define("ub-ria/ui/Uploader",["require","esui/lib","esui/controlHelper","esui/validator/Validity","esui/validator/ValidityState","esui/InputControl","underscore","esui"],function(require){function e(){s.apply(this,arguments)}function t(){this.removeState("busy"),this.addState("complete"),this.addState("uploaded");var e=this.helper.getPart("button");e.innerHTML=l.escape(this.overrideText);var t=new r;this.showValidity(t),this.fire("change")}function i(){this.removeState("busy"),this.removeState("complete"),this.removeState("uploaded"),this.helper.getPart("button").innerHTML=l.escape(this.text),this.fileInfo="";var e=document.createElement("input");e.type="file",e.id=this.helper.getId("input"),this.name&&(e.name=this.name);var t=this.helper.getPart("input");this.helper.removeDOMEvent(t,"change"),this.main.firstChild.replaceChild(e,t),this.helper.addDOMEvent(e,"change",n.bind(this.receiveFile,this))}var n=require("esui/lib"),a=require("esui/controlHelper"),r=require("esui/validator/Validity"),o=require("esui/validator/ValidityState"),s=require("esui/InputControl"),l=require("underscore");e.prototype.type="Uploader";var h={image:{".jpg":!0,".jpeg":!0,".gif":!0,".bmp":!0,".tif":!0,".tiff":!0,".png":!0},flash:{".flv":!0,".swf":!0}};return e.defaultProperties={width:80,height:25,fileType:"*",method:"POST",text:"点击上传",overrideText:"重新上传",busyText:"正在上传...",completeText:"上传完成",autoUpload:!0,extraArgs:{},action:"",mimeTypes:h},e.prototype.initOptions=function(t){var i={};if(n.extend(i,e.defaultProperties,t),n.isInput(this.main))i.accept=i.accept||n.getAttribute(this.main,"accept"),i.name=i.name||this.main.name;else if("FORM"===this.main.nodeName)if(i.action=i.action||this.main.action,!t.method&&n.hasAttribute(this.main,"method"))i.method=this.main.method;if("string"==typeof i.accept)i.accept=n.splitTokenList(i.accept);if("false"===i.autoUpload)i.autoUpload=!1;if(!i.hasOwnProperty("title")&&this.main.title)i.title=this.main.title;this.setProperties(i)},e.prototype.initStructure=function(){if("FORM"!==this.main.nodeName)this.helper.replaceMain();this.callbackName=n.getGUID("esuiShowUploadResult"),window[this.callbackName]=n.bind(this.showUploadResult,this);var e=this.helper.getPartClassName("indicator"),t=this.helper.getPartClassName("button"),i=this.helper.getId("iframe"),a=['<div id="'+this.helper.getId("input-container")+'">','<span id="'+this.helper.getId("button")+'" ','class="'+t+'">',"</span>",'<input type="hidden" name="callback" ','value="'+this.callbackName+'" ',"/>",'<input type="hidden" name="sessionToken" ','value="'+this.getSessionToken()+'" ',"/>",'<input type="file" ','id="'+this.helper.getId("input")+'" ',this.name?'name="'+this.name+'" ':" ","/>"];l.each(this.extraArgs,function(e,t){a.push('<input type="hidden" name="'+t+'" ','value="'+e+'"/>')}),a.push("</div>",'<div id="'+this.helper.getId("indicator-wrapper")+'"','class="'+e+'">','<span id="'+this.helper.getId("indicator")+'"></span>',"</div>",'<iframe id="'+i+'" name="'+i+'"',' src="about:blank"></iframe>'),this.main.innerHTML=a.join("");var r=this.helper.createPart("form","form");r.setAttribute("enctype","multipart/form-data"),r.target=i,document.body.appendChild(r);var o=this.helper.getPart("input");this.helper.addDOMEvent(o,"change",n.bind(this.receiveFile,this))},e.prototype.repaint=a.createRepaint(s.prototype.repaint,{name:["method","action"],paint:function(e,t,i){var n=e.helper.getPart("form");n.method=t,n.action=i}},{name:["text","overrideText"],paint:function(e,t,i){var n=e.helper.getPart("button"),a=e.hasState("uploaded")?l.escape(i):l.escape(t);n.innerHTML=a}},{name:["busyText","completeText"],paint:function(e,t,i){var n=e.helper.getPart("indicator"),a=e.hasState("busy")?l.escape(t):l.escape(i);n.innerHTML=a}},{name:"accept",paint:function(e,t){var i=e.helper.getPart("input");if(t)n.setAttribute(i,"accept",t.join(","));else n.removeAttribute(i,"accept")}},{name:["disabled","readOnly"],paint:function(e,t,i){var n=e.helper.getPart("input");n.disabled=t,n.readOnly=i}},{name:["width","height"],paint:function(e,t,i){var n=t+"px",a=i+"px";e.main.style.width=n,e.main.style.height=a;var r=e.helper.getPart("button");r.style.lineHeight=a;var o=e.helper.getPart("indicator");o.style.lineHeight=a}},{name:"rawValue",paint:function(e,n){if(n)if(l.isEqual(n,{}))i.call(e);else{if(!n.hasOwnProperty("type"))n.type=e.fileType;e.fileInfo=n,t.call(e,n),e.removeState("complete")}}}),e.prototype.checkFileFormat=function(e){if(this.accept){var t=e.split(".");t="."+t[t.length-1].toLowerCase();for(var i=!1,n=0;n<this.accept.length;n++){var a=this.accept[n].toLowerCase();if(a===t){i=!0;break}if("*"===a.slice(-1)[0]){var r=a.split("/")[0],o=this.mimeTypes[r];if(o&&o.hasOwnProperty(t)){i=!0;break}}}if(!i){var s=this.acceptErrorMessage||"仅接受以下文件格式："+this.accept.join(",");this.notifyFail(s)}return i}else return!0},e.prototype.submit=function(){this.showUploading();var e=this.helper.getPart("input-container"),t=this.helper.getPart("form");t.appendChild(e),t.submit(),this.main.insertBefore(e,this.main.firstChild)},e.prototype.receiveFile=function(){var e=this.helper.getPart("input"),t=e.value;if(t&&this.checkFileFormat(t))if(this.fire("receive"),this.autoUpload)this.submit()},e.prototype.showUploading=function(){this.removeState("complete"),this.addState("busy");var e=this.helper.getPart("indicator");e.innerHTML=l.escape(this.busyText)},e.prototype.showUploadResult=function(e){if(e.fields)this.fire("fail",{fields:e.fields}),this.notifyFail(e.fields[0].message);else if(e.info){if(!e.info.hasOwnProperty("type"))e.info.type=this.fileType;this.fileInfo=e.info,this.fire("complete"),this.notifyComplete(e.info)}},e.prototype.notifyFail=function(e){e=e||"上传失败";var t=new r,i=new o(!1,e);t.addState("upload",i),this.showValidity(t),this.removeState("busy")},e.prototype.notifyComplete=function(e){t.call(this,e);var i=this.helper.getPart("indicator");i.innerHTML=l.escape(this.completeText),this.timer=setTimeout(n.bind(this.removeState,this,"complete"),1e3)},e.prototype.getRawValue=function(){return this.fileInfo||null},e.prototype.getRawValueProperty=e.prototype.getRawValue,e.prototype.getFileName=function(){return this.helper.getPart("input").value||""},e.prototype.getSessionToken=function(){return""},e.prototype.dispose=function(){try{delete window[this.callbackName]}catch(e){window[this.callbackName]=void 0}var t=this.helper.getPart("form");n.removeNode(t),s.prototype.dispose.apply(this,arguments)},n.inherits(e,s),require("esui").register(e),e});