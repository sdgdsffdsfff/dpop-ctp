define("ub-ria/ui/TableRichSelector",["require","esui/lib","esui/painters","underscore","../util","./RichSelector","esui"],function(require){function e(){f.apply(this,arguments)}function t(e){for(var t=e.helper.getPartClassName("head-table"),i=['<table border=0 class="'+t+'"><tr>'],n=e.fields.length,a=0;n>a;a++){var r=e.fields[a];i.push('<th class="th'+a+'" style="width:'+r.width+'px;">'+r.title||"</th>")}return i.push('<th style="width:30px;"></th>'),i.push("</tr></table>"),i.join(" ")}function i(e,t){var i=e.indexData,a=e.helper,r=a.getPartClassName("content-table"),o=['<table border=0 class="'+r+'">'],s=a.getPartClassName("row"),l=a.getPartClassName("row-selected"),h=a.getPartClassName("row-disabled");return c.each(t,function(t,a){var r=[s];if(t.isSelected)r.push(l);if(t.isDisabled)r.push(h);o.push(m.format(e.rowTpl,{rowId:e.helper.getId("row-"+t.id),rowClass:r.join(" "),index:i[t.id],content:n(e,t,a)}))}),o.push("</table>"),o.join(" ")}function n(e,t,i,n){var a=e.fields,r=[],o=e.helper.getPartClassName("row-field"),s=0;c.each(a,function(a,l){var h=a.content,d="function"==typeof h?h.call(e,t,i,l):t[h];if(n){var m=n.insertCell(l);m.style.width=a.width+"px",m.title=d,m.innerHTML=d}else{var u='<td class="'+o+'" title="'+d+'" style="width:'+a.width+'px;">'+d+"</td>";r.push(u)}s++});var l=e.helper.getPartClassName("row-action-icon"),h='<span class="'+l+'"></span>';if(n){var d=n.insertCell(s);d.style.width="30px",d.innerHTML=h}else return r.push('<td style="width:30px;">'+h+"</td>"),r.join(" ")}function a(e,t,i){var n=e.helper.getPartClassName("row-selected"),a=!1;if(m.hasClass(t,n)){if(!e.multi)r(e,i.id,!1),a=!0}else r(e,i.id,!0),a=!0;if(a)e.fire("add",{item:i}),e.fire("change")}function r(e,t,i){var n=e.indexData,a=e.allData,r=n[t],l=a[r];if(!e.multi)o(e),e.currentSelectedId=i?t:null;s(e,l,i)}function o(e){var t=e.currentSelectedId;if(t){var i=e.indexData[t],n=e.allData[i];s(e,n,!1),e.currentSelectedId=null}}function s(e,t,i){if(t){t.isSelected=i;var n=e.helper.getPart("row-"+t.id),a=i?m.addClass:m.removeClass;a(n,e.helper.getPartClassName("row-selected"))}}function l(e,t,i){h(e,i.id),e.fire("delete",{items:[i]}),e.fire("change")}function h(e,t){var i=e.indexData,n=i[t],a=[].slice.call(e.datasource,0);a.splice(n,1),e.set("datasource",a)}function d(e,t,i){var n=e.helper.getPartClassName("row-selected");if(!m.hasClass(t,n))r(e,i.id,!0),e.fire("load"),e.fire("change")}var m=require("esui/lib"),u=require("esui/painters"),c=require("underscore"),p=require("../util"),f=require("./RichSelector");return m.inherits(e,f),e.prototype.type="TableRichSelector",e.prototype.styleType="RichSelector",e.prototype.initOptions=function(e){var t={hasRowHead:!0,hasIcon:!0,firedOnIcon:!1,datasource:[],selectedData:[],fields:[{field:"name",content:"name",searchScope:"partial",isDefaultSearchField:!0}]};if("false"===e.hasRowHead)e.hasRowHead=!1;if("false"===e.hasIcon)e.hasIcon=!1;if("false"===e.firedOnIcon)e.firedOnIcon=!1;m.extend(t,e),f.prototype.initOptions.call(this,t)},e.prototype.initStructure=function(){f.prototype.initStructure.apply(this,arguments),m.addClass(this.main,"ui-table-richselector")},e.prototype.repaint=u.createRepaint(f.prototype.repaint,{name:["datasource","selectedData","disabledData"],paint:function(e){e.refresh(),e.fire("change")}}),e.prototype.adaptData=function(){var e=p.deepClone(this.datasource),t={};c.each(e,function(e,i){t[e.id]=i}),this.indexData=t;var i=this.selectedData||[];if(!this.multi)if(!c.isArray(i))this.currentSelectedId=i,i=[{id:i}];else if(i.length)this.currentSelectedId=i[0].id;c.each(i,function(i){var n=t[i.id];if(void 0!==n)e[n].isSelected=!0});var n=this.disabledData||[];c.each(n,function(i){var n=t[i.id];if(void 0!==n)e[n].isDisabled=!0}),this.allData=e,this.fieldsIndex={},this.defaultSearchFields=[],c.each(this.fields,function(e){if(this.fieldsIndex[e.field]=e,e.isDefaultSearchField)this.defaultSearchFields.push(e.field)},this)},e.prototype.refreshContent=function(){var e=this.isQuery()?this.queriedData:this.allData;if(!e||0===e.length)this.addState("empty");else this.removeState("empty");var n=[];if(this.hasRowHead)n.push(t(this));n.push(i(this,e));var a=this.getQueryList();a.setContent(n.join(""))},e.prototype.rowTpl='<tr id="${rowId}" class="${rowClass}" index="${index}">${content}</tr>',e.prototype.eventDispatcher=function(e){for(var t=e.target,i=this.helper,n=i.getPartClassName("row"),a=i.getPartClassName("row-action-icon");t&&t!==document.body;){var r;if(this.hasIcon&&this.fireOnIcon&&m.hasClass(t,a))r=t.parentNode;else if(m.hasClass(t,n))r=t;if(r)return void this.operateRow(r);t=t.parentNode}},e.prototype.operateRow=function(e){var t=this.helper.getPartClassName("row-disabled");if(!m.hasClass(e,t)){var i=parseInt(e.getAttribute("index"),10),n=this.allData[i];if(n)if("add"===this.mode)a(this,e,n);else if("delete"===this.mode)l(this,e,n);else if("load"===this.mode)d(this,e,n)}},e.prototype.selectAll=function(){var e=this.isQuery()?this.queriedData:this.allData,t=this;c.each(e,function(e){r(t,e.id,!0)}),this.fire("add"),this.fire("change")},e.prototype.selectItems=function(e,t){var i=this.allData,n=this.indexData,a=this;c.each(e,function(e){var o=void 0!==e.id?e.id:e,s=n[o];if(null!==s&&void 0!==s){var l=i[s];r(a,l.id,t)}})},e.prototype.deleteAll=function(){var e=c.clone(this.datasource);this.set("datasource",[]),this.fire("delete",{items:e}),this.fire("change")},e.prototype.queryItem=function(e){function t(e,t,i){var n=!1;if("string"==typeof t)t=m.trim(t);if("partial"===this.fieldsIndex[e].searchScope){if(-1!==i[e].indexOf(t))n=!0}else if(i[e]===t)n=!0;return n}function i(i){return!c.any(e,function(e){var n=[];if(void 0===e.keys)n=this.defaultSearchFields;else n=e.keys;return!c.any(n,function(n){return t.call(this,n,e.value,i)},this)},this)}e=e||[],this.queriedData=c.filter(this.allData,i,this),this.addState("queried"),this.refreshContent()},e.prototype.clearData=function(){this.queriedData=[]},e.prototype.getSelectedItems=function(){var e=this.datasource,t=this.allData,i=this.mode;if("delete"===i)return t;var n=c.filter(e,function(e,i){return t[i].isSelected});return n},e.prototype.getCurrentStateItemsCount=function(){var e=this.isQuery()?this.queriedData:this.allData;return e=e||[],e.length},require("esui").register(e),e});