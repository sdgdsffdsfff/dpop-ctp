define("echarts/chart/pie",["require","./base","zrender/shape/Text","zrender/shape/Ring","zrender/shape/Circle","zrender/shape/Sector","zrender/shape/Polyline","../config","../util/ecData","zrender/tool/util","zrender/tool/math","zrender/tool/color","../chart"],function(require){function e(e,i,a,s,r){t.call(this,e,i,a,s,r);var o=this;o.shapeHandler.onmouseover=function(e){var t=e.target,i=n.get(t,"seriesIndex"),a=n.get(t,"dataIndex"),s=n.get(t,"special"),r=[t.style.x,t.style.y],l=t.style.startAngle,h=t.style.endAngle,d=((h+l)/2+360)%360,p=t.highlightStyle.color,c=o.getLabel(i,a,s,r,d,p,!0);if(c)o.zr.addHoverShape(c);var u=o.getLabelLine(i,a,r,t.style.r0,t.style.r,d,p,!0);if(u)o.zr.addHoverShape(u)},this.refresh(s)}var t=require("./base"),i=require("zrender/shape/Text"),a=require("zrender/shape/Ring"),s=require("zrender/shape/Circle"),r=require("zrender/shape/Sector"),o=require("zrender/shape/Polyline"),l=require("../config");l.pie={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,center:["50%","50%"],radius:[0,"75%"],clockWise:!0,startAngle:90,minAngle:0,selectedOffset:10,itemStyle:{normal:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:20,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!1},labelLine:{show:!1,length:20,lineStyle:{width:1,type:"solid"}}}}};var n=require("../util/ecData"),h=require("zrender/tool/util"),d=require("zrender/tool/math"),p=require("zrender/tool/color");return e.prototype={type:l.CHART_TYPE_PIE,_buildShape:function(){var e=this.series,t=this.component.legend;this.selectedMap={},this._selected={};var i,r,o;this._selectedMode=!1;for(var h,d=0,p=e.length;p>d;d++)if(e[d].type===l.CHART_TYPE_PIE){if(e[d]=this.reformOption(e[d]),this.legendHoverLink=e[d].legendHoverLink||this.legendHoverLink,h=e[d].name||"",this.selectedMap[h]=t?t.isSelected(h):!0,!this.selectedMap[h])continue;if(i=this.parseCenter(this.zr,e[d].center),r=this.parseRadius(this.zr,e[d].radius),this._selectedMode=this._selectedMode||e[d].selectedMode,this._selected[d]=[],this.deepQuery([e[d],this.option],"calculable"))o={zlevel:this.getZlevelBase(),z:this.getZBase(),hoverable:!1,style:{x:i[0],y:i[1],r0:r[0]<=10?0:r[0]-10,r:r[1]+10,brushType:"stroke",lineWidth:1,strokeColor:e[d].calculableHolderColor||this.ecTheme.calculableHolderColor||l.calculableHolderColor}},n.pack(o,e[d],d,void 0,-1),this.setCalculable(o),o=r[0]<=10?new s(o):new a(o),this.shapeList.push(o);this._buildSinglePie(d),this.buildMark(d)}this.addShapeList()},_buildSinglePie:function(e){for(var t,i=this.series,a=i[e],s=a.data,r=this.component.legend,o=0,l=0,n=0,h=Number.NEGATIVE_INFINITY,d=[],p=0,c=s.length;c>p;p++)if(t=s[p].name,this.selectedMap[t]=r?r.isSelected(t):!0,this.selectedMap[t]&&!isNaN(s[p].value)){if(0!==+s[p].value)o++;else l++;n+=+s[p].value,h=Math.max(h,+s[p].value)}if(0!==n){for(var u,g,f,m,y,v,_=100,b=a.clockWise,x=(a.startAngle.toFixed(2)-0+360)%360,S=a.minAngle||.01,L=360-S*o-.01*l,M=a.roseType,p=0,c=s.length;c>p;p++)if(t=s[p].name,this.selectedMap[t]&&!isNaN(s[p].value)){if(g=r?r.getColor(t):this.zr.getColor(p),_=s[p].value/n,"area"!=M)u=b?x-_*L-(0!==_?S:.01):_*L+x+(0!==_?S:.01);else u=b?x-360/c:360/c+x;if(u=u.toFixed(2)-0,_=(100*_).toFixed(2),f=this.parseCenter(this.zr,a.center),m=this.parseRadius(this.zr,a.radius),y=+m[0],v=+m[1],"radius"===M)v=s[p].value/h*(v-y)*.8+.2*(v-y)+y;else if("area"===M)v=Math.sqrt(s[p].value/h)*(v-y)+y;if(b){var C;C=x,x=u,u=C}if(this._buildItem(d,e,p,_,s[p].selected,f,y,v,x,u,g),!b)x=u}else;this._autoLabelLayout(d,f,v);for(var p=0,c=d.length;c>p;p++)this.shapeList.push(d[p]);d=null}},_buildItem:function(e,t,i,a,s,r,o,l,h,d,p){var c=this.series,u=((d+h)/2+360)%360,g=this.getSector(t,i,a,s,r,o,l,h,d,p);n.pack(g,c[t],t,c[t].data[i],i,c[t].data[i].name,a),e.push(g);var f=this.getLabel(t,i,a,r,u,p,!1),m=this.getLabelLine(t,i,r,o,l,u,p,!1);if(m)n.pack(m,c[t],t,c[t].data[i],i,c[t].data[i].name,a),e.push(m);if(f)n.pack(f,c[t],t,c[t].data[i],i,c[t].data[i].name,a),f._labelLine=m,e.push(f)},getSector:function(e,t,i,a,s,o,l,n,h,c){var u=this.series,g=u[e],f=g.data[t],m=[f,g],y=this.deepMerge(m,"itemStyle.normal")||{},v=this.deepMerge(m,"itemStyle.emphasis")||{},_=this.getItemStyleColor(y.color,e,t,f)||c,b=this.getItemStyleColor(v.color,e,t,f)||("string"==typeof _?p.lift(_,-.2):_),x={zlevel:this.getZlevelBase(),z:this.getZBase(),clickable:this.deepQuery(m,"clickable"),style:{x:s[0],y:s[1],r0:o,r:l,startAngle:n,endAngle:h,brushType:"both",color:_,lineWidth:y.borderWidth,strokeColor:y.borderColor,lineJoin:"round"},highlightStyle:{color:b,lineWidth:v.borderWidth,strokeColor:v.borderColor,lineJoin:"round"},_seriesIndex:e,_dataIndex:t};if(a){var S=((x.style.startAngle+x.style.endAngle)/2).toFixed(2)-0;x.style._hasSelected=!0,x.style._x=x.style.x,x.style._y=x.style.y;var L=this.query(g,"selectedOffset");x.style.x+=d.cos(S,!0)*L,x.style.y-=d.sin(S,!0)*L,this._selected[e][t]=!0}else this._selected[e][t]=!1;if(this._selectedMode)x.onclick=this.shapeHandler.onclick;if(this.deepQuery([f,g,this.option],"calculable"))this.setCalculable(x),x.draggable=!0;if(this._needLabel(g,f,!0)||this._needLabelLine(g,f,!0))x.onmouseover=this.shapeHandler.onmouseover;return x=new r(x)},getLabel:function(e,t,a,s,r,o,l){var n=this.series,p=n[e],c=p.data[t];if(this._needLabel(p,c,l)){var u,g,f,m=l?"emphasis":"normal",y=h.merge(h.clone(c.itemStyle)||{},p.itemStyle),v=y[m].label,_=v.textStyle||{},b=s[0],x=s[1],S=this.parseRadius(this.zr,p.radius),L="middle";if(v.position=v.position||y.normal.label.position,"center"===v.position)u=b,g=x,f="center";else if("inner"===v.position||"inside"===v.position)S=(S[0]+S[1])*(v.distance||.5),u=Math.round(b+S*d.cos(r,!0)),g=Math.round(x-S*d.sin(r,!0)),o="#fff",f="center";else S=S[1]- -y[m].labelLine.length,u=Math.round(b+S*d.cos(r,!0)),g=Math.round(x-S*d.sin(r,!0)),f=r>=90&&270>=r?"right":"left";if("center"!=v.position&&"inner"!=v.position&&"inside"!=v.position)u+="left"===f?20:-20;c.__labelX=u-("left"===f?5:-5),c.__labelY=g;var M=new i({zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{x:u,y:g,color:_.color||o,text:this.getLabelText(e,t,a,m),textAlign:_.align||f,textBaseline:_.baseline||L,textFont:this.getFont(_)},highlightStyle:{brushType:"fill"}});return M._radius=S,M._labelPosition=v.position||"outer",M._rect=M.getRect(M.style),M._seriesIndex=e,M._dataIndex=t,M}},getLabelText:function(e,t,i,a){var s=this.series,r=s[e],o=r.data[t],l=this.deepQuery([o,r],"itemStyle."+a+".label.formatter");if(l){if("function"==typeof l)return l.call(this.myChart,{seriesIndex:e,seriesName:r.name||"",series:r,dataIndex:t,data:o,name:o.name,value:o.value,percent:i});else if("string"==typeof l)return l=l.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{d}","{d0}"),l=l.replace("{a0}",r.name).replace("{b0}",o.name).replace("{c0}",o.value).replace("{d0}",i)}else return o.name},getLabelLine:function(e,t,i,a,s,r,l,n){var p=this.series,c=p[e],u=c.data[t];if(this._needLabelLine(c,u,n)){var g=n?"emphasis":"normal",f=h.merge(h.clone(u.itemStyle)||{},c.itemStyle),m=f[g].labelLine,y=m.lineStyle||{},v=i[0],_=i[1],b=s,x=this.parseRadius(this.zr,c.radius)[1]- -m.length,S=d.cos(r,!0),L=d.sin(r,!0);return new o({zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{pointList:[[v+b*S,_-b*L],[v+x*S,_-x*L],[u.__labelX,u.__labelY]],strokeColor:y.color||l,lineType:y.type,lineWidth:y.width},_seriesIndex:e,_dataIndex:t})}else;},_needLabel:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},_autoLabelLayout:function(e,t,i){for(var a=[],s=[],r=0,o=e.length;o>r;r++)if("outer"===e[r]._labelPosition||"outside"===e[r]._labelPosition)if(e[r]._rect._y=e[r]._rect.y,e[r]._rect.x<t[0])a.push(e[r]);else s.push(e[r]);this._layoutCalculate(a,t,i,-1),this._layoutCalculate(s,t,i,1)},_layoutCalculate:function(e,t,i,a){function s(t,i,a){for(var s=t;i>s;s++){if(e[s]._rect.y+=a,e[s].style.y+=a,e[s]._labelLine)e[s]._labelLine.style.pointList[1][1]+=a,e[s]._labelLine.style.pointList[2][1]+=a;if(s>t&&i>s+1&&e[s+1]._rect.y>e[s]._rect.y+e[s]._rect.height)return void r(s,a/2)}r(i-1,a/2)}function r(t,i){for(var a=t;a>=0;a--){if(e[a]._rect.y-=i,e[a].style.y-=i,e[a]._labelLine)e[a]._labelLine.style.pointList[1][1]-=i,e[a]._labelLine.style.pointList[2][1]-=i;if(a>0&&e[a]._rect.y>e[a-1]._rect.y+e[a-1]._rect.height)break}}function o(e,t,i,a,s){for(var r,o,l,n=i[0],h=i[1],d=s>0?t?Number.MAX_VALUE:0:t?Number.MAX_VALUE:0,p=0,c=e.length;c>p;p++){if(o=Math.abs(e[p]._rect.y-h),l=e[p]._radius-a,r=a+l>o?Math.sqrt((a+l+20)*(a+l+20)-Math.pow(e[p]._rect.y-h,2)):Math.abs(e[p]._rect.x+(s>0?0:e[p]._rect.width)-n),t&&r>=d)r=d-10;if(!t&&d>=r)r=d+10;if(e[p]._rect.x=e[p].style.x=n+r*s,e[p]._labelLine)e[p]._labelLine.style.pointList[2][0]=n+(r-5)*s,e[p]._labelLine.style.pointList[1][0]=n+(r-20)*s;d=r}}e.sort(function(e,t){return e._rect.y-t._rect.y});for(var l,n=0,h=e.length,d=[],p=[],c=0;h>c;c++){if(l=e[c]._rect.y-n,0>l)s(c,h,-l,a);n=e[c]._rect.y+e[c]._rect.height}if(this.zr.getHeight()-n<0)r(h-1,n-this.zr.getHeight());for(var c=0;h>c;c++)if(e[c]._rect.y>=t[1])p.push(e[c]);else d.push(e[c]);o(p,!0,t,i,a),o(d,!1,t,i,a)},reformOption:function(e){var t=h.merge;return e=t(t(e||{},h.clone(this.ecTheme.pie||{})),h.clone(l.pie)),e.itemStyle.normal.label.textStyle=this.getTextStyle(e.itemStyle.normal.label.textStyle),e.itemStyle.emphasis.label.textStyle=this.getTextStyle(e.itemStyle.emphasis.label.textStyle),e},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},addDataAnimation:function(e,t){function i(){if(n--,0===n)t&&t()}for(var a=this.series,s={},r=0,o=e.length;o>r;r++)s[e[r][0]]=e[r];var n=0,h={},d={},p={},c=this.shapeList;this.shapeList=[];for(var u,g,f,m={},r=0,o=e.length;o>r;r++)if(u=e[r][0],g=e[r][2],f=e[r][3],a[u]&&a[u].type===l.CHART_TYPE_PIE){if(g){if(!f)h[u+"_"+a[u].data.length]="delete";m[u]=1}else if(!f)h[u+"_-1"]="delete",m[u]=-1;else m[u]=0;this._buildSinglePie(u)}for(var y,v,r=0,o=this.shapeList.length;o>r;r++)switch(u=this.shapeList[r]._seriesIndex,y=this.shapeList[r]._dataIndex,v=u+"_"+y,this.shapeList[r].type){case"sector":h[v]=this.shapeList[r];break;case"text":d[v]=this.shapeList[r];break;case"polyline":p[v]=this.shapeList[r]}this.shapeList=[];for(var _,r=0,o=c.length;o>r;r++)if(u=c[r]._seriesIndex,s[u]){if(y=c[r]._dataIndex+m[u],v=u+"_"+y,_=h[v],!_)continue;if("sector"===c[r].type)if("delete"!=_)n++,this.zr.animate(c[r].id,"style").when(400,{startAngle:_.style.startAngle,endAngle:_.style.endAngle}).done(i).start();else n++,this.zr.animate(c[r].id,"style").when(400,m[u]<0?{startAngle:c[r].style.startAngle}:{endAngle:c[r].style.endAngle}).done(i).start();else if("text"===c[r].type||"polyline"===c[r].type)if("delete"===_)this.zr.delShape(c[r].id);else switch(c[r].type){case"text":n++,_=d[v],this.zr.animate(c[r].id,"style").when(400,{x:_.style.x,y:_.style.y}).done(i).start();break;case"polyline":n++,_=p[v],this.zr.animate(c[r].id,"style").when(400,{pointList:_.style.pointList}).done(i).start()}}if(this.shapeList=c,!n)i()},onclick:function(e){var t=this.series;if(this.isClick&&e.target){this.isClick=!1;for(var i,a=e.target,s=a.style,r=n.get(a,"seriesIndex"),o=n.get(a,"dataIndex"),h=0,p=this.shapeList.length;p>h;h++)if(this.shapeList[h].id===a.id){if(r=n.get(a,"seriesIndex"),o=n.get(a,"dataIndex"),!s._hasSelected){var c=((s.startAngle+s.endAngle)/2).toFixed(2)-0;a.style._hasSelected=!0,this._selected[r][o]=!0,a.style._x=a.style.x,a.style._y=a.style.y,i=this.query(t[r],"selectedOffset"),a.style.x+=d.cos(c,!0)*i,a.style.y-=d.sin(c,!0)*i}else a.style.x=a.style._x,a.style.y=a.style._y,a.style._hasSelected=!1,this._selected[r][o]=!1;this.zr.modShape(a.id,a)}else if(this.shapeList[h].style._hasSelected&&"single"===this._selectedMode)r=n.get(this.shapeList[h],"seriesIndex"),o=n.get(this.shapeList[h],"dataIndex"),this.shapeList[h].style.x=this.shapeList[h].style._x,this.shapeList[h].style.y=this.shapeList[h].style._y,this.shapeList[h].style._hasSelected=!1,this._selected[r][o]=!1,this.zr.modShape(this.shapeList[h].id,this.shapeList[h]);this.messageCenter.dispatch(l.EVENT.PIE_SELECTED,e.event,{selected:this._selected,target:n.get(a,"name")},this.myChart),this.zr.refreshNextFrame()}}},h.inherits(e,t),require("../chart").define("pie",e),e});