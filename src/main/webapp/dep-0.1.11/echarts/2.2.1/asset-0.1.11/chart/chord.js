define("echarts/chart/chord",["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Sector","../util/shape/Ribbon","../util/shape/Icon","zrender/shape/BezierCurve","../config","../util/ecData","zrender/tool/util","zrender/tool/vector","../data/Graph","../layout/Chord","../chart"],function(require){"use strict";function e(e,i,a,r,o){t.call(this,e,i,a,r,o),this.scaleLineLength=4,this.scaleUnitAngle=4,this.refresh(r)}var t=require("./base"),i=require("zrender/shape/Text"),a=require("zrender/shape/Line"),r=require("zrender/shape/Sector"),o=require("../util/shape/Ribbon"),s=require("../util/shape/Icon"),n=require("zrender/shape/BezierCurve"),l=require("../config");l.chord={zlevel:0,z:2,clickable:!0,radius:["65%","75%"],center:["50%","50%"],padding:2,sort:"none",sortSub:"none",startAngle:90,clockWise:!0,ribbonType:!0,minRadius:10,maxRadius:20,symbol:"circle",showScale:!1,showScaleText:!1,itemStyle:{normal:{borderWidth:0,borderColor:"#000",label:{show:!0,rotate:!1,distance:5},chordStyle:{width:1,color:"black",borderWidth:1,borderColor:"#999",opacity:.5}},emphasis:{borderWidth:0,borderColor:"#000",chordStyle:{width:1,color:"black",borderWidth:1,borderColor:"#999"}}}};var h=require("../util/ecData"),d=require("zrender/tool/util"),p=require("zrender/tool/vector"),c=require("../data/Graph"),g=require("../layout/Chord");return e.prototype={type:l.CHART_TYPE_CHORD,_init:function(){var e=this.series;this.selectedMap={};for(var t={},i={},a=0,r=e.length;r>a;a++)if(e[a].type===this.type){var o=this.isSelected(e[a].name);if(this.selectedMap[e[a].name]=o,o)this.buildMark(a);this.reformOption(e[a]),t[e[a].name]=e[a]}for(var a=0,r=e.length;r>a;a++)if(e[a].type===this.type)if(e[a].insertToSerie){var s=t[e[a].insertToSerie];e[a]._referenceSerie=s}else i[e[a].name]=[e[a]];for(var a=0,r=e.length;r>a;a++)if(e[a].type===this.type)if(e[a].insertToSerie){for(var n=e[a]._referenceSerie;n&&n._referenceSerie;)n=n._referenceSerie;if(i[n.name]&&this.selectedMap[e[a].name])i[n.name].push(e[a])}for(var l in i)this._buildChords(i[l]);this.addShapeList()},_getNodeCategory:function(e,t){return e.categories&&e.categories[t.category||0]},_getNodeQueryTarget:function(e,t){var i=this._getNodeCategory(e,t);return[t,i,e]},_getEdgeQueryTarget:function(e,t,i){return i=i||"normal",[t.itemStyle&&t.itemStyle[i],e.itemStyle[i].chordStyle]},_buildChords:function(e){for(var t=[],i=e[0],a=function(e){return e.layout.size>0},r=function(e){return function(t){return e.getEdge(t.node2,t.node1)}},o=0;o<e.length;o++){var s=e[o];if(this.selectedMap[s.name]){var n;if(s.data&&s.matrix)n=this._getSerieGraphFromDataMatrix(s,i);else if(s.nodes&&s.links)n=this._getSerieGraphFromNodeLinks(s,i);if(n.filterNode(a,this),s.ribbonType)n.filterEdge(r(n));t.push(n),n.__serie=s}}if(t.length){var l=t[0];if(!i.ribbonType){var h=i.minRadius,d=i.maxRadius,p=1/0,c=-1/0;l.eachNode(function(e){c=Math.max(e.layout.size,c),p=Math.min(e.layout.size,p)});var u=(d-h)/(c-p);l.eachNode(function(e){var t=this._getNodeQueryTarget(i,e),a=this.query(t,"symbolSize");if(c===p)e.layout.size=a||p;else e.layout.size=a||(e.layout.size-p)*u+h},this)}var f=new g;if(f.clockWise=i.clockWise,f.startAngle=i.startAngle*Math.PI/180,!f.clockWise)f.startAngle=-f.startAngle;f.padding=i.padding*Math.PI/180,f.sort=i.sort,f.sortSub=i.sortSub,f.directed=i.ribbonType,f.run(t);var y=this.query(i,"itemStyle.normal.label.show");if(i.ribbonType){if(this._buildSectors(i,0,l,i,t),y)this._buildLabels(i,0,l,i,t);for(var o=0,m=0;o<e.length;o++)if(this.selectedMap[e[o].name])this._buildRibbons(e,o,t[m++],i);if(i.showScale)this._buildScales(i,0,l)}else{if(this._buildNodeIcons(i,0,l,i,t),y)this._buildLabels(i,0,l,i,t);for(var o=0,m=0;o<e.length;o++)if(this.selectedMap[e[o].name])this._buildEdgeCurves(e,o,t[m++],i,l)}this._initHoverHandler(e,t)}},_getSerieGraphFromDataMatrix:function(e,t){for(var i=[],a=0,r=[],o=0;o<e.matrix.length;o++)r[o]=e.matrix[o].slice();for(var s=e.data||e.nodes,o=0;o<s.length;o++){var n={},l=s[o];l.rawIndex=o;for(var h in l)if("name"===h)n.id=l.name;else n[h]=l[h];var d=this._getNodeCategory(t,l),p=d?d.name:l.name;if(this.selectedMap[p]=this.isSelected(p),this.selectedMap[p])i.push(n),a++;else{r.splice(a,1);for(var g=0;g<r.length;g++)r[g].splice(a,1)}}var u=c.fromMatrix(i,r,!0);return u.eachNode(function(e){e.layout={size:e.data.outValue},e.rawIndex=e.data.rawIndex}),u.eachEdge(function(e){e.layout={weight:e.data.weight}}),u},_getSerieGraphFromNodeLinks:function(e,t){for(var i=new c(!0),a=e.data||e.nodes,r=0,o=a.length;o>r;r++){var s=a[r];if(s&&!s.ignore){var n=this._getNodeCategory(t,s),l=n?n.name:s.name;if(this.selectedMap[l]=this.isSelected(l),this.selectedMap[l]){var h=i.addNode(s.name,s);h.rawIndex=r}}else;}for(var r=0,o=e.links.length;o>r;r++){var d=e.links[r],p=d.source,g=d.target;if("number"==typeof p)if(p=a[p])p=p.name;if("number"==typeof g)if(g=a[g])g=g.name;var u=i.addEdge(p,g,d);if(u)u.rawIndex=r}return i.eachNode(function(e){var i=e.data.value;if(null==i)if(i=0,t.ribbonType)for(var a=0;a<e.outEdges.length;a++)i+=e.outEdges[a].data.weight||0;else for(var a=0;a<e.edges.length;a++)i+=e.edges[a].data.weight||0;e.layout={size:i}}),i.eachEdge(function(e){e.layout={weight:null==e.data.weight?1:e.data.weight}}),i},_initHoverHandler:function(e,t){var i=e[0],a=t[0],r=this;a.eachNode(function(e){e.shape.onmouseover=function(){a.eachNode(function(e){if(e.shape.style.opacity=.1,e.labelShape)e.labelShape.style.opacity=.1,e.labelShape.modSelf();e.shape.modSelf()});for(var i=0;i<t.length;i++)for(var o=0;o<t[i].edges.length;o++){var s=t[i].edges[o],n=r._getEdgeQueryTarget(t[i].__serie,s.data);s.shape.style.opacity=.1*r.deepQuery(n,"opacity"),s.shape.modSelf()}if(e.shape.style.opacity=1,e.labelShape)e.labelShape.style.opacity=1;for(var i=0;i<t.length;i++){var l=t[i].getNodeById(e.id);if(l)for(var o=0;o<l.outEdges.length;o++){var s=l.outEdges[o],n=r._getEdgeQueryTarget(t[i].__serie,s.data);s.shape.style.opacity=r.deepQuery(n,"opacity");var h=t[0].getNodeById(s.node2.id);if(h){if(h.shape)h.shape.style.opacity=1;if(h.labelShape)h.labelShape.style.opacity=1}}}r.zr.refreshNextFrame()},e.shape.onmouseout=function(){a.eachNode(function(e){if(e.shape.style.opacity=1,e.labelShape)e.labelShape.style.opacity=1,e.labelShape.modSelf();e.shape.modSelf()});for(var e=0;e<t.length;e++)for(var o=0;o<t[e].edges.length;o++){var s=t[e].edges[o],n=[s.data,i];s.shape.style.opacity=r.deepQuery(n,"itemStyle.normal.chordStyle.opacity"),s.shape.modSelf()}r.zr.refreshNextFrame()}})},_buildSectors:function(e,t,i,a){var o=this.parseCenter(this.zr,a.center),s=this.parseRadius(this.zr,a.radius),n=a.clockWise,l=n?1:-1;i.eachNode(function(i){var d=this._getNodeCategory(a,i.data),p=d?this.getColor(d.name):this.getColor(i.id),c=i.layout.startAngle/Math.PI*180*l,g=i.layout.endAngle/Math.PI*180*l,u=new r({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{x:o[0],y:o[1],r0:s[0],r:s[1],startAngle:c,endAngle:g,brushType:"fill",opacity:1,color:p,clockWise:n},clickable:a.clickable,highlightStyle:{brushType:"fill"}});if(u.style.lineWidth=this.deepQuery([i.data,a],"itemStyle.normal.borderWidth"),u.highlightStyle.lineWidth=this.deepQuery([i.data,a],"itemStyle.emphasis.borderWidth"),u.style.strokeColor=this.deepQuery([i.data,a],"itemStyle.normal.borderColor"),u.highlightStyle.strokeColor=this.deepQuery([i.data,a],"itemStyle.emphasis.borderColor"),u.style.lineWidth>0)u.style.brushType="both";if(u.highlightStyle.lineWidth>0)u.highlightStyle.brushType="both";h.pack(u,e,t,i.data,i.rawIndex,i.id,i.category),this.shapeList.push(u),i.shape=u},this)},_buildNodeIcons:function(e,t,i,a){var r=this.parseCenter(this.zr,a.center),o=this.parseRadius(this.zr,a.radius),n=o[1];i.eachNode(function(i){var o=i.layout.startAngle,l=i.layout.endAngle,d=(o+l)/2,p=n*Math.cos(d),c=n*Math.sin(d),g=this._getNodeQueryTarget(a,i.data),u=this._getNodeCategory(a,i.data),f=this.deepQuery(g,"itemStyle.normal.color");if(!f)f=u?this.getColor(u.name):this.getColor(i.id);var y=new s({zlevel:this.getZlevelBase(),z:this.getZBase()+1,style:{x:-i.layout.size,y:-i.layout.size,width:2*i.layout.size,height:2*i.layout.size,iconType:this.deepQuery(g,"symbol"),color:f,brushType:"both",lineWidth:this.deepQuery(g,"itemStyle.normal.borderWidth"),strokeColor:this.deepQuery(g,"itemStyle.normal.borderColor")},highlightStyle:{color:this.deepQuery(g,"itemStyle.emphasis.color"),lineWidth:this.deepQuery(g,"itemStyle.emphasis.borderWidth"),strokeColor:this.deepQuery(g,"itemStyle.emphasis.borderColor")},clickable:a.clickable,position:[p+r[0],c+r[1]]});h.pack(y,e,t,i.data,i.rawIndex,i.id,i.category),this.shapeList.push(y),i.shape=y},this)},_buildLabels:function(e,t,a,r){var o=this.query(r,"itemStyle.normal.label.color"),s=this.query(r,"itemStyle.normal.label.rotate"),n=this.query(r,"itemStyle.normal.label.distance"),l=this.parseCenter(this.zr,r.center),h=this.parseRadius(this.zr,r.radius),d=r.clockWise,c=d?1:-1;a.eachNode(function(e){var t=e.layout.startAngle/Math.PI*180*c,a=e.layout.endAngle/Math.PI*180*c,d=(t*-c+a*-c)/2;if(d%=360,0>d)d+=360;var g=90>=d||d>=270;d=d*Math.PI/180;var u=[Math.cos(d),-Math.sin(d)],f=0;if(r.ribbonType)f=r.showScaleText?35+n:n;else f=n+e.layout.size;var y=p.scale([],u,h[1]+f);p.add(y,y,l);var m={zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{text:null==e.data.label?e.id:e.data.label,textAlign:g?"left":"right",color:o||"#000000"}};if(s){if(m.rotation=g?d:Math.PI+d,g)m.style.x=h[1]+f;else m.style.x=-h[1]-f;m.style.y=0,m.position=l.slice()}else m.style.x=y[0],m.style.y=y[1];m.style.textColor=this.deepQuery([e.data,r],"itemStyle.normal.label.textStyle.color")||"#fff",m.style.textFont=this.getFont(this.deepQuery([e.data,r],"itemStyle.normal.label.textStyle")),m=new i(m),this.shapeList.push(m),e.labelShape=m},this)},_buildRibbons:function(e,t,i,a){var r=e[t],s=this.parseCenter(this.zr,a.center),n=this.parseRadius(this.zr,a.radius);i.eachEdge(function(l,d){var p,c=i.getEdge(l.node2,l.node1);if(c&&!l.shape){if(c.shape)return void(l.shape=c.shape);var g=l.layout.startAngle/Math.PI*180,u=l.layout.endAngle/Math.PI*180,f=c.layout.startAngle/Math.PI*180,y=c.layout.endAngle/Math.PI*180;if(1===e.length)if(l.layout.weight<=c.layout.weight)p=this.getColor(l.node1.id);else p=this.getColor(l.node2.id);else p=this.getColor(r.name);var m,b,v=this._getEdgeQueryTarget(r,l.data),x=this._getEdgeQueryTarget(r,l.data,"emphasis"),_=new o({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{x:s[0],y:s[1],r:n[0],source0:g,source1:u,target0:f,target1:y,brushType:"both",opacity:this.deepQuery(v,"opacity"),color:p,lineWidth:this.deepQuery(v,"borderWidth"),strokeColor:this.deepQuery(v,"borderColor"),clockWise:a.clockWise},clickable:a.clickable,highlightStyle:{brushType:"both",opacity:this.deepQuery(x,"opacity"),lineWidth:this.deepQuery(x,"borderWidth"),strokeColor:this.deepQuery(x,"borderColor")}});if(l.layout.weight<=c.layout.weight)m=c.node1,b=c.node2;else m=l.node1,b=l.node2;h.pack(_,r,t,l.data,null==l.rawIndex?d:l.rawIndex,l.data.name||m.id+"-"+b.id,m.id,b.id),this.shapeList.push(_),l.shape=_}},this)},_buildEdgeCurves:function(e,t,i,a,r){var o=e[t],s=this.parseCenter(this.zr,a.center);i.eachEdge(function(e,i){var a=r.getNodeById(e.node1.id),l=r.getNodeById(e.node2.id),d=a.shape,p=l.shape,c=this._getEdgeQueryTarget(o,e.data),g=this._getEdgeQueryTarget(o,e.data,"emphasis"),u=new n({zlevel:this.getZlevelBase(),z:this.getZBase(),style:{xStart:d.position[0],yStart:d.position[1],xEnd:p.position[0],yEnd:p.position[1],cpX1:s[0],cpY1:s[1],lineWidth:this.deepQuery(c,"width"),strokeColor:this.deepQuery(c,"color"),opacity:this.deepQuery(c,"opacity")},highlightStyle:{lineWidth:this.deepQuery(g,"width"),strokeColor:this.deepQuery(g,"color"),opacity:this.deepQuery(g,"opacity")}});h.pack(u,o,t,e.data,null==e.rawIndex?i:e.rawIndex,e.data.name||e.node1.id+"-"+e.node2.id,e.node1.id,e.node2.id),this.shapeList.push(u),e.shape=u},this)},_buildScales:function(e,t,r){var o,s,n=e.clockWise,l=this.parseCenter(this.zr,e.center),h=this.parseRadius(this.zr,e.radius),d=n?1:-1,c=0,g=-1/0;if(e.showScaleText)if(r.eachNode(function(e){var t=e.data.value;if(t>g)g=t;c+=t}),g>1e10)o="b",s=1e-9;else if(g>1e7)o="m",s=1e-6;else if(g>1e4)o="k",s=.001;else o="",s=1;var u=c/(360-e.padding);r.eachNode(function(t){for(var r=t.layout.startAngle/Math.PI*180,c=t.layout.endAngle/Math.PI*180,g=r;;){if(n&&g>c||!n&&c>g)break;var f=g/180*Math.PI,y=[Math.cos(f),Math.sin(f)],m=p.scale([],y,h[1]+1);p.add(m,m,l);var b=p.scale([],y,h[1]+this.scaleLineLength);p.add(b,b,l);var v=new a({zlevel:this.getZlevelBase(),z:this.getZBase()-1,hoverable:!1,style:{xStart:m[0],yStart:m[1],xEnd:b[0],yEnd:b[1],lineCap:"round",brushType:"stroke",strokeColor:"#666",lineWidth:1}});this.shapeList.push(v),g+=d*this.scaleUnitAngle}if(e.showScaleText)for(var x=r,_=5*u*this.scaleUnitAngle,S=0;;){if(n&&x>c||!n&&c>x)break;var f=x;if(f%=360,0>f)f+=360;var C=90>=f||f>=270,k=new i({zlevel:this.getZlevelBase(),z:this.getZBase()-1,hoverable:!1,style:{x:C?h[1]+this.scaleLineLength+4:-h[1]-this.scaleLineLength-4,y:0,text:Math.round(10*S)/10+o,textAlign:C?"left":"right"},position:l.slice(),rotation:C?[-f/180*Math.PI,0,0]:[-(f+180)/180*Math.PI,0,0]});this.shapeList.push(k),S+=_*s,x+=d*this.scaleUnitAngle*5}},this)},refresh:function(e){if(e)this.option=e,this.series=e.series;if(this.legend=this.component.legend,this.legend)this.getColor=function(e){return this.legend.getColor(e)},this.isSelected=function(e){return this.legend.isSelected(e)};else{var t={},i=0;this.getColor=function(e){if(t[e])return t[e];if(!t[e])t[e]=this.zr.getColor(i++);return t[e]},this.isSelected=function(){return!0}}this.backupShapeList(),this._init()},reformOption:function(e){var t=d.merge;e=t(t(e||{},this.ecTheme.chord),l.chord),e.itemStyle.normal.label.textStyle=this.getTextStyle(e.itemStyle.normal.label.textStyle)}},d.inherits(e,t),require("../chart").define("chord",e),e});