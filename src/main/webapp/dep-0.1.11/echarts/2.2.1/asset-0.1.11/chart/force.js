define("echarts/chart/force",["require","./base","../data/Graph","../layout/Force","zrender/shape/Line","zrender/shape/BezierCurve","zrender/shape/Image","../util/shape/Icon","../config","../util/ecData","zrender/tool/util","zrender/config","zrender/tool/vector","../chart"],function(require){"use strict";function e(e,r,n,h,d){var p=this;o.call(this,e,r,n,h,d),this.__nodePositionMap={},this._graph=new s(!0),this._layout=new l,this._layout.onupdate=function(){p._step()},this._steps=1,this.ondragstart=function(){t.apply(p,arguments)},this.ondragend=function(){a.apply(p,arguments)},this.ondrop=function(){},this.shapeHandler.ondragstart=function(){p.isDragstart=!0},this.onmousemove=function(){i.apply(p,arguments)},this.refresh(h)}function t(e){if(this.isDragstart&&e.target){var t=e.target;t.fixed=!0,this.isDragstart=!1,this.zr.on(y.EVENT.MOUSEMOVE,this.onmousemove)}}function i(){this._layout.temperature=.8,this._step()}function a(e,t){if(this.isDragend&&e.target){var i=e.target;i.fixed=!1,t.dragIn=!0,t.needRefresh=!1,this.isDragend=!1,this.zr.un(y.EVENT.MOUSEMOVE,this.onmousemove)}}function r(e,t,i){var a=f.create();return a[0]=(Math.random()-.5)*i+e,a[1]=(Math.random()-.5)*i+t,a}var o=require("./base"),s=require("../data/Graph"),l=require("../layout/Force"),n=require("zrender/shape/Line"),h=require("zrender/shape/BezierCurve"),d=require("zrender/shape/Image"),p=require("../util/shape/Icon"),c=require("../config");c.force={zlevel:1,z:2,center:["50%","50%"],size:"100%",preventOverlap:!1,coolDown:.99,minRadius:10,maxRadius:20,ratioScaling:!1,large:!1,useWorker:!1,steps:1,scaling:1,gravity:1,symbol:"circle",symbolSize:0,linkSymbol:null,linkSymbolSize:[10,15],draggable:!0,clickable:!0,roam:!1,itemStyle:{normal:{label:{show:!1,position:"inside"},nodeStyle:{brushType:"both",borderColor:"#5182ab",borderWidth:1},linkStyle:{color:"#5182ab",width:1,type:"line"}},emphasis:{label:{show:!1},nodeStyle:{},linkStyle:{opacity:0}}}};var g=require("../util/ecData"),u=require("zrender/tool/util"),y=require("zrender/config"),f=require("zrender/tool/vector");return e.prototype={constructor:e,type:c.CHART_TYPE_FORCE,_init:function(){var e,t=this.component.legend,i=this.series;this.clear();for(var a=0,r=i.length;r>a;a++){var o=i[a];if(o.type===c.CHART_TYPE_FORCE){if(i[a]=this.reformOption(i[a]),e=i[a].name||"",this.selectedMap[e]=t?t.isSelected(e):!0,!this.selectedMap[e])continue;this.buildMark(a),this._initSerie(o,a);break}}this.animationEffect()},_getNodeCategory:function(e,t){return e.categories&&e.categories[t.category||0]},_getNodeQueryTarget:function(e,t,i){i=i||"normal";var a=this._getNodeCategory(e,t)||{};return[t.itemStyle&&t.itemStyle[i],a&&a.itemStyle&&a.itemStyle[i],e.itemStyle[i].nodeStyle]},_getEdgeQueryTarget:function(e,t,i){return i=i||"normal",[t.itemStyle&&t.itemStyle[i],e.itemStyle[i].linkStyle]},_initSerie:function(e,t){if(this._temperature=1,e.data)this._graph=this._getSerieGraphFromDataMatrix(e);else this._graph=this._getSerieGraphFromNodeLinks(e);this._buildLinkShapes(e,t),this._buildNodeShapes(e,t);var i=e.roam===!0||"move"===e.roam,a=e.roam===!0||"scale"===e.roam;if(this.zr.modLayer(this.getZlevelBase(),{panable:i,zoomable:a}),this.query("markPoint.effect.show")||this.query("markLine.effect.show"))this.zr.modLayer(c.EFFECT_ZLEVEL,{panable:i,zoomable:a});this._initLayout(e),this._step()},_getSerieGraphFromDataMatrix:function(e){for(var t=[],i=0,a=[],r=0;r<e.matrix.length;r++)a[r]=e.matrix[r].slice();for(var o=e.data||e.nodes,r=0;r<o.length;r++){var l={},n=o[r];for(var h in n)if("name"===h)l.id=n.name;else l[h]=n[h];var d=this._getNodeCategory(e,n),p=d?d.name:n.name;if(this.selectedMap[p]=this.isSelected(p),this.selectedMap[p])t.push(l),i++;else{a.splice(i,1);for(var c=0;c<a.length;c++)a[c].splice(i,1)}}var g=s.fromMatrix(t,a,!0);return g.eachNode(function(e,t){e.layout={size:e.data.value,mass:0},e.rawIndex=t}),g.eachEdge(function(e){e.layout={weight:e.data.weight}}),g},_getSerieGraphFromNodeLinks:function(e){for(var t=new s(!0),i=e.data||e.nodes,a=0,r=i.length;r>a;a++){var o=i[a];if(o&&!o.ignore){var l=this._getNodeCategory(e,o),n=l?l.name:o.name;if(this.selectedMap[n]=this.isSelected(n),this.selectedMap[n]){var h=t.addNode(o.name,o);h.rawIndex=a}}else;}for(var a=0,r=e.links.length;r>a;a++){var d=e.links[a],p=d.source,c=d.target;if("number"==typeof p)if(p=i[p])p=p.name;if("number"==typeof c)if(c=i[c])c=c.name;var g=t.addEdge(p,c,d);if(g)g.rawIndex=a}return t.eachNode(function(e){var t=e.data.value;if(null==t){t=0;for(var i=0;i<e.edges.length;i++)t+=e.edges[i].data.weight||0}e.layout={size:t,mass:0}}),t.eachEdge(function(e){e.layout={weight:null==e.data.weight?1:e.data.weight}}),t},_initLayout:function(e){var t=this._graph,i=t.nodes.length,a=this.query(e,"minRadius"),o=this.query(e,"maxRadius");this._steps=e.steps||1,this._layout.center=this.parseCenter(this.zr,e.center),this._layout.width=this.parsePercent(e.size,this.zr.getWidth()),this._layout.height=this.parsePercent(e.size,this.zr.getHeight()),this._layout.large=e.large,this._layout.scaling=e.scaling,this._layout.ratioScaling=e.ratioScaling,this._layout.gravity=e.gravity,this._layout.temperature=1,this._layout.coolDown=e.coolDown,this._layout.preventNodeEdgeOverlap=e.preventOverlap,this._layout.preventNodeOverlap=e.preventOverlap;for(var s=1/0,l=-1/0,n=0;i>n;n++){var h=t.nodes[n];l=Math.max(h.layout.size,l),s=Math.min(h.layout.size,s)}for(var d=l-s,n=0;i>n;n++){var h=t.nodes[n];if(d>0)h.layout.size=(h.layout.size-s)*(o-a)/d+a,h.layout.mass=h.layout.size/o;else h.layout.size=(o-a)/2,h.layout.mass=.5}for(var n=0;i>n;n++){var h=t.nodes[n];if("undefined"!=typeof this.__nodePositionMap[h.id])h.layout.position=f.create(),f.copy(h.layout.position,this.__nodePositionMap[h.id]);else if("undefined"!=typeof h.data.initial)h.layout.position=f.create(),f.copy(h.layout.position,h.data.initial);else{var p=this._layout.center,c=Math.min(this._layout.width,this._layout.height);h.layout.position=r(p[0],p[1],.8*c)}var g=h.shape.style,u=h.layout.size;g.width=g.width||2*u,g.height=g.height||2*u,g.x=-g.width/2,g.y=-g.height/2,f.copy(h.shape.position,h.layout.position)}i=t.edges.length,l=-1/0;for(var n=0;i>n;n++){var y=t.edges[n];if(y.layout.weight>l)l=y.layout.weight}for(var n=0;i>n;n++){var y=t.edges[n];y.layout.weight/=l}this._layout.init(t,e.useWorker)},_buildNodeShapes:function(e,t){var i=this._graph,a=this.query(e,"categories");i.eachNode(function(i){var r=this._getNodeCategory(e,i.data),o=[i.data,r,e],s=this._getNodeQueryTarget(e,i.data),l=this._getNodeQueryTarget(e,i.data,"emphasis"),n=new p({style:{x:0,y:0,color:this.deepQuery(s,"color"),brushType:"both",strokeColor:this.deepQuery(s,"strokeColor")||this.deepQuery(s,"borderColor"),lineWidth:this.deepQuery(s,"lineWidth")||this.deepQuery(s,"borderWidth")},highlightStyle:{color:this.deepQuery(l,"color"),strokeColor:this.deepQuery(l,"strokeColor")||this.deepQuery(l,"borderColor"),lineWidth:this.deepQuery(l,"lineWidth")||this.deepQuery(l,"borderWidth")},clickable:e.clickable,zlevel:this.getZlevelBase(),z:this.getZBase()});if(!n.style.color)n.style.color=r?this.getColor(r.name):this.getColor(i.id);if(n.style.iconType=this.deepQuery(o,"symbol"),n.style.width=n.style.height=2*(this.deepQuery(o,"symbolSize")||0),n.style.iconType.match("image"))n.style.image=n.style.iconType.replace(new RegExp("^image:\\/\\/"),""),n=new d({style:n.style,highlightStyle:n.highlightStyle,clickable:n.clickable,zlevel:this.getZlevelBase(),z:this.getZBase()});if(this.deepQuery(o,"itemStyle.normal.label.show"))n.style.text=null==i.data.label?i.id:i.data.label,n.style.textPosition=this.deepQuery(o,"itemStyle.normal.label.position"),n.style.textColor=this.deepQuery(o,"itemStyle.normal.label.textStyle.color"),n.style.textFont=this.getFont(this.deepQuery(o,"itemStyle.normal.label.textStyle")||{});if(this.deepQuery(o,"itemStyle.emphasis.label.show"))n.highlightStyle.textPosition=this.deepQuery(o,"itemStyle.emphasis.label.position"),n.highlightStyle.textColor=this.deepQuery(o,"itemStyle.emphasis.label.textStyle.color"),n.highlightStyle.textFont=this.getFont(this.deepQuery(o,"itemStyle.emphasis.label.textStyle")||{});if(this.deepQuery(o,"draggable"))this.setCalculable(n),n.dragEnableTime=0,n.draggable=!0,n.ondragstart=this.shapeHandler.ondragstart,n.ondragover=null;var h="";if("undefined"!=typeof i.category){var r=a[i.category];h=r&&r.name||""}g.pack(n,e,t,i.data,i.rawIndex,i.data.name||"",i.category),this.shapeList.push(n),this.zr.addShape(n),i.shape=n},this)},_buildLinkShapes:function(e,t){for(var i=this._graph,a=i.edges.length,r=0;a>r;r++){var o=i.edges[r],s=o.data,l=o.node1,d=o.node2,c=i.getEdge(d,l),y=this._getEdgeQueryTarget(e,s),f=this.deepQuery(y,"type");if(e.linkSymbol&&"none"!==e.linkSymbol)f="line";var m="line"===f?n:h,v=new m({style:{xStart:0,yStart:0,xEnd:0,yEnd:0},clickable:this.query(e,"clickable"),highlightStyle:{},zlevel:this.getZlevelBase(),z:this.getZBase()});if(c&&c.shape)v.style.offset=4,c.shape.style.offset=4;if(u.merge(v.style,this.query(e,"itemStyle.normal.linkStyle"),!0),u.merge(v.highlightStyle,this.query(e,"itemStyle.emphasis.linkStyle"),!0),"undefined"!=typeof s.itemStyle){if(s.itemStyle.normal)u.merge(v.style,s.itemStyle.normal,!0);if(s.itemStyle.emphasis)u.merge(v.highlightStyle,s.itemStyle.emphasis,!0)}if(v.style.lineWidth=v.style.lineWidth||v.style.width,v.style.strokeColor=v.style.strokeColor||v.style.color,v.highlightStyle.lineWidth=v.highlightStyle.lineWidth||v.highlightStyle.width,v.highlightStyle.strokeColor=v.highlightStyle.strokeColor||v.highlightStyle.color,g.pack(v,e,t,o.data,null==o.rawIndex?r:o.rawIndex,o.data.name||l.id+" - "+d.id,l.id,d.id),this.shapeList.push(v),this.zr.addShape(v),o.shape=v,e.linkSymbol&&"none"!==e.linkSymbol){var b=new p({style:{x:-5,y:0,width:e.linkSymbolSize[0],height:e.linkSymbolSize[1],iconType:e.linkSymbol,brushType:"fill",color:v.style.strokeColor},highlightStyle:{brushType:"fill"},position:[0,0],rotation:0});v._symbolShape=b,this.shapeList.push(b),this.zr.addShape(b)}}},_updateLinkShapes:function(){for(var e=f.create(),t=f.create(),i=f.create(),a=f.create(),r=this._graph.edges,o=0,s=r.length;s>o;o++){var l=r[o],n=l.node1.shape,h=l.node2.shape;f.copy(i,n.position),f.copy(a,h.position);var d=l.shape.style;if(f.sub(e,i,a),f.normalize(e,e),d.offset)t[0]=e[1],t[1]=-e[0],f.scaleAndAdd(i,i,t,d.offset),f.scaleAndAdd(a,a,t,d.offset);else if("bezier-curve"===l.shape.type)d.cpX1=(i[0]+a[0])/2-(a[1]-i[1])/4,d.cpY1=(i[1]+a[1])/2-(i[0]-a[0])/4;if(d.xStart=i[0],d.yStart=i[1],d.xEnd=a[0],d.yEnd=a[1],l.shape.modSelf(),l.shape._symbolShape){var p=l.shape._symbolShape;f.copy(p.position,a),f.scaleAndAdd(p.position,p.position,e,h.style.width/2+2);var c=Math.atan2(e[1],e[0]);p.rotation=Math.PI/2-c,p.modSelf()}}},_syncNodePositions:function(){for(var e=this._graph,t=0;t<e.nodes.length;t++){var i=e.nodes[t],a=i.layout.position,r=i.data,o=i.shape,s=o.fixed||r.fixX,l=o.fixed||r.fixY;if(s===!0)s=1;else if(isNaN(s))s=0;if(l===!0)l=1;else if(isNaN(l))l=0;o.position[0]+=(a[0]-o.position[0])*(1-s),o.position[1]+=(a[1]-o.position[1])*(1-l),f.copy(a,o.position);var n=r.name;if(n){var h=this.__nodePositionMap[n];if(!h)h=this.__nodePositionMap[n]=f.create();f.copy(h,a)}o.modSelf()}},_step:function(){if(this._syncNodePositions(),this._updateLinkShapes(),this.zr.refreshNextFrame(),this._layout.temperature>.01)this._layout.step(this._steps);else this.messageCenter.dispatch(c.EVENT.FORCE_LAYOUT_END,{},{},this.myChart)},refresh:function(e){if(e)this.option=e,this.series=this.option.series;if(this.legend=this.component.legend,this.legend)this.getColor=function(e){return this.legend.getColor(e)},this.isSelected=function(e){return this.legend.isSelected(e)};else{var t={},i=0;this.getColor=function(e){if(t[e])return t[e];if(!t[e])t[e]=this.zr.getColor(i++);return t[e]},this.isSelected=function(){return!0}}this._init()},dispose:function(){this.clear(),this.shapeList=null,this.effectList=null,this._layout.dispose(),this._layout=null,this.__nodePositionMap={}},getPosition:function(){var e=[];return this._graph.eachNode(function(t){if(t.layout)e.push({name:t.data.name,position:Array.prototype.slice.call(t.layout.position)})}),e}},u.inherits(e,o),require("../chart").define("force",e),e});