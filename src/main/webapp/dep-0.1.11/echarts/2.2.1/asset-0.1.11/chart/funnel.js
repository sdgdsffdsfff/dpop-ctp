define("echarts/chart/funnel",["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(require){function e(e,i,a,r,o){t.call(this,e,i,a,r,o),this.refresh(r)}var t=require("./base"),i=require("zrender/shape/Text"),a=require("zrender/shape/Line"),r=require("zrender/shape/Polygon"),o=require("../config");o.funnel={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,x:80,y:60,x2:80,y2:60,min:0,max:100,minSize:"0%",maxSize:"100%",sort:"descending",gap:0,funnelAlign:"center",itemStyle:{normal:{borderColor:"#fff",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:10,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0},labelLine:{show:!0}}}};var s=require("../util/ecData"),n=require("../util/number"),l=require("zrender/tool/util"),h=require("zrender/tool/color"),d=require("zrender/tool/area");return e.prototype={type:o.CHART_TYPE_FUNNEL,_buildShape:function(){var e=this.series,t=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var i,a=0,r=e.length;r>a;a++)if(e[a].type===o.CHART_TYPE_FUNNEL){if(e[a]=this.reformOption(e[a]),this.legendHoverLink=e[a].legendHoverLink||this.legendHoverLink,i=e[a].name||"",this.selectedMap[i]=t?t.isSelected(i):!0,!this.selectedMap[i])continue;this._buildSingleFunnel(a),this.buildMark(a)}this.addShapeList()},_buildSingleFunnel:function(e){var t=this.component.legend,i=this.series[e],a=this._mapData(e),r=this._getLocation(e);this._paramsMap[e]={location:r,data:a};for(var o,s=0,l=[],h=0,d=a.length;d>h;h++)if(o=a[h].name,this.selectedMap[o]=t?t.isSelected(o):!0,this.selectedMap[o]&&!isNaN(a[h].value))l.push(a[h]),s++;if(0!==s){for(var p,c,u,g,y=this._buildFunnelCase(e),f=i.funnelAlign,m=i.gap,b=s>1?(r.height-(s-1)*m)/s:r.height,v=r.y,x="descending"===i.sort?this._getItemWidth(e,l[0].value):n.parsePercent(i.minSize,r.width),_="descending"===i.sort?1:0,S=r.centerX,C=[],h=0,d=l.length;d>h;h++)if(o=l[h].name,this.selectedMap[o]&&!isNaN(l[h].value)){switch(p=d-2>=h?this._getItemWidth(e,l[h+_].value):"descending"===i.sort?n.parsePercent(i.minSize,r.width):n.parsePercent(i.maxSize,r.width),f){case"left":c=r.x;break;case"right":c=r.x+r.width-x;break;default:c=S-x/2}if(u=this._buildItem(e,l[h]._index,t?t.getColor(o):this.zr.getColor(l[h]._index),c,v,x,p,b,f),v+=b+m,g=u.style.pointList,C.unshift([g[0][0]-10,g[0][1]]),C.push([g[1][0]+10,g[1][1]]),0===h)if(0===x){if(g=C.pop(),"center"==f&&(C[0][0]+=10),"right"==f&&(C[0][0]=g[0]),C[0][1]-="center"==f?10:15,1==d)g=u.style.pointList}else C[C.length-1][1]-=5,C[0][1]-=5;x=p}if(y){if(C.unshift([g[3][0]-10,g[3][1]]),C.push([g[2][0]+10,g[2][1]]),0===x)g=C.pop(),"center"==f&&(C[0][0]+=10),"right"==f&&(C[0][0]=g[0]),C[0][1]+="center"==f?10:15;else C[C.length-1][1]+=5,C[0][1]+=5;y.style.pointList=C}}},_buildFunnelCase:function(e){var t=this.series[e];if(this.deepQuery([t,this.option],"calculable")){var i=this._paramsMap[e].location,a=10,n={hoverable:!1,style:{pointListd:[[i.x-a,i.y-a],[i.x+i.width+a,i.y-a],[i.x+i.width+a,i.y+i.height+a],[i.x-a,i.y+i.height+a]],brushType:"stroke",lineWidth:1,strokeColor:t.calculableHolderColor||this.ecTheme.calculableHolderColor||o.calculableHolderColor}};return s.pack(n,t,e,void 0,-1),this.setCalculable(n),n=new r(n),this.shapeList.push(n),n}},_getLocation:function(e){var t=this.series[e],i=this.zr.getWidth(),a=this.zr.getHeight(),r=this.parsePercent(t.x,i),o=this.parsePercent(t.y,a),s=null==t.width?i-r-this.parsePercent(t.x2,i):this.parsePercent(t.width,i);return{x:r,y:o,width:s,height:null==t.height?a-o-this.parsePercent(t.y2,a):this.parsePercent(t.height,a),centerX:r+s/2}},_mapData:function(e){function t(e,t){if("-"===e.value)return 1;else if("-"===t.value)return-1;return t.value-e.value}function i(e,i){return-t(e,i)}for(var a=this.series[e],r=l.clone(a.data),o=0,s=r.length;s>o;o++)r[o]._index=o;if("none"!=a.sort)r.sort("descending"===a.sort?t:i);return r},_buildItem:function(e,t,i,a,r,o,n,l,h){var d=this.series,p=d[e],c=p.data[t],u=this.getPolygon(e,t,i,a,r,o,n,l,h);s.pack(u,d[e],e,d[e].data[t],t,d[e].data[t].name),this.shapeList.push(u);var g=this.getLabel(e,t,i,a,r,o,n,l,h);if(s.pack(g,d[e],e,d[e].data[t],t,d[e].data[t].name),this.shapeList.push(g),!this._needLabel(p,c,!1))g.invisible=!0;var y=this.getLabelLine(e,t,i,a,r,o,n,l,h);if(this.shapeList.push(y),!this._needLabelLine(p,c,!1))y.invisible=!0;var f=[],m=[];if(this._needLabelLine(p,c,!0))f.push(y.id),m.push(y.id);if(this._needLabel(p,c,!0))f.push(g.id),m.push(u.id);return u.hoverConnect=f,g.hoverConnect=m,u},_getItemWidth:function(e,t){var i=this.series[e],a=this._paramsMap[e].location,r=i.min,o=i.max,s=n.parsePercent(i.minSize,a.width),l=n.parsePercent(i.maxSize,a.width);return(t-r)*(l-s)/(o-r)+s},getPolygon:function(e,t,i,a,o,s,n,l,d){var p,c=this.series[e],u=c.data[t],g=[u,c],y=this.deepMerge(g,"itemStyle.normal")||{},f=this.deepMerge(g,"itemStyle.emphasis")||{},m=this.getItemStyleColor(y.color,e,t,u)||i,b=this.getItemStyleColor(f.color,e,t,u)||("string"==typeof m?h.lift(m,-.2):m);switch(d){case"left":p=a;break;case"right":p=a+(s-n);break;default:p=a+(s-n)/2}var v={zlevel:this.getZlevelBase(),z:this.getZBase(),clickable:this.deepQuery(g,"clickable"),style:{pointList:[[a,o],[a+s,o],[p+n,o+l],[p,o+l]],brushType:"both",color:m,lineWidth:y.borderWidth,strokeColor:y.borderColor},highlightStyle:{color:b,lineWidth:f.borderWidth,strokeColor:f.borderColor}};if(this.deepQuery([u,c,this.option],"calculable"))this.setCalculable(v),v.draggable=!0;return new r(v)},getLabel:function(e,t,a,r,o,s,n,p,c){var u,g=this.series[e],y=g.data[t],f=this._paramsMap[e].location,m=l.merge(l.clone(y.itemStyle)||{},g.itemStyle),b="normal",v=m[b].label,x=v.textStyle||{},_=m[b].labelLine.length,S=this.getLabelText(e,t,b),C=this.getFont(x),z=a;if(v.position=v.position||m.normal.label.position,"inner"===v.position||"inside"===v.position||"center"===v.position)u=c,z=Math.max(s,n)/2>d.getTextWidth(S,C)?"#fff":h.reverse(a);else if("left"===v.position)u="right";else u="left";var k={zlevel:this.getZlevelBase(),z:this.getZBase()+1,style:{x:this._getLabelPoint(v.position,r,f,s,n,_,c),y:o+p/2,color:x.color||z,text:S,textAlign:x.align||u,textBaseline:x.baseline||"middle",textFont:C}};if(b="emphasis",v=m[b].label||v,x=v.textStyle||x,_=m[b].labelLine.length||_,v.position=v.position||m.normal.label.position,S=this.getLabelText(e,t,b),C=this.getFont(x),z=a,"inner"===v.position||"inside"===v.position||"center"===v.position)u=c,z=Math.max(s,n)/2>d.getTextWidth(S,C)?"#fff":h.reverse(a);else if("left"===v.position)u="right";else u="left";return k.highlightStyle={x:this._getLabelPoint(v.position,r,f,s,n,_,c),color:x.color||z,text:S,textAlign:x.align||u,textFont:C,brushType:"fill"},new i(k)},getLabelText:function(e,t,i){var a=this.series,r=a[e],o=r.data[t],s=this.deepQuery([o,r],"itemStyle."+i+".label.formatter");if(s){if("function"==typeof s)return s.call(this.myChart,{seriesIndex:e,seriesName:r.name||"",series:r,dataIndex:t,data:o,name:o.name,value:o.value});else if("string"==typeof s)return s=s.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{a0}",r.name).replace("{b0}",o.name).replace("{c0}",o.value)}else return o.name},getLabelLine:function(e,t,i,r,o,s,n,h,d){var p=this.series[e],c=p.data[t],u=this._paramsMap[e].location,g=l.merge(l.clone(c.itemStyle)||{},p.itemStyle),y="normal",f=g[y].labelLine,m=g[y].labelLine.length,b=f.lineStyle||{},v=g[y].label;v.position=v.position||g.normal.label.position;var x={zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(r,u,s,n,d),yStart:o+h/2,xEnd:this._getLabelPoint(v.position,r,u,s,n,m,d),yEnd:o+h/2,strokeColor:b.color||i,lineType:b.type,lineWidth:b.width}};return y="emphasis",f=g[y].labelLine||f,m=g[y].labelLine.length||m,b=f.lineStyle||b,v=g[y].label||v,v.position=v.position,x.highlightStyle={xEnd:this._getLabelPoint(v.position,r,u,s,n,m,d),strokeColor:b.color||i,lineType:b.type,lineWidth:b.width},new a(x)},_getLabelPoint:function(e,t,i,a,r,o,s){switch(e="inner"===e||"inside"===e?"center":e){case"center":return"center"==s?t+a/2:"left"==s?t+10:t+a-10;case"left":if("auto"===o)return i.x-10;else return"center"==s?i.centerX-Math.max(a,r)/2-o:"right"==s?t-(r>a?r-a:0)-o:i.x-o;default:if("auto"===o)return i.x+i.width+10;else return"center"==s?i.centerX+Math.max(a,r)/2+o:"right"==s?i.x+i.width+o:t+Math.max(a,r)+o}},_getLabelLineStartPoint:function(e,t,i,a,r){return"center"==r?t.centerX:a>i?e+Math.min(i,a)/2:e+Math.max(i,a)/2},_needLabel:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()}},l.inherits(e,t),require("../chart").define("funnel",e),e});