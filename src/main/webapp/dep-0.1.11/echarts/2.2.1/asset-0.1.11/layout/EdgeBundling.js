define("echarts/layout/EdgeBundling",["require","../data/KDTree","zrender/tool/vector"],function(require){function t(t,e){t=t.array,e=e.array;var i=e[0]-t[0],s=e[1]-t[1],a=e[2]-t[2],o=e[3]-t[3];return i*i+s*s+a*a+o*o}function e(t){this.points=[t.mp0,t.mp1],this.group=t}function i(t){var i=t.points;if(i[0][1]<i[1][1]||t instanceof e)this.array=[i[0][0],i[0][1],i[1][0],i[1][1]],this._startPoint=i[0],this._endPoint=i[1];else this.array=[i[1][0],i[1][1],i[0][0],i[0][1]],this._startPoint=i[1],this._endPoint=i[0];this.ink=l(i[0],i[1]),this.edge=t,this.group=null}function s(){this.edgeList=[],this.mp0=r(),this.mp1=r(),this.ink=0}function a(){this.maxNearestEdge=6,this.maxTurningAngle=Math.PI/4,this.maxIteration=20}var o=require("../data/KDTree"),n=require("zrender/tool/vector"),r=n.create,h=n.distSquare,l=n.dist,d=n.copy,p=n.clone;return i.prototype.getStartPoint=function(){return this._startPoint},i.prototype.getEndPoint=function(){return this._endPoint},s.prototype.addEdge=function(t){t.group=this,this.edgeList.push(t)},s.prototype.removeEdge=function(t){t.group=null,this.edgeList.splice(this.edgeList.indexOf(t),1)},a.prototype={constructor:a,run:function(t){function i(t,e){return h(t,e)<1e-10}function s(t,e){for(var s=[],a=0,o=0;o<t.length;o++)if(!(a>0&&i(t[o],s[a-1])))s[a++]=p(t[o]);if(e[0]&&!i(s[0],e[0]))s=s.reverse();return s}for(var a=this._iterate(t),o=0;o++<this.maxIteration;){for(var n=[],r=0;r<a.groups.length;r++)n.push(new e(a.groups[r]));var l=this._iterate(n);if(l.savedInk<=0)break;else a=l}var d=[],c=function(t,i){for(var a,o=0;o<t.length;o++){var n=t[o];if(n.edgeList[0]&&n.edgeList[0].edge instanceof e){for(var r=[],h=0;h<n.edgeList.length;h++)r.push(n.edgeList[h].edge.group);if(!i)a=[];else a=i.slice();a.unshift(n.mp0),a.push(n.mp1),c(r,a)}else for(var h=0;h<n.edgeList.length;h++){var l=n.edgeList[h];if(!i)a=[];else a=i.slice();a.unshift(n.mp0),a.push(n.mp1),a.unshift(l.getStartPoint()),a.push(l.getEndPoint()),d.push({points:s(a,l.edge.points),rawEdge:l.edge})}}};return c(a.groups),d},_iterate:function(e){for(var a=[],n=[],h=0,l=0;l<e.length;l++){var p=new i(e[l]);a.push(p)}for(var c=new o(a,4),g=[],u=r(),f=r(),_=0,m=r(),y=r(),x=0,l=0;l<a.length;l++){var p=a[l];if(!p.group){c.nearestN(p,this.maxNearestEdge,t,g);for(var v=0,b=null,S=null,z=0;z<g.length;z++){var T=g[z],C=0;if(T.group){if(T.group!==S)S=T.group,_=this._calculateGroupEdgeInk(T.group,p,u,f),C=T.group.ink+p.ink-_}else _=this._calculateEdgeEdgeInk(p,T,u,f),C=T.ink+p.ink-_;if(C>v)v=C,b=T,d(y,f),d(m,u),x=_}if(b){h+=v;var L;if(!b.group)L=new s,n.push(L),L.addEdge(b);L=b.group,d(L.mp0,m),d(L.mp1,y),L.ink=x,b.group.addEdge(p)}else{var L=new s;n.push(L),d(L.mp0,p.getStartPoint()),d(L.mp1,p.getEndPoint()),L.ink=p.ink,L.addEdge(p)}}else;}return{groups:n,edges:a,savedInk:h}},_calculateEdgeEdgeInk:function(){var t=[],e=[];return function(i,s,a,o){t[0]=i.getStartPoint(),t[1]=s.getStartPoint(),e[0]=i.getEndPoint(),e[1]=s.getEndPoint(),this._calculateMeetPoints(t,e,a,o);var n=l(t[0],a)+l(a,o)+l(o,e[0])+l(t[1],a)+l(o,e[1]);return n}}(),_calculateGroupEdgeInk:function(t,e,i,s){for(var a=[],o=[],n=0;n<t.edgeList.length;n++){var r=t.edgeList[n];a.push(r.getStartPoint()),o.push(r.getEndPoint())}a.push(e.getStartPoint()),o.push(e.getEndPoint()),this._calculateMeetPoints(a,o,i,s);for(var h=l(i,s),n=0;n<a.length;n++)h+=l(a[n],i)+l(o[n],s);return h},_calculateMeetPoints:function(){var t=r(),e=r();return function(i,s,a,o){n.set(t,0,0),n.set(e,0,0);for(var r=i.length,h=0;r>h;h++)n.add(t,t,i[h]);n.scale(t,t,1/r),r=s.length;for(var h=0;r>h;h++)n.add(e,e,s[h]);n.scale(e,e,1/r),this._limitTurningAngle(i,t,e,a),this._limitTurningAngle(s,e,t,o)}}(),_limitTurningAngle:function(){var t=r(),e=r(),i=r(),s=r();return function(a,o,r,d){var p=Math.cos(this.maxTurningAngle),c=Math.tan(this.maxTurningAngle);n.sub(t,o,r),n.normalize(t,t),n.copy(d,o);for(var g=0,u=0;u<a.length;u++){var f=a[u];n.sub(e,f,o);var _=n.len(e);n.scale(e,e,1/_);var m=n.dot(e,t);if(p>m){n.scaleAndAdd(i,o,t,_*m);var y=l(i,f),x=y/c;n.scaleAndAdd(s,i,t,-x);var v=h(s,o);if(v>g)g=v,n.copy(d,s)}}}}()},a});