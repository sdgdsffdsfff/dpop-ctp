define(["require"],function(require){function Lookup(e){for(var t=0,n=e.length;n>t;t++)this[e[t]]=t}function onReadyStateChange(){if("complete"===document.readyState){document.detachEvent(ON_READY_STATE_CHANGE,onReadyStateChange);for(var e=document.getElementsByTagName(CANVAS),t=0,n=e.length;n>t;++t)FlashCanvas.initElement(e[t])}}function onFocus(){var e=event.srcElement,t=e.parentNode;e.blur(),t.focus()}function onPropertyChange(){var e=event.propertyName;if("width"===e||"height"===e){var t=event.srcElement,n=t[e],i=parseInt(n,10);if(isNaN(i)||0>i)i="width"===e?300:150;if(n===i)t.style[e]=i+"px",t.getContext("2d")._resize(t.width,t.height);else t[e]=i}}function onUnload(){window.detachEvent(ON_UNLOAD,onUnload);for(var e in canvases){var t,n=canvases[e],i=n.firstChild;for(t in i)if("function"==typeof i[t])i[t]=NULL;for(t in n)if("function"==typeof n[t])n[t]=NULL;i.detachEvent(ON_FOCUS,onFocus),n.detachEvent(ON_PROPERTY_CHANGE,onPropertyChange)}window[CANVAS_RENDERING_CONTEXT_2D]=NULL,window[CANVAS_GRADIENT]=NULL,window[CANVAS_PATTERN]=NULL,window[FLASH_CANVAS]=NULL,window[G_VML_CANVAS_MANAGER]=NULL}function getScriptUrl(){var e=document.getElementsByTagName("script"),t=e[e.length-1];if(document.documentMode>=8)return t.src;else return t.getAttribute("src",4)}function getUniqueId(){return Math.random().toString(36).slice(2)||"0"}function encodeXML(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;")}function toLowerCase(e){return e.toLowerCase()}function throwException(e){throw new DOMException(e)}function setCanvasSize(e){var t=parseInt(e.width,10),n=parseInt(e.height,10);if(isNaN(t)||0>t)t=300;if(isNaN(n)||0>n)n=150;e.width=t,e.height=n}if(window.ActiveXObject&&!window.CanvasRenderingContext2D){var NULL=null,CANVAS="canvas",CANVAS_RENDERING_CONTEXT_2D="CanvasRenderingContext2D",CANVAS_GRADIENT="CanvasGradient",CANVAS_PATTERN="CanvasPattern",FLASH_CANVAS="FlashCanvas",G_VML_CANVAS_MANAGER="G_vmlCanvasManager",OBJECT_ID_PREFIX="external",ON_FOCUS="onfocus",ON_PROPERTY_CHANGE="onpropertychange",ON_READY_STATE_CHANGE="onreadystatechange",ON_UNLOAD="onunload",config=window[FLASH_CANVAS+"Options"]||{},BASE_URL=config.swfPath||getScriptUrl().replace(/[^\/]+$/,""),SWF_URL=BASE_URL+"flashcanvas.swf",INDEX_SIZE_ERR=1,NOT_SUPPORTED_ERR=9,INVALID_STATE_ERR=11,SYNTAX_ERR=12,TYPE_MISMATCH_ERR=17,SECURITY_ERR=18,properties=new Lookup(["toDataURL","save","restore","scale","rotate","translate","transform","setTransform","globalAlpha","globalCompositeOperation","strokeStyle","fillStyle","createLinearGradient","createRadialGradient","createPattern","lineWidth","lineCap","lineJoin","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","clearRect","fillRect","strokeRect","beginPath","closePath","moveTo","lineTo","quadraticCurveTo","bezierCurveTo","arcTo","rect","arc","fill","stroke","clip","isPointInPath","font","textAlign","textBaseline","fillText","strokeText","measureText","drawImage","createImageData","getImageData","putImageData","addColorStop","direction","resize"]),isReady={},images={},lock={},callbacks={},canvases={},spans={},CanvasRenderingContext2D=function(e,t){this.canvas=e,this._swf=t,this._canvasId=t.id.slice(8),this._initialize(),this._gradientPatternId=0,this._direction="",this._font="";var n=this;setInterval(function(){if(0===lock[n._canvasId])n._executeCommand()},30)};CanvasRenderingContext2D.prototype={save:function(){this._setCompositing(),this._setShadows(),this._setStrokeStyle(),this._setFillStyle(),this._setLineStyles(),this._setFontStyles(),this._stateStack.push([this._globalAlpha,this._globalCompositeOperation,this._strokeStyle,this._fillStyle,this._lineWidth,this._lineCap,this._lineJoin,this._miterLimit,this._shadowOffsetX,this._shadowOffsetY,this._shadowBlur,this._shadowColor,this._font,this._textAlign,this._textBaseline]),this._queue.push(properties.save)},restore:function(){var e=this._stateStack;if(e.length){var t=e.pop();this.globalAlpha=t[0],this.globalCompositeOperation=t[1],this.strokeStyle=t[2],this.fillStyle=t[3],this.lineWidth=t[4],this.lineCap=t[5],this.lineJoin=t[6],this.miterLimit=t[7],this.shadowOffsetX=t[8],this.shadowOffsetY=t[9],this.shadowBlur=t[10],this.shadowColor=t[11],this.font=t[12],this.textAlign=t[13],this.textBaseline=t[14]}this._queue.push(properties.restore)},scale:function(e,t){this._queue.push(properties.scale,e,t)},rotate:function(e){this._queue.push(properties.rotate,e)},translate:function(e,t){this._queue.push(properties.translate,e,t)},transform:function(e,t,n,i,a,r){this._queue.push(properties.transform,e,t,n,i,a,r)},setTransform:function(e,t,n,i,a,r){this._queue.push(properties.setTransform,e,t,n,i,a,r)},_setCompositing:function(){var e=this._queue;if(this._globalAlpha!==this.globalAlpha)this._globalAlpha=this.globalAlpha,e.push(properties.globalAlpha,this._globalAlpha);if(this._globalCompositeOperation!==this.globalCompositeOperation)this._globalCompositeOperation=this.globalCompositeOperation,e.push(properties.globalCompositeOperation,this._globalCompositeOperation)},_setStrokeStyle:function(){if(this._strokeStyle!==this.strokeStyle){var e=this._strokeStyle=this.strokeStyle;if("string"==typeof e);else if(e instanceof CanvasGradient||e instanceof CanvasPattern)e=e.id;else return;this._queue.push(properties.strokeStyle,e)}},_setFillStyle:function(){if(this._fillStyle!==this.fillStyle){var e=this._fillStyle=this.fillStyle;if("string"==typeof e);else if(e instanceof CanvasGradient||e instanceof CanvasPattern)e=e.id;else return;this._queue.push(properties.fillStyle,e)}},createLinearGradient:function(e,t,n,i){if(!(isFinite(e)&&isFinite(t)&&isFinite(n)&&isFinite(i)))throwException(NOT_SUPPORTED_ERR);return this._queue.push(properties.createLinearGradient,e,t,n,i),new CanvasGradient(this)},createRadialGradient:function(e,t,n,i,a,r){if(!(isFinite(e)&&isFinite(t)&&isFinite(n)&&isFinite(i)&&isFinite(a)&&isFinite(r)))throwException(NOT_SUPPORTED_ERR);if(0>n||0>r)throwException(INDEX_SIZE_ERR);return this._queue.push(properties.createRadialGradient,e,t,n,i,a,r),new CanvasGradient(this)},createPattern:function(e,t){if(!e)throwException(TYPE_MISMATCH_ERR);var n,i=e.tagName,a=this._canvasId;if(i)if(i=i.toLowerCase(),"img"===i)n=e.getAttribute("src",2);else if(i===CANVAS||"video"===i)return;else throwException(TYPE_MISMATCH_ERR);else if(e.src)n=e.src;else throwException(TYPE_MISMATCH_ERR);if("repeat"!==t&&"no-repeat"!==t&&"repeat-x"!==t&&"repeat-y"!==t&&""!==t&&t!==NULL)throwException(SYNTAX_ERR);if(this._queue.push(properties.createPattern,encodeXML(n),t),!images[a][n]&&isReady[a])this._executeCommand(),++lock[a],images[a][n]=!0;return new CanvasPattern(this)},_setLineStyles:function(){var e=this._queue;if(this._lineWidth!==this.lineWidth)this._lineWidth=this.lineWidth,e.push(properties.lineWidth,this._lineWidth);if(this._lineCap!==this.lineCap)this._lineCap=this.lineCap,e.push(properties.lineCap,this._lineCap);if(this._lineJoin!==this.lineJoin)this._lineJoin=this.lineJoin,e.push(properties.lineJoin,this._lineJoin);if(this._miterLimit!==this.miterLimit)this._miterLimit=this.miterLimit,e.push(properties.miterLimit,this._miterLimit)},_setShadows:function(){var e=this._queue;if(this._shadowOffsetX!==this.shadowOffsetX)this._shadowOffsetX=this.shadowOffsetX,e.push(properties.shadowOffsetX,this._shadowOffsetX);if(this._shadowOffsetY!==this.shadowOffsetY)this._shadowOffsetY=this.shadowOffsetY,e.push(properties.shadowOffsetY,this._shadowOffsetY);if(this._shadowBlur!==this.shadowBlur)this._shadowBlur=this.shadowBlur,e.push(properties.shadowBlur,this._shadowBlur);if(this._shadowColor!==this.shadowColor)this._shadowColor=this.shadowColor,e.push(properties.shadowColor,this._shadowColor)},clearRect:function(e,t,n,i){this._queue.push(properties.clearRect,e,t,n,i)},fillRect:function(e,t,n,i){this._setCompositing(),this._setShadows(),this._setFillStyle(),this._queue.push(properties.fillRect,e,t,n,i)},strokeRect:function(e,t,n,i){this._setCompositing(),this._setShadows(),this._setStrokeStyle(),this._setLineStyles(),this._queue.push(properties.strokeRect,e,t,n,i)},beginPath:function(){this._queue.push(properties.beginPath)},closePath:function(){this._queue.push(properties.closePath)},moveTo:function(e,t){this._queue.push(properties.moveTo,e,t)},lineTo:function(e,t){this._queue.push(properties.lineTo,e,t)},quadraticCurveTo:function(e,t,n,i){this._queue.push(properties.quadraticCurveTo,e,t,n,i)},bezierCurveTo:function(e,t,n,i,a,r){this._queue.push(properties.bezierCurveTo,e,t,n,i,a,r)},arcTo:function(e,t,n,i,a){if(0>a&&isFinite(a))throwException(INDEX_SIZE_ERR);this._queue.push(properties.arcTo,e,t,n,i,a)},rect:function(e,t,n,i){this._queue.push(properties.rect,e,t,n,i)},arc:function(e,t,n,i,a,r){if(0>n&&isFinite(n))throwException(INDEX_SIZE_ERR);this._queue.push(properties.arc,e,t,n,i,a,r?1:0)},fill:function(){this._setCompositing(),this._setShadows(),this._setFillStyle(),this._queue.push(properties.fill)},stroke:function(){this._setCompositing(),this._setShadows(),this._setStrokeStyle(),this._setLineStyles(),this._queue.push(properties.stroke)},clip:function(){this._queue.push(properties.clip)},isPointInPath:function(){},_setFontStyles:function(){var e=this._queue;if(this._font!==this.font)try{var t=spans[this._canvasId];t.style.font=this._font=this.font;var n=t.currentStyle,i=t.offsetHeight,a=[n.fontStyle,n.fontWeight,i,n.fontFamily].join(" ");e.push(properties.font,a)}catch(r){}if(this._textAlign!==this.textAlign)this._textAlign=this.textAlign,e.push(properties.textAlign,this._textAlign);if(this._textBaseline!==this.textBaseline)this._textBaseline=this.textBaseline,e.push(properties.textBaseline,this._textBaseline);if(this._direction!==this.canvas.currentStyle.direction)this._direction=this.canvas.currentStyle.direction,e.push(properties.direction,this._direction)},fillText:function(e,t,n,i){this._setCompositing(),this._setFillStyle(),this._setShadows(),this._setFontStyles(),this._queue.push(properties.fillText,encodeXML(e),t,n,void 0===i?1/0:i)},strokeText:function(e,t,n,i){this._setCompositing(),this._setStrokeStyle(),this._setShadows(),this._setFontStyles(),this._queue.push(properties.strokeText,encodeXML(e),t,n,void 0===i?1/0:i)},measureText:function(e){var t=spans[this._canvasId];try{t.style.font=this.font}catch(n){}return t.innerText=(""+e).replace(/[ \n\f\r]/g,"	"),new TextMetrics(t.offsetWidth)},drawImage:function(e,t,n,i,a,r,o,s,l){if(!e)throwException(TYPE_MISMATCH_ERR);var h,d=e.tagName,u=arguments.length,c=this._canvasId;if(d)if(d=d.toLowerCase(),"img"===d)h=e.getAttribute("src",2);else if(d===CANVAS||"video"===d)return;else throwException(TYPE_MISMATCH_ERR);else if(e.src)h=e.src;else throwException(TYPE_MISMATCH_ERR);if(this._setCompositing(),this._setShadows(),h=encodeXML(h),3===u)this._queue.push(properties.drawImage,u,h,t,n);else if(5===u)this._queue.push(properties.drawImage,u,h,t,n,i,a);else if(9===u){if(0===i||0===a)throwException(INDEX_SIZE_ERR);this._queue.push(properties.drawImage,u,h,t,n,i,a,r,o,s,l)}else return;if(!images[c][h]&&isReady[c])this._executeCommand(),++lock[c],images[c][h]=!0},createImageData:function(){},getImageData:function(){},putImageData:function(){},loadImage:function(e,t,n){var i,a=e.tagName,r=this._canvasId;if(a){if("img"===a.toLowerCase())i=e.getAttribute("src",2)}else if(e.src)i=e.src;if(i&&!images[r][i]){if(t||n)callbacks[r][i]=[e,t,n];if(this._queue.push(properties.drawImage,1,encodeXML(i)),isReady[r])this._executeCommand(),++lock[r],images[r][i]=!0}},_initialize:function(){this.globalAlpha=this._globalAlpha=1,this.globalCompositeOperation=this._globalCompositeOperation="source-over",this.strokeStyle=this._strokeStyle="#000000",this.fillStyle=this._fillStyle="#000000",this.lineWidth=this._lineWidth=1,this.lineCap=this._lineCap="butt",this.lineJoin=this._lineJoin="miter",this.miterLimit=this._miterLimit=10,this.shadowOffsetX=this._shadowOffsetX=0,this.shadowOffsetY=this._shadowOffsetY=0,this.shadowBlur=this._shadowBlur=0,this.shadowColor=this._shadowColor="rgba(0, 0, 0, 0.0)",this.font=this._font="10px sans-serif",this.textAlign=this._textAlign="start",this.textBaseline=this._textBaseline="alphabetic",this._queue=[],this._stateStack=[]},_flush:function(){var e=this._queue;return this._queue=[],e},_executeCommand:function(){var commands=this._flush();if(commands.length>0)return eval(this._swf.CallFunction('<invoke name="executeCommand" returntype="javascript"><arguments><string>'+commands.join("&#0;")+"</string></arguments></invoke>"));else return void 0},_resize:function(e,t){if(this._executeCommand(),this._initialize(),e>0)this._swf.width=e;if(t>0)this._swf.height=t;this._queue.push(properties.resize,e,t)}};var CanvasGradient=function(e){this._ctx=e,this.id=e._gradientPatternId++};CanvasGradient.prototype={addColorStop:function(e,t){if(isNaN(e)||0>e||e>1)throwException(INDEX_SIZE_ERR);this._ctx._queue.push(properties.addColorStop,this.id,e,t)}};var CanvasPattern=function(e){this.id=e._gradientPatternId++},TextMetrics=function(e){this.width=e},DOMException=function(e){this.code=e,this.message=DOMExceptionNames[e]};DOMException.prototype=new Error;var DOMExceptionNames={1:"INDEX_SIZE_ERR",9:"NOT_SUPPORTED_ERR",11:"INVALID_STATE_ERR",12:"SYNTAX_ERR",17:"TYPE_MISMATCH_ERR",18:"SECURITY_ERR"},FlashCanvas={initElement:function(e){if(e.getContext)return e;var t=getUniqueId(),n=OBJECT_ID_PREFIX+t;isReady[t]=!1,images[t]={},lock[t]=1,callbacks[t]={},setCanvasSize(e),e.innerHTML='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+location.protocol+'//fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="100%" height="100%" id="'+n+'"><param name="allowScriptAccess" value="always"><param name="flashvars" value="id='+n+'"><param name="wmode" value="transparent"></object><span style="margin:0;padding:0;border:0;display:inline-block;position:static;height:1em;overflow:visible;white-space:nowrap"></span>',canvases[t]=e;var i=e.firstChild;spans[t]=e.lastChild;var a=document.body.contains;if(a(e))i.movie=SWF_URL;else var r=setInterval(function(){if(a(e))clearInterval(r),i.movie=SWF_URL},0);if("BackCompat"===document.compatMode||!window.XMLHttpRequest)spans[t].style.overflow="hidden";var o=new CanvasRenderingContext2D(e,i);return e.getContext=function(e){return"2d"===e?o:NULL},e.toDataURL=function(e,t){if("image/jpeg"===(""+e).replace(/[A-Z]+/g,toLowerCase))o._queue.push(properties.toDataURL,e,"number"==typeof t?t:"");else o._queue.push(properties.toDataURL,e);return o._executeCommand()},i.attachEvent(ON_FOCUS,onFocus),e},saveImage:function(e,t){var n=e.firstChild;n.saveImage(t)},setOptions:function(){},trigger:function(e,t){var n=canvases[e];n.fireEvent("on"+t)},unlock:function(e,t,n){var i,a,r,o,s,l,h;if(lock[e])--lock[e];if(void 0===t){if(i=canvases[e],a=i.firstChild,setCanvasSize(i),r=i.width,o=i.height,i.style.width=r+"px",i.style.height=o+"px",r>0)a.width=r;if(o>0)a.height=o;if(a.resize(r,o),i.attachEvent(ON_PROPERTY_CHANGE,onPropertyChange),isReady[e]=!0,"function"==typeof i.onload)setTimeout(function(){i.onload()},0)}else if(s=callbacks[e][t])if(l=s[0],h=s[1+n],delete callbacks[e][t],"function"==typeof h)h.call(l)}};if(document.createElement(CANVAS),document.createStyleSheet().cssText=CANVAS+"{display:inline-block;overflow:hidden;width:300px;height:150px}","complete"===document.readyState)onReadyStateChange();else document.attachEvent(ON_READY_STATE_CHANGE,onReadyStateChange);if(window.attachEvent(ON_UNLOAD,onUnload),0===SWF_URL.indexOf(location.protocol+"//"+location.host+"/")){var req=new ActiveXObject("Microsoft.XMLHTTP");req.open("GET",SWF_URL,!1),req.send(NULL)}window[CANVAS_RENDERING_CONTEXT_2D]=CanvasRenderingContext2D,window[CANVAS_GRADIENT]=CanvasGradient,window[CANVAS_PATTERN]=CanvasPattern,window[FLASH_CANVAS]=FlashCanvas,window[G_VML_CANVAS_MANAGER]={init:function(){},init_:function(){},initElement:FlashCanvas.initElement},keep=[CanvasRenderingContext2D.measureText,CanvasRenderingContext2D.loadImage]}});