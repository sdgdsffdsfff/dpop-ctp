define("zrender/Handler",["require","./config","./tool/env","./tool/event","./tool/util","./tool/vector","./tool/matrix","./mixin/Eventful"],function(require){"use strict";function e(e,t){return function(i){return e.call(t,i)}}function t(e,t){return function(i,n,a){return e.call(t,i,n,a)}}function i(t){for(var i=c.length;i--;){var n=c[i];t["_"+n+"Handler"]=e(p[n],t)}}function n(e,t,i){if(this._draggingTarget&&this._draggingTarget.id==e.id||e.isSilent())return!1;var n=this._event;if(e.isCover(t,i)){if(e.hoverable)this.storage.addHover(e);for(var a=e.parent;a;){if(a.clipShape&&!a.clipShape.isCover(this._mouseX,this._mouseY))return!1;a=a.parent}if(this._lastHover!=e)this._processOutShape(n),this._processDragLeave(n),this._lastHover=e,this._processDragEnter(n);return this._processOverShape(n),this._processDragOver(n),this._hasfound=1,!0}return!1}var a=require("./config"),r=require("./tool/env"),o=require("./tool/event"),s=require("./tool/util"),l=require("./tool/vector"),h=require("./tool/matrix"),d=a.EVENT,u=require("./mixin/Eventful"),c=["resize","click","dblclick","mousewheel","mousemove","mouseout","mouseup","mousedown","touchstart","touchend","touchmove"],p={resize:function(e){e=e||window.event,this._lastHover=null,this._isMouseDown=0,this.dispatch(d.RESIZE,e)},click:function(e){e=this._zrenderEventFixed(e);var t=this._lastHover;if(t&&t.clickable||!t)if(this._clickThreshold<5)this._dispatchAgency(t,d.CLICK,e);this._mousemoveHandler(e)},dblclick:function(e){e=e||window.event,e=this._zrenderEventFixed(e);var t=this._lastHover;if(t&&t.clickable||!t)if(this._clickThreshold<5)this._dispatchAgency(t,d.DBLCLICK,e);this._mousemoveHandler(e)},mousewheel:function(e){e=this._zrenderEventFixed(e);var t=e.wheelDelta||-e.detail,i=t>0?1.1:1/1.1,n=!1,a=this._mouseX,r=this._mouseY;if(this.painter.eachBuildinLayer(function(t){var s=t.position;if(t.zoomable){t.__zoom=t.__zoom||1;var l=t.__zoom;l*=i,l=Math.max(Math.min(t.maxZoom,l),t.minZoom),i=l/t.__zoom,t.__zoom=l,s[0]-=(a-s[0])*(i-1),s[1]-=(r-s[1])*(i-1),t.scale[0]*=i,t.scale[1]*=i,t.dirty=!0,n=!0,o.stop(e)}}),n)this.painter.refresh();this._dispatchAgency(this._lastHover,d.MOUSEWHEEL,e),this._mousemoveHandler(e)},mousemove:function(e){if(!this.painter.isLoading()){e=this._zrenderEventFixed(e),this._lastX=this._mouseX,this._lastY=this._mouseY,this._mouseX=o.getX(e),this._mouseY=o.getY(e);var t=this._mouseX-this._lastX,i=this._mouseY-this._lastY;if(this._processDragStart(e),this._hasfound=0,this._event=e,this._iterateAndFindHover(),!this._hasfound){if(!this._draggingTarget||this._lastHover&&this._lastHover!=this._draggingTarget)this._processOutShape(e),this._processDragLeave(e);this._lastHover=null,this.storage.delHover(),this.painter.clearHover()}var n="default";if(this._draggingTarget)this.storage.drift(this._draggingTarget.id,t,i),this._draggingTarget.modSelf(),this.storage.addHover(this._draggingTarget),this._clickThreshold++;else if(this._isMouseDown){var a=!1;if(this.painter.eachBuildinLayer(function(e){if(e.panable)n="move",e.position[0]+=t,e.position[1]+=i,a=!0,e.dirty=!0}),a)this.painter.refresh()}if(this._draggingTarget||this._hasfound&&this._lastHover.draggable)n="move";else if(this._hasfound&&this._lastHover.clickable)n="pointer";if(this.root.style.cursor=n,this._dispatchAgency(this._lastHover,d.MOUSEMOVE,e),this._draggingTarget||this._hasfound||this.storage.hasHoverShape())this.painter.refreshHover()}},mouseout:function(e){e=this._zrenderEventFixed(e);var t=e.toElement||e.relatedTarget;if(t!=this.root)for(;t&&9!=t.nodeType;){if(t==this.root)return void this._mousemoveHandler(e);t=t.parentNode}if(e.zrenderX=this._lastX,e.zrenderY=this._lastY,this.root.style.cursor="default",this._isMouseDown=0,this._processOutShape(e),this._processDrop(e),this._processDragEnd(e),!this.painter.isLoading())this.painter.refreshHover();this.dispatch(d.GLOBALOUT,e)},mousedown:function(e){if(this._clickThreshold=0,2==this._lastDownButton)return this._lastDownButton=e.button,void(this._mouseDownTarget=null);else return this._lastMouseDownMoment=new Date,e=this._zrenderEventFixed(e),this._isMouseDown=1,this._mouseDownTarget=this._lastHover,this._dispatchAgency(this._lastHover,d.MOUSEDOWN,e),void(this._lastDownButton=e.button)},mouseup:function(e){e=this._zrenderEventFixed(e),this.root.style.cursor="default",this._isMouseDown=0,this._mouseDownTarget=null,this._dispatchAgency(this._lastHover,d.MOUSEUP,e),this._processDrop(e),this._processDragEnd(e)},touchstart:function(e){e=this._zrenderEventFixed(e,!0),this._lastTouchMoment=new Date,this._mobileFindFixed(e),this._mousedownHandler(e)},touchmove:function(e){if(e=this._zrenderEventFixed(e,!0),this._mousemoveHandler(e),this._isDragging)o.stop(e)},touchend:function(e){e=this._zrenderEventFixed(e,!0),this._mouseupHandler(e);var t=new Date;if(t-this._lastTouchMoment<d.touchClickDelay){if(this._mobileFindFixed(e),this._clickHandler(e),t-this._lastClickMoment<d.touchClickDelay/2)if(this._dblclickHandler(e),this._lastHover&&this._lastHover.clickable)o.stop(e);this._lastClickMoment=t}this.painter.clearHover()}},m=function(e,a,o){if(u.call(this),this.root=e,this.storage=a,this.painter=o,this._lastX=this._lastY=this._mouseX=this._mouseY=0,this._findHover=t(n,this),this._domHover=o.getDomHover(),i(this),window.addEventListener){if(window.addEventListener("resize",this._resizeHandler),r.os.tablet||r.os.phone)e.addEventListener("touchstart",this._touchstartHandler),e.addEventListener("touchmove",this._touchmoveHandler),e.addEventListener("touchend",this._touchendHandler);else e.addEventListener("click",this._clickHandler),e.addEventListener("dblclick",this._dblclickHandler),e.addEventListener("mousewheel",this._mousewheelHandler),e.addEventListener("mousemove",this._mousemoveHandler),e.addEventListener("mousedown",this._mousedownHandler),e.addEventListener("mouseup",this._mouseupHandler);e.addEventListener("DOMMouseScroll",this._mousewheelHandler),e.addEventListener("mouseout",this._mouseoutHandler)}else window.attachEvent("onresize",this._resizeHandler),e.attachEvent("onclick",this._clickHandler),e.ondblclick=this._dblclickHandler,e.attachEvent("onmousewheel",this._mousewheelHandler),e.attachEvent("onmousemove",this._mousemoveHandler),e.attachEvent("onmouseout",this._mouseoutHandler),e.attachEvent("onmousedown",this._mousedownHandler),e.attachEvent("onmouseup",this._mouseupHandler)};m.prototype.on=function(e,t,i){return this.bind(e,t,i),this},m.prototype.un=function(e,t){return this.unbind(e,t),this},m.prototype.trigger=function(e,t){switch(e){case d.RESIZE:case d.CLICK:case d.DBLCLICK:case d.MOUSEWHEEL:case d.MOUSEMOVE:case d.MOUSEDOWN:case d.MOUSEUP:case d.MOUSEOUT:this["_"+e+"Handler"](t)}},m.prototype.dispose=function(){var e=this.root;if(window.removeEventListener){if(window.removeEventListener("resize",this._resizeHandler),r.os.tablet||r.os.phone)e.removeEventListener("touchstart",this._touchstartHandler),e.removeEventListener("touchmove",this._touchmoveHandler),e.removeEventListener("touchend",this._touchendHandler);else e.removeEventListener("click",this._clickHandler),e.removeEventListener("dblclick",this._dblclickHandler),e.removeEventListener("mousewheel",this._mousewheelHandler),e.removeEventListener("mousemove",this._mousemoveHandler),e.removeEventListener("mousedown",this._mousedownHandler),e.removeEventListener("mouseup",this._mouseupHandler);e.removeEventListener("DOMMouseScroll",this._mousewheelHandler),e.removeEventListener("mouseout",this._mouseoutHandler)}else window.detachEvent("onresize",this._resizeHandler),e.detachEvent("onclick",this._clickHandler),e.detachEvent("dblclick",this._dblclickHandler),e.detachEvent("onmousewheel",this._mousewheelHandler),e.detachEvent("onmousemove",this._mousemoveHandler),e.detachEvent("onmouseout",this._mouseoutHandler),e.detachEvent("onmousedown",this._mousedownHandler),e.detachEvent("onmouseup",this._mouseupHandler);this.root=this._domHover=this.storage=this.painter=null,this.un()},m.prototype._processDragStart=function(e){var t=this._lastHover;if(this._isMouseDown&&t&&t.draggable&&!this._draggingTarget&&this._mouseDownTarget==t){if(t.dragEnableTime&&new Date-this._lastMouseDownMoment<t.dragEnableTime)return;var i=t;this._draggingTarget=i,this._isDragging=1,i.invisible=!0,this.storage.mod(i.id),this._dispatchAgency(i,d.DRAGSTART,e),this.painter.refresh()}},m.prototype._processDragEnter=function(e){if(this._draggingTarget)this._dispatchAgency(this._lastHover,d.DRAGENTER,e,this._draggingTarget)},m.prototype._processDragOver=function(e){if(this._draggingTarget)this._dispatchAgency(this._lastHover,d.DRAGOVER,e,this._draggingTarget)},m.prototype._processDragLeave=function(e){if(this._draggingTarget)this._dispatchAgency(this._lastHover,d.DRAGLEAVE,e,this._draggingTarget)},m.prototype._processDrop=function(e){if(this._draggingTarget)this._draggingTarget.invisible=!1,this.storage.mod(this._draggingTarget.id),this.painter.refresh(),this._dispatchAgency(this._lastHover,d.DROP,e,this._draggingTarget)},m.prototype._processDragEnd=function(e){if(this._draggingTarget)this._dispatchAgency(this._draggingTarget,d.DRAGEND,e),this._lastHover=null;this._isDragging=0,this._draggingTarget=null},m.prototype._processOverShape=function(e){this._dispatchAgency(this._lastHover,d.MOUSEOVER,e)},m.prototype._processOutShape=function(e){this._dispatchAgency(this._lastHover,d.MOUSEOUT,e)},m.prototype._dispatchAgency=function(e,t,i,n){var a="on"+t,r={type:t,event:i,target:e,cancelBubble:!1},o=e;if(n)r.dragged=n;for(;o&&(o[a]&&(r.cancelBubble=o[a](r)),o.dispatch(t,r),o=o.parent,!r.cancelBubble););if(e){if(!r.cancelBubble)this.dispatch(t,r)}else if(!n){var s={type:t,event:i};this.dispatch(t,s),this.painter.eachOtherLayer(function(e){if("function"==typeof e[a])e[a](s);if(e.dispatch)e.dispatch(t,s)})}},m.prototype._iterateAndFindHover=function(){var e=h.create();return function(){for(var t,i,n=this.storage.getShapeList(),a=[0,0],r=n.length-1;r>=0;r--){var o=n[r];if(t!==o.zlevel)if(i=this.painter.getLayer(o.zlevel,i),a[0]=this._mouseX,a[1]=this._mouseY,i.needTransform)h.invert(e,i.transform),l.applyTransform(a,a,e);if(this._findHover(o,a[0],a[1]))break}}}();var f=[{x:10},{x:-20},{x:10,y:10},{y:-20}];return m.prototype._mobileFindFixed=function(e){this._lastHover=null,this._mouseX=e.zrenderX,this._mouseY=e.zrenderY,this._event=e,this._iterateAndFindHover();for(var t=0;!this._lastHover&&t<f.length;t++){var i=f[t];i.x&&(this._mouseX+=i.x),i.y&&(this._mouseY+=i.y),this._iterateAndFindHover()}if(this._lastHover)e.zrenderX=this._mouseX,e.zrenderY=this._mouseY},m.prototype._zrenderEventFixed=function(e,t){if(e.zrenderFixed)return e;if(!t){e=e||window.event;var i=e.toElement||e.relatedTarget||e.srcElement||e.target;if(i&&i!=this._domHover)e.zrenderX=("undefined"!=typeof e.offsetX?e.offsetX:e.layerX)+i.offsetLeft,e.zrenderY=("undefined"!=typeof e.offsetY?e.offsetY:e.layerY)+i.offsetTop}else{var n="touchend"!=e.type?e.targetTouches[0]:e.changedTouches[0];if(n){var a=this.painter._domRoot.getBoundingClientRect();e.zrenderX=n.clientX-a.left,e.zrenderY=n.clientY-a.top}}return e.zrenderFixed=1,e},s.merge(m.prototype,u.prototype,!0),m});