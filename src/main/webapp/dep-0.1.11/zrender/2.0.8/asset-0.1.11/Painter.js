define("zrender/Painter",["require","./config","./tool/util","./tool/log","./loadingEffect/Base","./Layer","./shape/Image"],function(require){"use strict";function e(){return!1}function t(){}function i(e){if(!e)return!1;if(e.isBuildin)return!0;if("function"!=typeof e.resize||"function"!=typeof e.refresh)return!1;else return!0}var n=require("./config"),a=require("./tool/util"),r=require("./tool/log"),o=require("./loadingEffect/Base"),s=require("./Layer"),l=function(t,i){this.root=t,t.style["-webkit-tap-highlight-color"]="transparent",t.style["-webkit-user-select"]="none",t.style["user-select"]="none",t.style["-webkit-touch-callout"]="none",this.storage=i,t.innerHTML="",this._width=this._getWidth(),this._height=this._getHeight();var n=document.createElement("div");this._domRoot=n,n.style.position="relative",n.style.overflow="hidden",n.style.width=this._width+"px",n.style.height=this._height+"px",t.appendChild(n),this._layers={},this._zlevelList=[],this._layerConfig={},this._loadingEffect=new o({}),this.shapeToImage=this._createShapeToImageProcessor(),this._bgDom=document.createElement("div"),this._bgDom.style.cssText=["position:absolute;left:0px;top:0px;width:",this._width,"px;height:",this._height+"px;","-webkit-user-select:none;user-select;none;","-webkit-touch-callout:none;"].join(""),this._bgDom.setAttribute("data-zr-dom-id","bg"),n.appendChild(this._bgDom),this._bgDom.onselectstart=e;var a=new s("_zrender_hover_",this);this._layers.hover=a,n.appendChild(a.dom),a.initContext(),a.dom.onselectstart=e,a.dom.style["-webkit-user-select"]="none",a.dom.style["user-select"]="none",a.dom.style["-webkit-touch-callout"]="none",this.refreshNextFrame=null};return l.prototype.render=function(e){if(this.isLoading())this.hideLoading();return this.refresh(e,!0),this},l.prototype.refresh=function(e,t){var i=this.storage.getShapeList(!0);this._paintList(i,t);for(var n=0;n<this._zlevelList.length;n++){var a=this._zlevelList[n],r=this._layers[a];if(!r.isBuildin&&r.refresh)r.refresh()}if("function"==typeof e)e();return this},l.prototype._preProcessLayer=function(e){e.unusedCount++,e.updateTransform()},l.prototype._postProcessLayer=function(e){if(e.dirty=!1,1==e.unusedCount)e.clear()},l.prototype._paintList=function(e,t){if("undefined"==typeof t)t=!1;this._updateLayerStatus(e);var i,a,o;this.eachBuildinLayer(this._preProcessLayer);for(var s=0,l=e.length;l>s;s++){var h=e[s];if(a!==h.zlevel){if(i){if(i.needTransform)o.restore();o.flush&&o.flush()}if(a=h.zlevel,i=this.getLayer(a),!i.isBuildin)r("ZLevel "+a+" has been used by unkown layer "+i.id);if(o=i.ctx,i.unusedCount=0,i.dirty||t)i.clear();if(i.needTransform)o.save(),i.setTransform(o)}if((i.dirty||t)&&!h.invisible)if(!h.onbrush||h.onbrush&&!h.onbrush(o,!1))if(n.catchBrushException)try{h.brush(o,!1,this.refreshNextFrame)}catch(d){r(d,"brush error of "+h.type,h)}else h.brush(o,!1,this.refreshNextFrame);h.__dirty=!1}if(i){if(i.needTransform)o.restore();o.flush&&o.flush()}this.eachBuildinLayer(this._postProcessLayer)},l.prototype.getLayer=function(e){var t=this._layers[e];if(!t){if(t=new s(e,this),t.isBuildin=!0,this._layerConfig[e])a.merge(t,this._layerConfig[e],!0);t.updateTransform(),this.insertLayer(e,t),t.initContext()}return t},l.prototype.insertLayer=function(e,t){if(this._layers[e])return void r("ZLevel "+e+" has been used already");if(!i(t))return void r("Layer of zlevel "+e+" is not valid");var n=this._zlevelList.length,a=null,o=-1;if(n>0&&e>this._zlevelList[0]){for(o=0;n-1>o&&!(this._zlevelList[o]<e&&this._zlevelList[o+1]>e);o++);a=this._layers[this._zlevelList[o]]}this._zlevelList.splice(o+1,0,e);var s=a?a.dom:this._bgDom;if(s.nextSibling)s.parentNode.insertBefore(t.dom,s.nextSibling);else s.parentNode.appendChild(t.dom);this._layers[e]=t},l.prototype.eachLayer=function(e,t){for(var i=0;i<this._zlevelList.length;i++){var n=this._zlevelList[i];e.call(t,this._layers[n],n)}},l.prototype.eachBuildinLayer=function(e,t){for(var i=0;i<this._zlevelList.length;i++){var n=this._zlevelList[i],a=this._layers[n];if(a.isBuildin)e.call(t,a,n)}},l.prototype.eachOtherLayer=function(e,t){for(var i=0;i<this._zlevelList.length;i++){var n=this._zlevelList[i],a=this._layers[n];if(!a.isBuildin)e.call(t,a,n)}},l.prototype.getLayers=function(){return this._layers},l.prototype._updateLayerStatus=function(e){var t=this._layers,i={};this.eachBuildinLayer(function(e,t){i[t]=e.elCount,e.elCount=0});for(var n=0,a=e.length;a>n;n++){var r=e[n],o=r.zlevel,s=t[o];if(s){if(s.elCount++,s.dirty)continue;s.dirty=r.__dirty}}this.eachBuildinLayer(function(e,t){if(i[t]!==e.elCount)e.dirty=!0})},l.prototype.refreshShapes=function(e,t){for(var i=0,n=e.length;n>i;i++){var a=e[i];a.modSelf()}return this.refresh(t),this},l.prototype.setLoadingEffect=function(e){return this._loadingEffect=e,this},l.prototype.clear=function(){return this.eachBuildinLayer(this._clearLayer),this},l.prototype._clearLayer=function(e){e.clear()},l.prototype.modLayer=function(e,t){if(t){if(!this._layerConfig[e])this._layerConfig[e]=t;else a.merge(this._layerConfig[e],t,!0);var i=this._layers[e];if(i)a.merge(i,this._layerConfig[e],!0)}},l.prototype.delLayer=function(e){var t=this._layers[e];if(t)this.modLayer(e,{position:t.position,rotation:t.rotation,scale:t.scale}),t.dom.parentNode.removeChild(t.dom),delete this._layers[e],this._zlevelList.splice(a.indexOf(this._zlevelList,e),1)},l.prototype.refreshHover=function(){this.clearHover();for(var e=this.storage.getHoverShapes(!0),t=0,i=e.length;i>t;t++)this._brushHover(e[t]);var n=this._layers.hover.ctx;return n.flush&&n.flush(),this.storage.delHover(),this},l.prototype.clearHover=function(){var e=this._layers.hover;return e&&e.clear(),this},l.prototype.showLoading=function(e){return this._loadingEffect&&this._loadingEffect.stop(),e&&this.setLoadingEffect(e),this._loadingEffect.start(this),this.loading=!0,this},l.prototype.hideLoading=function(){return this._loadingEffect.stop(),this.clearHover(),this.loading=!1,this},l.prototype.isLoading=function(){return this.loading},l.prototype.resize=function(){var e=this._domRoot;e.style.display="none";var t=this._getWidth(),i=this._getHeight();if(e.style.display="",this._width!=t||i!=this._height){this._width=t,this._height=i,e.style.width=t+"px",e.style.height=i+"px";for(var n in this._layers)this._layers[n].resize(t,i);this.refresh(null,!0)}return this},l.prototype.clearLayer=function(e){var t=this._layers[e];if(t)t.clear()},l.prototype.dispose=function(){if(this.isLoading())this.hideLoading();this.root.innerHTML="",this.root=this.storage=this._domRoot=this._layers=null},l.prototype.getDomHover=function(){return this._layers.hover.dom},l.prototype.toDataURL=function(e,t,i){if(window.G_vmlCanvasManager)return null;var a=new s("image",this);this._bgDom.appendChild(a.dom),a.initContext();var o=a.ctx;a.clearColor=t||"#fff",a.clear();var l=this;this.storage.iterShape(function(e){if(!e.invisible)if(!e.onbrush||e.onbrush&&!e.onbrush(o,!1))if(n.catchBrushException)try{e.brush(o,!1,l.refreshNextFrame)}catch(t){r(t,"brush error of "+e.type,e)}else e.brush(o,!1,l.refreshNextFrame)},{normal:"up",update:!0});var h=a.dom.toDataURL(e,i);return o=null,this._bgDom.removeChild(a.dom),h},l.prototype.getWidth=function(){return this._width},l.prototype.getHeight=function(){return this._height},l.prototype._getWidth=function(){var e=this.root,t=e.currentStyle||document.defaultView.getComputedStyle(e);return((e.clientWidth||parseInt(t.width,10))-parseInt(t.paddingLeft,10)-parseInt(t.paddingRight,10)).toFixed(0)-0},l.prototype._getHeight=function(){var e=this.root,t=e.currentStyle||document.defaultView.getComputedStyle(e);return((e.clientHeight||parseInt(t.height,10))-parseInt(t.paddingTop,10)-parseInt(t.paddingBottom,10)).toFixed(0)-0},l.prototype._brushHover=function(e){var t=this._layers.hover.ctx;if(!e.onbrush||e.onbrush&&!e.onbrush(t,!0)){var i=this.getLayer(e.zlevel);if(i.needTransform)t.save(),i.setTransform(t);if(n.catchBrushException)try{e.brush(t,!0,this.refreshNextFrame)}catch(a){r(a,"hoverBrush error of "+e.type,e)}else e.brush(t,!0,this.refreshNextFrame);if(i.needTransform)t.restore()}},l.prototype._shapeToImage=function(e,t,i,n,a){var r=document.createElement("canvas"),o=r.getContext("2d");r.style.width=i+"px",r.style.height=n+"px",r.setAttribute("width",i*a),r.setAttribute("height",n*a),o.clearRect(0,0,i*a,n*a);var s={position:t.position,rotation:t.rotation,scale:t.scale};if(t.position=[0,0,0],t.rotation=0,t.scale=[1,1],t)t.brush(o,!1);var l=require("./shape/Image"),h=new l({id:e,style:{x:0,y:0,image:r}});if(null!=s.position)h.position=t.position=s.position;if(null!=s.rotation)h.rotation=t.rotation=s.rotation;if(null!=s.scale)h.scale=t.scale=s.scale;return h},l.prototype._createShapeToImageProcessor=function(){if(window.G_vmlCanvasManager)return t;var e=this;return function(t,i,a,r){return e._shapeToImage(t,i,a,r,n.devicePixelRatio)}},l});