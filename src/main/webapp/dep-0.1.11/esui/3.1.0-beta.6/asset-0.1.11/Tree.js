define("esui/Tree",["require","./Control","./lib","./controlHelper","underscore","./TreeStrategy","./main"],function(require){function e(){f.apply(this,arguments)}function t(){p.apply(this,arguments)}function i(e,t,i,n,a){var o=a-n,r=0===o?"current":1===o?"previous":"far-previous",s=[].concat(u.getPartClasses(e,"node-indicator"),u.getPartClasses(e,"node-indicator-"+i),u.getPartClasses(e,"node-indicator-level-"+n),u.getPartClasses(e,"node-indicator-"+r)),l=0===o?g[i||"collapsed"]:"第"+n+"级",h="<span ";if(0===o)h+='id="'+u.getId(e,"indicator-"+t.id)+'" ';return h+='class="'+s.join(" ")+'">'+l+"</span>"}function n(e,t,n,a){var r=u.getPartClasses(e,"content-wrapper");if(e.selectedNodeIndex[t.id])r=r.concat(u.getPartClasses(e,"content-wrapper-selected"));r=r.join(" ");for(var s=u.getId(e,"content-wrapper-"+t.id),l='<div id="'+s+'" class="'+r+'">',h=e.strategy.isLeafNode(t)?"empty":a?"expanded":"collapsed",d=0;n>=d;d++)l+=i(e,t,h,d,n);var m=u.getPartClasses(e,"item-content");if(l+='<div class="'+m.join(" ")+'">'+e.getItemHTML(t)+"</div>",l+="</div>",a&&!e.strategy.isLeafNode(t)){var c=[].concat(u.getPartClasses(e,"sub-root"),u.getPartClasses(e,"sub-root-"+h));l+='<ul class="'+c.join(" ")+'">';for(var d=0;d<t.children.length;d++){var p=t.children[d];l+=o(e,p,n+1,e.strategy.shouldExpand(p))}l+="</ul>"}return l}function a(e,t,i,n){var a=e.strategy.isLeafNode(t)?"empty":n?"expanded":"collapsed",o=[].concat(u.getPartClasses(e,"node"),u.getPartClasses(e,"node-"+a),u.getPartClasses(e,"node-level-"+i));if(t===e.datasource)o=[].concat(u.getPartClasses(e,"root"),u.getPartClasses(e,"root-"+a),o);return o}function o(e,t,i,o,r){r=r||"li";var s=a(e,t,i,o),l="<"+r+' class="'+s.join(" ")+'" id="'+u.getId(e,"node-"+t.id)+'" data-id="'+t.id+'" data-level="'+i+'">';return l+=n(e,t,i,o),l+="</"+r+">"}function r(e){var t=e.target,i=u.getPartClasses(this,"node-indicator")[0],n=V.hasClass(t,i),a=!n;if(!n){for(var o=u.getPartClasses(this,"content-wrapper")[0];t&&t!==this.main&&!V.hasClass(t,o);)t=t.parentNode;if(V.hasClass(t,o))n=this.wideToggleArea,a=a&&!0}if(n||a){for(;t&&t!==this.main&&!V.hasAttribute(t,"data-id");)t=t.parentNode;var r=t.getAttribute("data-id");if(n)this.triggerToggleStrategy(r);if(a)this.triggerSelectStrategy(r)}}function s(e,t){if(t=t||{},t[e.id]=e,e.children)for(var i=0;i<e.children.length;i++)s(e.children[i],t);return t}function l(e,t){if(e.selectedNodeIndex[t.id])return!1;else return e.selectedNodes.push(t),e.selectedNodeIndex[t.id]=t,!0}function h(e,t){if(e.selectedNodeIndex[t.id]){delete e.selectedNodeIndex[t.id];for(var i=0;i<e.selectedNodes.length;i++)if(e.selectedNodes[i]===t)e.selectedNodes.splice(i,1);return!0}return!1}function d(e,t,i){if(i.force||e.allowUnselectNode){var n=e.nodeIndex[t];if(n){var a=h(e,n);if(a){if(i.modifyDOM){var o=V.g(u.getId(e,"content-wrapper-"+t));u.removePartClasses(e,"content-wrapper-selected",o)}if(!i.silent)e.fire("unselectnode",{node:n}),e.fire("selectionchange")}}}}function m(e,t){var i=u.getPartClasses(e,"node-empty")[0];return V.hasClass(t,i)}function c(e,t){var i=u.getPartClasses(e,"node-expanded")[0];return V.hasClass(t,i)}var p=require("./Control"),V=require("./lib"),u=require("./controlHelper"),U=require("underscore"),f=require("./TreeStrategy");e.prototype.attachTo=function(){},V.inherits(e,f),t.prototype.type="Tree",t.defaultProperties={selectMode:"single",hideRoot:!1},t.prototype.initOptions=function(i){var n={datasource:{},strategy:new e,selectedNodes:[],selectedNodeIndex:{}},a=V.extend(n,t.defaultProperties,i);if(null==a.allowUnselectNode)a.allowUnselectNode="single"!==a.selectMode;this.setProperties(a)},t.prototype.itemTemplate="<span>${text}</span>",t.prototype.getItemHTML=function(e){var t={id:V.encodeHTML(e.id),text:V.encodeHTML(e.text)};return V.format(this.itemTemplate,t)};var g={collapsed:"展开",expanded:"收起",busy:"加载中",empty:"无内容"};return t.prototype.clickNode=function(){r.apply(this,arguments)},t.prototype.initStructure=function(){this.strategy.attachTo(this)},t.prototype.initEvents=function(){u.addDOMEvent(this,this.main,"click",this.clickNode)},t.prototype.removeNodeFromIndex=function(e){var t=this.nodeIndex[e];if(t)if(this.nodeIndex[e]=void 0,t.children)U.each(t.children,this.removeNodeFromIndex,this)},t.prototype.repaint=u.createRepaint(p.prototype.repaint,{name:"datasource",paint:function(e,t){e.selectedNodes=[],e.selectedNodeIndex={},e.nodeIndex=s(t),e.main.innerHTML=o(e,t,0,!0,"div")}},{name:"hideRoot",paint:function(e,t){var i=t?"addState":"removeState";e[i]("hide-root")}}),t.prototype.triggerSelectStrategy=function(e){var t=this.nodeIndex[e];if(t)if(this.selectedNodeIndex[e])this.fire("unselect",{node:t});else this.fire("select",{node:t})},t.prototype.getSelectedNodes=function(){return this.selectedNodes.slice()},t.prototype.toggleNodeSelection=function(e){var t=this.selectedNodeIndex[e]?"unselectNode":"selectNode";this[t](e)},t.prototype.selectNode=function(e,t){var i=this.nodeIndex[e];if(i){var n=l(this,i);if(n){if("single"===this.selectMode&&this.selectedNodes.length>1)d(this,this.selectedNodes[0].id,{force:!0,silent:!0,modifyDOM:!0});var a=V.g(u.getId(this,"content-wrapper-"+e));if(u.addPartClasses(this,"content-wrapper-selected",a),!t)this.fire("selectnode",{node:i}),this.fire("selectionchange")}}},t.prototype.unselectNode=function(e,t){d(this,e,{force:!0,silent:t,modifyDOM:!0})},t.prototype.expandNode=function(e,t){var i=V.g(u.getId(this,"node-"+e));if(i){var o=+V.getAttribute(i,"data-level");if(t||"ul"!==i.lastChild.nodeName.toLowerCase()){var r=this.nodeIndex[e];if(!r)return;if(t){if(r.children)for(var l=0;l<r.children.length;l++)d(this,r.children[l].id,{force:!0,silent:!0,modifyDOM:!1}),this.removeNodeFromIndex(r.children[l].id);r.children=t,s(r,this.nodeIndex)}i.innerHTML=n(this,r,o,!0)}else{var h=V.g(u.getId(this,"indicator-"+e));h.innerHTML=g.expanded;var m=[].concat(u.getPartClasses(this,"node-indicator"),u.getPartClasses(this,"node-indicator-level-"+o),u.getPartClasses(this,"node-indicator-current"),u.getPartClasses(this,"node-indicator-expanded"));h.className=m.join(" ");var c=[].concat(u.getPartClasses(this,"sub-root"),u.getPartClasses(this,"sub-root-expanded"));i.lastChild.className=c.join(" ")}var r=this.nodeIndex[e],p=a(this,r,o,!0);i.className=p.join(" ")}},t.prototype.collapseNode=function(e,t){var i=V.g(u.getId(this,"node-"+e));if(i){var n=this.nodeIndex[e],o=i.getElementsByTagName("ul")[0];if(o)if(t){if(o.parentNode.removeChild(o),n.children)for(var r=0;r<n.children.length;r++)d(this,n.children[r].id,{force:!0,silent:!1,modifyDOM:!1})}else{var s=[].concat(u.getPartClasses(this,"sub-root"),u.getPartClasses(this,"sub-root-collapsed"));o.className=s.join(" ")}var l=+V.getAttribute(i,"data-level"),h=a(this,n,l,!1);i.className=h.join(" ");var m=V.g(u.getId(this,"indicator-"+e)),c=[].concat(u.getPartClasses(this,"node-indicator"),u.getPartClasses(this,"node-indicator-level-"+l),u.getPartClasses(this,"node-indicator-current"),u.getPartClasses(this,"node-indicator-collapsed"));m.className=c.join(" "),m.innerHTML=g.collapsed}},t.prototype.toggleNode=function(e,t,i){if(this.nodeIndex[e]){var n=V.g(u.getId(this,"node-"+e));if(n)if(!m(this,n))if(c(this,n))this.collapseNode(e,i);else this.expandNode(e,t)}},t.prototype.triggerToggleStrategy=function(e){var t=this.nodeIndex[e];if(t){var i=V.g(u.getId(this,"node-"+e));if(i)if(!m(this,i))if(c(this,i))this.fire("collapse",{node:t});else this.fire("expand",{node:t})}},t.prototype.indicateNodeLoading=function(e){var t=V.g(u.getId(this,"node-"+e));if(t){for(var i=V.getChildren(t),n=0;!this.helper.isPart(i[n],"item-content");)n++;var a=i[n];a.innerHTML=g.busy;var o=[].concat(u.getPartClasses(this,"node-indicator"),u.getPartClasses(this,"node-indicator-level-"+n),u.getPartClasses(this,"node-indicator-current"),u.getPartClasses(this,"node-indicator-busy"));a.className=o.join(" ")}},t.prototype.dispose=function(){p.prototype.dispose.apply(this,arguments),this.nodeIndex=null,this.selectedNodes=null,this.selectedNodeIndex=null},require("./main").register(t),V.inherits(t,p),t});