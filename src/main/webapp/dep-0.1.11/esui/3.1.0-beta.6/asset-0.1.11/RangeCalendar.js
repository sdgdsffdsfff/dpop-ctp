define("esui/RangeCalendar",["require","./Button","./MonthView","./CheckBox","./Label","./lib","./InputControl","./controlHelper","./Layer","./main","moment","underscore"],function(require){function e(){v.apply(this,arguments)}function t(e,t,i){if("render"===i){var n=e.helper.getPart("shortcut");_.addDOMEvent(e,n,"click",p);var a=e.getChild("endlessCheck");if(a)if(a.on("change",x.curry(h,e)),e.isEndless)a.setChecked(!0),e.helper.addPartClasses("shortcut-disabled",e.helper.getPart(e));var o=e.getChild("okBtn");o.on("click",x.curry(f,e));var r=e.getChild("cancelBtn");r.on("click",w.bind(e.layer.hide,e.layer));var s=e.getChild("closeBtn");s.on("click",w.bind(e.layer.hide,e.layer))}else{e.view.begin=t.begin,e.view.end=t.end,e.value=e.convertToParam(t);var l;if(!t.end)l=!0;else l=!1;e.setProperties({isEndless:l})}U(e,"begin",e.view.begin,"render"===i),U(e,"end",e.view.end,"render"===i);var m=V(e,e.view);c(e,m)}function i(){this.now=new Date,L.apply(this,arguments),this.layer=new e(this)}function n(e){var t='<div class="${shortCutClass}" id="${shortcutId}">${shortCut}</div><div class="${bodyClass}">${beginCalendar}${endCalendar}</div><div class="${footClass}"><div class="${okBtnClass}" data-ui="type:Button;childName:okBtn;">确定</div><div class="${cancelBtnClass}" data-ui="type:Button;childName:cancelBtn;">取消</div></div><div data-ui="type:Button;childName:closeBtn;skin:layerClose;height:12;"></div>';return x.format(t,{bodyClass:e.helper.getPartClassName("body"),shortcutId:e.helper.getId("shortcut"),shortCutClass:e.helper.getPartClassName("shortcut"),shortCut:s(e),beginCalendar:l(e,"begin"),endCalendar:l(e,"end"),footClass:e.helper.getPartClassName("foot"),okBtnClass:e.helper.getPartClassName("okBtn"),cancelBtnClass:e.helper.getPartClassName("cancelBtn")})}function a(e){return X(e).startOf("day").toDate()}function o(e){return X(e).endOf("day").toDate()}function r(e,t){var i=e.range,n=t.getValue.call(e,e.now);if(a(i.begin)>a(i.begin)||o(n.end)<o(n.end))return!0;else return!1}function s(e){for(var t=e.shownShortCut.split(","),i={},n=0;n<t.length;n++)i[t[n]]=!0;for(var a='<span data-index="${shortIndex}" class="'+e.helper.getPartClassName("shortcut-item")+' ${shortClass}" id="${shortId}">${shortName}</span>',o=e.shortCutItems,s=o.length,l=[],h=0;s>h;h++){var m=o[h];if(i[m.name]){var V=m.name,d=[];if(0===h)d=d.concat(e.helper.getPartClasses("shortcut-item-first"));var c=r(e,m);if(c)d=d.concat(e.helper.getPartClasses("shortcut-item-disabled"));var U=e.helper.getId("shortcut-item"+h);l.push(x.format(a,{shortIndex:h,shortClass:d.join(" "),shortId:U,shortName:V}))}}return l.join("")}function l(e,t){var i="";if(e.endlessCheck&&"end"===t)i='<input type="checkbox" title="不限结束" data-ui-type="CheckBox" data-ui-child-name="endlessCheck" />';var n='<div class="${frameClass}"><div class="${labelClass}"><h3>${labelTitle}</h3>'+i+'</div><div class="${calClass}"><div data-ui="type:MonthView;childName:${calName}"></div></div></div>';return x.format(n,{frameClass:e.helper.getPartClassName(t),labelClass:e.helper.getPartClassName("label"),labelTitle:"begin"===t?"开始日期":"结束日期",titleId:e.helper.getId(t+"Label"),calClass:e.helper.getPartClassName(t+"-cal"),calName:t+"Cal"})}function h(e){var t,i=e.getChild("endCal"),n=e.helper.getPart("shortcut");if(this.isChecked())e.isEndless=!0,i.disable(),t=-1,e.view.end=null,e.helper.addPartClasses("shortcut-disabled",n);else e.isEndless=!1,i.enable(),u.apply(e,[i,"end"]),e.helper.removePartClasses("shortcut-disabled",n)}function m(e,t){if(!e&&t||e&&!t)return!1;else if(!e&&!t)return!0;return X(e).isSame(t,"day")}function V(e,t){for(var i=e.shortCutItems,n=i.length,a=0;n>a;a++){var o=i[a],r=o.getValue.call(e,e.now);if(m(t.begin,r.begin)&&m(t.end,r.end))return a}return-1}function d(e,t){var i=e,n=e.shortCutItems;if(!(0>t||t>=n.length)){var a=n[t].getValue.call(i,i.now),o=a.begin,r=a.end;e.view={begin:o,end:r},U(e,"begin",o),U(e,"end",r),c(i,t)}}function c(e,t){var i=e.shortCutItems,n=e.miniMode;if(null!==n&&n!==t)e.helper.removePartClasses("shortcut-item-selected",e.helper.getPart("shortcut-item"+n));if(e.miniMode=t,t>=0)e.helper.addPartClasses("shortcut-item-selected",e.helper.getPart("shortcut-item"+t)),e.curMiniName=i[t].name;else e.curMiniName=null}function U(e,t,i,n){var a=e.getChild(t+"Cal");if(a){if(n===!0)a.on("change",w.bind(u,e,a,t)),a.on("changemonth",w.bind(k,null,e));a.setProperties({rawValue:i,range:e.range})}}function p(e){if(!this.isEndless)for(var t=e.target||e.srcElement,i=this.helper.getPartClasses("shortcut-item"),n=this.helper.getPartClasses("shortcut-item-disabled");t&&t!==document.body;){if(x.hasClass(t,i[0])&&!x.hasClass(t,n[0])){var a=t.getAttribute("data-index");return void d(this,a)}t=t.parentNode}}function u(e,t){var i=e.getRawValue();if(i){this.view[t]=i;var n=V(this,this.view);c(this,n),k(this)}}function f(e){var t=e,i=e.view,n=i.begin,a=i.end;if(e.isEndless)a=null;var o=a-n;if(!a)o=n;var r;if(o>0)r={begin:n,end:a};else if(null!==a)r={begin:a,end:n};var s=t.fire("beforechange",{value:r});if(s.isDefaultPrevented())return!1;else return t.rawValue=r,t.value=t.convertToParam(r),g(t,r),t.layer.hide(),void t.fire("change",r)}function g(e,t){var i=e.helper.getPart("text");i.innerHTML=y(e,t)}function y(e,t){var i=b(e,t);if(e.isEndless&&i)return i;var n="";if(!e.curMiniName&&null!==e.miniMode&&e.miniMode>=0&&e.miniMode<e.shortCutItems.length)e.curMiniName=e.shortCutItems[e.miniMode].name;if(e.curMiniName)n=e.curMiniName+"&nbsp;&nbsp;";if(i)return n+i;else return""}function b(e,t){t=t||e.getRawValue();var i=t.begin,n=t.end,a=e.dateFormat;if(i&&n)return X(i).format(a)+" 至 "+X(n).format(a);else if(!n)return X(i).format(a)+" 起 ";return""}function k(e){function t(e,t){var n=new Date(e.year,e.month,1);n=X(n);for(var a=n.clone().endOf("month"),s=n;a>=s;){var l=!0;if("begin"===t&&(s<=X(o)||s>X(r)))l=!1;else if("end"===t&&(s<X(o)||s>=X(r)))l=!1;i(e,s.toDate(),l),s.add("day",1)}}function i(e,t,i){var n=e.getDateItemHTML(t);if(i)e.helper.addPartClasses("month-item-highlight",n);else e.helper.removePartClasses("month-item-highlight",n)}var n=e.getChild("beginCal"),a=e.getChild("endCal"),o=e.view.begin,r=e.view.end;t(n,"begin"),t(a,"end")}require("./Button"),require("./MonthView"),require("./CheckBox"),require("./Label");var x=require("./lib"),L=require("./InputControl"),_=require("./controlHelper"),v=require("./Layer"),W=require("./main"),X=require("moment"),w=require("underscore");return x.inherits(e,v),e.prototype.render=function(e){var i=this.control;document.body.appendChild(e),e.innerHTML=n(i),i.helper.initChildren(e),t(i,i.view,"render")},e.prototype.toggle=function(){var e=this.getElement();if(!e||this.control.helper.isPart(e,"layer-hidden")){var i=this.control;t(i,i.rawValue,"repaint"),this.show()}else this.hide()},i.prototype.convertToParam=function(e){var t=e.begin,i=e.end,n=" 00:00:00",a=" 23:59:59",o=[];if(o.push(X(t).format("YYYY-MM-DD")+n),i)o.push(X(i).format("YYYY-MM-DD")+a);return o.join(",")},i.prototype.convertToRaw=function(e){var t=e.split(",");if(1===t.length)t.push("2046-11-04");else if(""===t[0])t[0]="1983-09-03";else if(""===t[1])t[1]="2046-11-04";return{begin:X(t[0],"YYYY-MM-DD").toDate(),end:X(t[1],"YYYY-MM-DD").toDate()}},i.defaultProperties={dateFormat:"YYYY-MM-DD",endlessCheck:!1,shortCutItems:[{name:"昨天",value:0,getValue:function(){var e=new Date(this.now.getTime());return e.setDate(e.getDate()-1),{begin:e,end:e}}},{name:"最近7天",value:1,getValue:function(){var e=X(this.now);return{begin:e.clone().subtract("day",7).toDate(),end:e.clone().subtract("day",1).toDate()}}},{name:"上周",value:2,getValue:function(){var e=this.now,t=new Date(e.getTime()),i=new Date(e.getTime()),n=1;if(t.getDay()<n%7)t.setDate(t.getDate()-14+n-t.getDay());else t.setDate(t.getDate()-7-t.getDay()+n%7);return t.setHours(0,0,0,0),i.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()+6),i.setHours(0,0,0,0),{begin:t,end:i}}},{name:"本月",value:3,getValue:function(){return{begin:X(this.now).startOf("month").toDate(),end:X(this.now).toDate()}}},{name:"上个月",value:4,getValue:function(){var e=X(this.now).subtract("month",1).startOf("month").toDate(),t=X(this.now).startOf("month").subtract("day",1).toDate();return{begin:e,end:t}}},{name:"上个季度",value:5,getValue:function(){var e=this.now,t=X(e).subtract("month",e.getMonth()%3+3).startOf("month").toDate(),i=X(e).subtract("month",e.getMonth()%3).startOf("month").subtract("day",1).toDate();return{begin:t,end:i}}}]},i.prototype.type="RangeCalendar",i.prototype.initOptions=function(e){var t=this.now,n={begin:t,end:t},a={range:{begin:new Date(1983,8,3),end:new Date(2046,10,4)},rawValue:n,view:w.clone(n),value:this.convertToParam(n),shownShortCut:"昨天,最近7天,上周,本月,上个月,上个季度"};if(x.extend(a,i.defaultProperties),_.extractValueFromInput(this,e),e.value)e.rawValue=this.convertToRaw(e.value),e.view={begin:e.rawValue.begin,end:e.rawValue.end},e.miniMode=null;else if(e.rawValue)e.miniMode=null;else if(!e.rawValue&&null!=e.miniMode){var o=a.shortCutItems[e.miniMode];if(o)e.rawValue=o.getValue.call(this,this.now),e.miniMode=parseInt(e.miniMode,10);else e.miniMode=null}if(x.extend(a,e),a.range&&"string"==typeof a.range)a.range=this.convertToRaw(a.range);if("false"===a.endlessCheck)a.endlessCheck=!1;if(a.endlessCheck){if("false"===a.isEndless)a.isEndless=!1}else if(!a.rawValue.end)a.endlessCheck=!0,a.isEndless=!0;if(a.isEndless)a.endlessCheck=!0,a.rawValue.end=null,a.view.end=null,a.view.value=this.convertToParam({begin:t,end:null});this.setProperties(a)},i.prototype.initStructure=function(){if(x.isInput(this.main))_.replaceMain(this);var e=['<div class="${className}" id="${id}"></div>','<div class="${arrow}"></div>'];this.main.innerHTML=x.format(e.join("\n"),{className:this.helper.getPartClassName("text"),id:_.getId(this,"text"),arrow:this.helper.getPartClassName("arrow")})},i.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"mousedown",w.bind(this.layer.toggle,this.layer))},i.prototype.repaint=_.createRepaint(L.prototype.repaint,{name:["rawValue","range"],paint:function(e,i,n){if(n){if("string"==typeof n)n=e.convertToRaw(n);if(!n.begin)n.begin=new Date(1983,8,3);else if(!n.end)n.end=new Date(2046,10,4);e.range=n}if(i)g(e,i);if(e.layer)t(e,i)}},{name:["disabled","hidden","readOnly"],paint:function(e,t,i,n){if(t||i||n)e.layer.hide()}},{name:"isEndless",paint:function(e,t){if(!e.endlessCheck)e.isEndless=!1;else{var i=e.getChild("endlessCheck");if(i)i.setChecked(t)}}}),i.prototype.setRawValue=function(e){this.setProperties({rawValue:e})},i.prototype.getRawValue=function(){return this.rawValue},i.prototype.stringifyValue=function(e){return this.convertToParam(e)||""},i.prototype.parseValue=function(e){return this.convertToRaw(e)},i.prototype.dispose=function(){if(!_.isInStage(this,"DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;L.prototype.dispose.apply(this,arguments)}},x.inherits(i,L),W.register(i),i});