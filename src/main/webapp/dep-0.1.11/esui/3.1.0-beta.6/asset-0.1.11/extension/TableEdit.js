define("esui/extension/TableEdit",["require","../validator/MaxLengthRule","../validator/MaxRule","../validator/MinRule","../validator/RequiredRule","../validator/PatternRule","../Extension","../lib","../controlHelper","../main","../Table","../validator/ValidityState","../validator/Validity"],function(require){function e(e,i){if(nt=e,Z=i.rowIndex,q=i.columnIndex,!$)$=E.layer.create(),document.body.appendChild($),$.className=e.helper.getPartClassName("editor"),t();$.style.zIndex=e.zIndex||"",n(i)}function t(){o(),i()}function i(){var e=A.init($);tt=r(e,N),it=r(e,B),tt.on("click",V()),it.on("click",c()),k(1)}function n(e){if(e.field&&at!==e.field){et&&et.dispose(),et=null;var t=M+ot++,i=D+ot,n=S.g(z),a=S.g(H);n.innerHTML=S.format(Y,{inputId:t}),a.innerHTML=S.format(Q,{validId:i});var o={properties:{}};o.properties[t]=S.extend({id:t,width:145,height:20,validityLabel:D+ot},e.field.editRules),et=A.init(n,o)[0],A.init(a),et.on("enter",V()),at=e.field}}function a(e){if(e===nt){s(),et.dispose(),tt.dispose(),it.dispose();try{$&&document.body.removeChild($)}catch(t){}$=null,et=null,tt=null,it=null,nt=null,at=null}}function o(){$.innerHTML=S.format(P,{inputFieldId:z,okId:N,cancelId:B,okText:R,cancelText:G,optClass:nt.helper.getPartClassName("editor-opt"),errorClass:nt.helper.getPartClassName("editor-error"),errorId:H})}function r(e,t){for(var i=e.length-1;i>=0;i--){var n=e[i];if(n.id===t)return n}}function s(){$&&($.style.display="none")}function l(){$&&($.style.display="")}function h(e){if(e){var t=new O;t.addState("TableEditCustomRule",new T(!1,e)),et.showValidity(t)}}function m(){var e=new O;e.addState("TableEditCustomRule",new T(!0)),et.showValidity(e)}function V(){return function(){U()}}function U(){if(et.validate()){var e={value:L(),rowIndex:Z,columnIndex:q,field:nt.realFields[q]};if(e=nt.fire("saveedit",e),I(nt,"saveedit",e),!e.isDefaultPrevented())d.call(nt,e);else p.call(nt,e)}}function d(){if(this===nt)s(),j=0}function p(e){if(this===nt&&e.errorMsg)h(e.errorMsg)}function c(){return function(){g()}}function u(){if(this===nt)y(this)}function f(){if(this===nt)y(this)}function y(e){if($){var t=S.g(e.getBodyCellId(Z,q));if(t)E.layer.attachTo($,t)}}function g(){j=0,s(),k(1);var e={rowIndex:Z,columnIndex:q,field:nt.realFields[q]};e=nt.fire("canceledit",e),I(nt,"canceledit",e)}function b(t,i){if(j&&nt)g();j=1,e(t,i),k(0),l();var n=S.g(t.getBodyCellId(i.rowIndex,i.columnIndex));E.layer.attachTo($,n),x(i.value),m()}function k(e){tt.setDisabled(e),it.setDisabled(e)}function x(e){et.setValue(e)}function L(){return et.getValue()}function _(e){var t=this;if(t.startEdit){var i=S.getAttribute(e,"data-row"),n=S.getAttribute(e,"data-col");t.startEdit(i,n,e)}}function W(e,t,i){if(this.editable){var n=this.realFields[t],a={rowIndex:e,columnIndex:t,field:n};if(a=this.fire("startedit",a),I(this,"startedit",a),!a.isDefaultPrevented()){var o=this.datasource[e],r=n.editContent,s="function"==typeof r?r.call(this,o,e,t):o[n.field];b(this,{field:n,rowIndex:e,columnIndex:t,element:i,value:s})}}}function X(){if(this===nt)g()}function w(){if(this===nt)s()}function K(){if(this===nt)l()}function v(e,t,i,n,a,o){var r=i.editable;if("function"==typeof r)r=r.call(e,t,n,a,o);if(e.editable&&r)return{textClass:e.getClass("cell-editable"),html:S.format(rt,{className:e.getClass("cell-editentry"),row:n,col:a})};else return void 0}function I(e,t,i){var n=i.field["on"+t];if(n&&"[object Function]"===Object.prototype.toString.call(n))n.call(e,i)}function J(){C.apply(this,arguments)}require("../validator/MaxLengthRule"),require("../validator/MaxRule"),require("../validator/MinRule"),require("../validator/RequiredRule"),require("../validator/PatternRule");var C=require("../Extension"),S=require("../lib"),E=require("../controlHelper"),A=require("../main"),F=require("../Table"),T=require("../validator/ValidityState"),O=require("../validator/Validity"),P=['<div class="${optClass}">','<div id="${inputFieldId}"></div>','<div data-ui="id:${okId};type:Button;">${okText}</div>','<div data-ui="id:${cancelId};type:Button;">',"${cancelText}","</div>","</div>",'<div class="${errorClass}" id="${errorId}"></div>'].join(""),z="ctrl-table-editor-inputField",M="ctrl-table-editorInput",D="ctrl-table-editor-validityLabel",N="ctrl-table-editor-ok",B="ctrl-table-editor-cancel",H="ctrl-table-editor-error",R="确定",G="取消",Y='<input data-ui="type:TextBox;id:${inputId}"/>',Q='<label data-ui="type:Validity;id:${validId}"></label>',Z=-1,q=-1,j=0,$=null,et=null,tt=null,it=null,nt=null,at=null,ot=1,rt='<div class="${className}" data-row="${row}" data-col="${col}"></div>';return J.prototype.type="TableEdit",J.prototype.activate=function(){var e=this.target;if(e instanceof F)e.startEdit=W,e.cancelEdit=X,e.hideEditLayer=w,e.showEditError=K,e.addRowBuilders([{index:3,getColHtml:v}]),e.addHandlers("click",{handler:_,matchFn:E.getPartClasses(e,"cell-editentry")[0]}),e.on("enddrag",u),e.on("resize",f),C.prototype.activate.apply(this,arguments)},J.prototype.inactivate=function(){var e=this.target;if(e instanceof F)delete e.startEdit,delete e.cancelEdit,e.un("enddrag",u),e.un("resize",f),a(e),C.prototype.inactivate.apply(this,arguments)},S.inherits(J,C),A.registerExtension(J),J});