define("esui/MonthView",["require","./Button","./Select","./Panel","./lib","./controlHelper","./Control","./main","moment"],function(require){function e(){M.apply(this,arguments)}function t(e){for(var t=e.viewRange||e.range,i=[],n=t.end.getFullYear(),a=t.begin.getFullYear();n>=a;a++)i.push({text:a,value:a});return i}function i(e,t){var i=e.viewRange||e.range,n=[],a=11,o=0;if(t===i.begin.getFullYear())o=i.begin.getMonth();if(t===i.end.getFullYear())a=i.end.getMonth();for(;a>=o;o++)n.push({text:o+1,value:o});return n}function n(e){var t=['<div class="${headClass}"><table><tr>','<td width="40" align="left">','<div class="${monthBackClass}"',' data-ui-type="Button"',' data-ui-child-name="monthBack"',' data-ui-id="${monthBackId}"',"></div>","</td>","<td>",'<div class="${yearSelectClass}"',' data-ui="type:Select;childName:yearSel;',' id:${yearSelId};"></div>',"</td>","<td>",'<div class="${monthSelectClass}"',' data-ui="type:Select;childName:monthSel;',' id:${monthSelId};"></div>',"</td>",'<td width="40" align="right">','<div class="${monthForClass}"',' data-ui-type="Button"',' data-ui-child-name="monthForward"',' data-ui-id="${monthForwardId}"',"></div>","</td>","</tr></table></div>",'<div id="${monthMainId}" class="${monthMainClass}"></div>'];return t=t.join(""),P.format(t,{headClass:e.helper.getPartClassName("head"),monthBackId:e.helper.getId("monthBack"),monthForwardId:e.helper.getId("monthForward"),yearSelId:e.helper.getId("yearSel"),monthSelId:e.helper.getId("monthSel"),monthMainId:e.helper.getId("monthMain"),monthMainClass:e.helper.getPartClassName("month"),monthBackClass:e.helper.getPartClassName("month-back"),monthForClass:e.helper.getPartClassName("month-forward"),yearSelectClass:e.helper.getPartClassName("year-select"),monthSelectClass:e.helper.getPartClassName("month-select")})}function a(e){var t=[];if("multi"===e.mode)t.push("");t=t.concat(["一","二","三","四","五","六","日"]);var i='<table border="0" cellpadding="0" cellspacing="0" class="${className}"><thead><tr>',n=[];n.push(P.format(i,{className:e.helper.getPartClassName("month-main")}));for(var a='<td id="${id}" data-index="${index}" class="${className}">${text}</td>',r=e.helper.getPartClassName("month-title"),s=e.helper.getId("month-title"),l=e.helper.getPartClassName("month-select-all"),h=t.length,m=0;h>m;m++)n.push(P.format(a,{className:""===t[m]?l:r,text:t[m],index:m,id:s+"-"+m}));n.push("</tr></thead><tbody><tr>");var V='<td data-year="${year}" data-month="${month}" data-date="${date}" class="${className}" id="${id}">${date}</td>',U=e.helper.getPartClassName("month-row-select"),d=e.helper.getId("row-select"),c=0,p='<td id="${id}" class="'+U+'">&gt;</td>',u=0,f=e.year,g=e.month,y=new Date(f,g,1),b=new Date(f,g+1,1),k=1-(y.getDay()+6)%7;y.setDate(k);var x=e.helper.getPartClassName("month-item"),L=e.helper.getPartClassName("month-item-today"),_=e.helper.getPartClassName("month-item-virtual"),W=e.helper.getPartClassName("month-item-disabled"),v=e.range;if("multi"===e.mode)n.push(P.format(p,{id:d+"-"+c++}));for(;b-y>0||u%7!==0;){if(k>1&&u%7===0)if(n.push("</tr><tr>"),"multi"===e.mode)n.push(P.format(p,{id:d+"-"+c++}));var X=y.getMonth()!==g,w=!1;if(y<v.begin)w=!0;else if(y>v.end)w=!0;var K=x;if(X)K+=" "+_;else if(D().isSame(y,"day"))K+=" "+L;if(w)K+=" "+W;n.push(P.format(V,{year:y.getFullYear(),month:y.getMonth(),date:y.getDate(),className:K,id:o(e,y)})),y=new Date(f,g,++k),u++}return e.rowTagNum=c,n.push("</tr></tbody></table>"),n.join("")}function o(e,t){return e.helper.getId(t.getFullYear()+"-"+t.getMonth()+"-"+t.getDate())}function r(e){for(var t=e.target||e.srcElement,i=O.getPartClasses(this,"month-select-all"),n=O.getPartClasses(this,"month-title"),a=O.getPartClasses(this,"month-item"),o=O.getPartClasses(this,"month-row-select"),r=O.getPartClasses(this,"month-item-virtual"),s=O.getPartClasses(this,"month-item-disabled");t&&t!==document.body;){if(P.hasClass(t,a[0])&&!P.hasClass(t,r[0])&&!P.hasClass(t,s[0]))return void _(this,t);else if("multi"===this.mode){if(P.hasClass(t,o[0]))return void u(this,t);if(P.hasClass(t,n[0]))return void U(this,t);if(P.hasClass(t,i[0]))return void g(this)}t=t.parentNode}}function s(e){var t=e.rawValue;e.viewValue={};for(var i=0;i<t.length;i++){var n=t[i],a=n.getFullYear(),o=n.getMonth(),r=n.getDate(),s=a+"-"+o+"-"+r;e.viewValue[s]={isSelected:!0,value:new Date(a,o,r)}}}function l(e,t){var i=O.getPartClasses(e,"month-item-virtual"),n=O.getPartClasses(e,"month-item-disabled");if(!P.hasClass(t,i[0])&&!P.hasClass(t,n[0]))return 1;else if(P.hasClass(t,i[0])&&!P.hasClass(t,n[0]))return-1;return 0}function h(e,t,i){if(O.removePartClasses(e,"month-row-select-selected",t),i)O.addPartClasses(e,"month-row-select-selected",t)}function m(e){for(var t=e.rowTagNum,i=O.getId(e,"row-select"),n=0;t>n;n++){var a=P.g(i+"-"+n);V(e,a)}}function V(e,t){for(var i=O.getPartClasses(e,"month-item-selected"),n=t.nextSibling,a=!0,o=0;n;){if(1===l(e,n))if(++o,!P.hasClass(n,i[0])){a=!1;break}n=n.nextSibling}if(0===o)a=!1;h(e,t,a)}function U(e,t){var i=t.getAttribute("data-index"),n=O.getPartClasses(e,"month-title-selected"),a=!0;if(P.hasClass(t,n[0]))a=!1,O.removePartClasses(e,"month-title-selected",t);else O.addPartClasses(e,"month-title-selected",t);for(var o=e.rowTagNum,r=O.getId(e,"row-select"),s=e.viewValue,h=[],V=0;o>V;V++){var U=P.g(r+"-"+V),d=U.parentNode.children[i];if(1===l(e,d)){var c=d.getAttribute("data-date"),p=d.getAttribute("data-month"),u=d.getAttribute("data-year"),g=u+"-"+p+"-"+c;s[g]={isSelected:a,value:new Date(u,p,c)},h.push(g)}}if(h&&h.length>0)y(e),b(e,h,a),m(e),f(e)}function d(e,t,i){if(O.removePartClasses(e,"month-title-selected",t),i)O.addPartClasses(e,"month-title-selected",t)}function c(e){for(var t=O.getId(e,"month-title"),i=1;7>=i;i++){var n=P.g(t+"-"+i);p(e,n)}}function p(e,t){for(var i=O.getPartClasses(e,"month-item-selected"),n=t.getAttribute("data-index"),a=!0,o=0,r=e.rowTagNum,s=O.getId(e,"row-select"),h=0;r>h;h++){var m=P.g(s+"-"+h),V=m.parentNode.children[n];if(1===l(e,V))if(++o,!P.hasClass(V,i[0])){a=!1;break}}if(0===o)a=!1;d(e,t,a)}function u(e,t){var i=t.parentNode,n=O.getPartClasses(e,"month-row-select"),a=O.getPartClasses(e,"month-row-select-selected"),o=O.getPartClasses(e,"month-item-virtual"),r=O.getPartClasses(e,"month-item-disabled"),s=!0;if(P.hasClass(t,a[0]))s=!1,O.removePartClasses(e,"month-row-select-selected",t);else O.addPartClasses(e,"month-row-select-selected",t);for(var l=i.children,h=e.viewValue,m=[],V=0;V<l.length;V++){var U=l[V];if(1===U.nodeType&&!P.hasClass(U,n[0])&&!P.hasClass(U,o[0])&&!P.hasClass(U,r[0])){var d=U.getAttribute("data-date"),p=U.getAttribute("data-month"),u=U.getAttribute("data-year"),g=u+"-"+p+"-"+d;h[g]={isSelected:s,value:new Date(u,p,d)},m.push(g)}}if(m&&m.length>0)y(e),b(e,m,s),c(e),f(e)}function f(e){for(var t=e.rowTagNum,i=O.getId(e,"row-select"),n=P.g(O.getId(e,"month-title-0")),a=O.getPartClasses(e,"month-row-select-selected"),o=0,r=0;t>r;r++){var s=P.g(i+"-"+r);if(P.hasClass(s,a[0]))o++}if(o===t)O.addPartClasses(e,"month-select-all-selected",n);else O.removePartClasses(e,"month-select-all-selected",n)}function g(e){for(var t=e.rowTagNum,i=O.getId(e,"row-select"),n=0;t>n;n++){var a=P.g(i+"-"+n);O.removePartClasses(e,"month-row-select-selected",a),u(e,a)}}function y(e){var t=[];for(var i in e.viewValue)if(e.viewValue[i].isSelected)t.push(e.viewValue[i].value);t.sort(function(e,t){return e-t}),e.rawValue=t,e.fire("change")}function b(e,t,i){if(i)x(e,t);else k(e,t)}function k(e,t){for(var i=e,n=0;n<t.length;n++){var a=O.getId(e,t[n]),o=P.g(a);if(o)P.removeClasses(o,O.getPartClasses(i,"month-item-selected"))}}function x(e,t){for(var i=e,n=0;n<t.length;n++){var a=O.getId(e,t[n]),o=P.g(a);if(o)P.addClasses(o,O.getPartClasses(i,"month-item-selected"))}}function L(e,t,i){if(!t)return!1;var n=O.getPartClasses(e,i);if(P.hasClass(t,n[0]))return O.removePartClasses(e,i,t),!1;else return O.addPartClasses(e,i,t),!0}function _(e,t){var i=t.getAttribute("data-date"),n=t.getAttribute("data-month"),a=t.getAttribute("data-year"),o=a+"-"+n+"-"+i;if("multi"===e.mode){var r=L(e,t,"month-item-selected");e.viewValue[o]={isSelected:r,value:new Date(a,n,i)},y(e);var s=t.parentNode.firstChild;V(e,s),c(e),f(e)}else{var l=O.getPartClasses(e,"month-item-selected");if(P.hasClass(t,l[0]))return;var h=new Date(a,n,i);X(e,e.rawValue,h),e.rawValue=h,e.fire("change"),e.fire("itemclick")}}function W(e,t,i){var n=e,a=n.viewRange||n.range,o=12*a.begin.getFullYear()+a.begin.getMonth(),r=12*a.end.getFullYear()+a.end.getMonth(),s=12*t+i,l=new Date(t,i,1);if(i=l.getMonth(),o-s>0)i+=o-s;else if(s-r>0)i-=s-r;return l.setMonth(i),i=l.getMonth(),t=l.getFullYear(),{year:t,month:i}}function v(e,i,n){if(null==i)i=e.year;if(null==n)n=e.month;var a=e,o=W(a,i,n);a.month=o.month,a.year=o.year;var r=a.getChild("yearSel"),s=r.getValue();if(r.setProperties({datasource:t(a),value:a.year}),s===a.year)r.fire("change")}function X(e,t,i){if(t!==i){if(t){var n=P.g(o(e,t));if(n)L(e,n,"month-item-selected")}var a=P.g(o(e,i));if(a)if(l(e,a))L(e,a,"month-item-selected");else return e.rawValue=null,null}return i}function w(e){var t=new Date(e.year,e.month,1),i=D(t).add("month",1);v(e,i.year(),i.month())}function K(e){var t=new Date(e.year,e.month,1),i=D(t).subtract("month",1);v(e,i.year(),i.month())}function I(e,t){var n=parseInt(t.getValue(),10);e.year=n;var a=e.month,o=W(e,n,a);a=o.month,e.month=a;var r=e.getChild("monthSel"),s=r.setProperties({datasource:i(e,e.year),value:e.month});if(!s.hasOwnProperty("rawValue"))C(e,r);e.fire("changeyear")}function C(e,t){var i=parseInt(t.getValue(),10);e.month=i,J(e),e.fire("changemonth")}function J(e){var t=O.getId(e,"monthMain"),i=P.g(t);i.innerHTML=a(e);var n=i.getElementsByTagName("tr"),o=n[n.length-1];O.addPartClasses(e,"last-row",o),T(e)}function S(e){var t,i;if("string"==typeof e){var n=e.split(",");t=E(n[0]),i=E(n[1])}else t=e.begin,i=e.end;if(t>i)return{begin:i,end:t};else return{begin:t,end:i}}function E(e){function t(e){var t=e.split("-");if(t)return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10));else return null}e+="";var i=e.split(" "),n=t(i[0]);if(i[1]){var a=i[1].split(":");n.setHours(a[0]),n.setMinutes(a[1]),n.setSeconds(a[2])}return n}function A(e,t){if("single"===t)return E(e);else{for(var i=e.split(","),n=[],a=0;a<i.length-1;a+=2){var o,r=E(i[a]),s=E(i[a+1]);if(r&&s)if(r-s===0)n.push(r);else for(o=r;s>=o;)n.push(o),o=new Date(o.getFullYear(),o.getMonth(),o.getDate()+1);else;}return n}}function T(e){if("multi"!==e.mode)return void X(e,null,e.rawValue);var t=e.viewValue;for(var i in t){var n=P.g(O.getId(e,i));if(n){var a=l(e,n);if(1===a)if(t[i].isSelected)O.addPartClasses(e,"month-item-selected",n);else O.removePartClasses(e,"month-item-selected",n);else if(0===a)t[i].isSelected=!1,y(e)}}m(e),c(e),f(e)}function F(e,t,i){var n=e.helper.getPartClasses(t+"-layer"),a=i.layer;a.addCustomClasses(n),e.fire("selectlayerrendered",{layer:a})}require("./Button"),require("./Select"),require("./Panel");var P=require("./lib"),O=require("./controlHelper"),M=require("./Control"),z=require("./main"),D=require("moment");return e.prototype={type:"MonthView",initOptions:function(e){var t={range:{begin:new Date(1982,10,4),end:new Date(2046,10,4)},dateFormat:"YYYY-MM-DD",paramFormat:"YYYY-MM-DD",viewValue:{},mode:"single"};P.extend(t,e),this.setProperties(t)},setProperties:function(e){if(e.range)e.range=S(e.range);var t=new Date,i=e.mode||this.mode;if(null==e.rawValue)if(e.value)e.rawValue=A(e.value,i);else if(null==this.rawValue)if("single"===i)e.rawValue=t;else e.rawValue=[];var n=e.year,a=e.month;if(!n&&null==a)if("single"===i){if(e.rawValue)n=e.rawValue.getFullYear(),a=e.rawValue.getMonth()+1}else n=t.getFullYear(),a=t.getMonth()+1;if(n&&a)e.year=parseInt(n,10),e.month=parseInt(a,10)-1;else if(e.hasOwnProperty("year")){if(null==this.month)delete e.year}else if(e.hasOwnProperty("month"))if(null==this.year)delete e.month;else e.month=parseInt(a,10)-1;var o=M.prototype.setProperties.apply(this,arguments);if(o.hasOwnProperty("rawValue"))this.fire("change");return o},initStructure:function(){if(this.main.innerHTML=n(this),this.initChildren(this.main),"multi"===this.mode)this.addState("multi-select")},initEvents:function(){var e=this.getChild("monthBack");e.on("click",P.curry(K,this));var t=this.getChild("monthForward");t.on("click",P.curry(w,this));var i=this.getChild("monthSel");i.on("change",P.curry(C,this,i)),i.on("layerrendered",P.curry(F,this,"month-select"));var n=this.getChild("yearSel");n.on("change",P.curry(I,this,n)),n.on("layerrendered",P.curry(F,this,"year-select"));var a=this.helper.getPart("monthMain");O.addDOMEvent(this,a,"click",r)},repaint:O.createRepaint(M.prototype.repaint,{name:["range","rawValue","year","month"],paint:function(e,t,i){if(i)if("multi"===e.mode)s(e);v(e,e.year,e.month)}},{name:"disabled",paint:function(e,t){var i=e.getChild("monthBack");i.setProperties({disabled:t});var n=e.getChild("monthForward");n.setProperties({disabled:t});var a=e.getChild("monthSel");a.setProperties({disabled:t});var o=e.getChild("yearSel");o.setProperties({disabled:t})}}),disable:function(){this.setProperties({disabled:!0}),this.addState("disabled")},enable:function(){this.setProperties({disabled:!1}),this.removeState("disabled")},setRange:function(e){this.setProperties({range:e})},setRawValue:function(e){this.setProperties({rawValue:e})},getRawValue:function(){return this.rawValue},getValue:function(){return this.stringifyValue(this.rawValue)},stringifyValue:function(e){if("single"===this.mode)return P.date.format(e,this.paramFormat)||"";else{for(var t=[],i=864e5,n=0;n<e.length;n++)if(0===n)t.push(P.date.format(e[n],this.paramFormat));else if(e[n]-e[n-1]>i)t.push(P.date.format(e[n-1],this.paramFormat)),t.push(P.date.format(e[n],this.paramFormat));else if(n===e.length-1)t.push(P.date.format(e[n],this.paramFormat));else continue;return t.join(",")}},parseValue:function(e){return A(e,this.mode)},setRawValueWithoutFireChange:function(e){this.rawValue=e,s(this)},getDateItemHTML:function(e){return P.g(o(this,e))}},P.inherits(e,M),z.register(e),e});