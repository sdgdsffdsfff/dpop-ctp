define("esui/RichCalendar",["require","./Button","./MonthView","./TextBox","./lib","./controlHelper","./InputControl","./Layer","./main","moment","underscore"],function(require){function e(){y.apply(this,arguments)}function t(e){for(var t=e.displayNum,n='<div id="${id}" class="${className}">${monthView}</div>',a=[],o=0;t>o;o++)a.push(u.format(n,{id:e.helper.getId("month-"+o),className:e.helper.getPartClassName("month-container"),monthView:i(e,o)}));return u.format('<div id="${id}" class="${className}">${monthViews}</div>',{id:e.helper.getId("months"),className:e.helper.getPartClassName("months"),monthViews:a.join("")})}function i(e,t){var i='<div data-ui-type="MonthView" data-ui-child-name="${calName}" data-ui-mode="multi"></div>';return u.format(i,{calName:"monthView"+t})}function n(){g.apply(this,arguments),this.layer=new e(this)}function a(e,t){for(var i=this.getRawValue(),n=e.displayNum,a=0;n>a;a++)if(a!==t){var o=e.getChild("monthView"+a);o.setRawValueWithoutFireChange(i)}e.rawValue=i,l(e,i)}function o(e,t){for(var i=e.displayNum,n=new Date(this.year,this.month,1),a=0;i>a;a++)if(a!==t){var r=e.getChild("monthView"+a);r.un("changemonth"),r.un("changeyear");var s,l=t-a;if(l>0)s=k(n).subtract("month",l);else s=k(n).add("month",-l);r.setProperties({month:s.month()+1,year:s.year()}),r.on("changeyear",u.curry(o,e,a)),r.on("changemonth",u.curry(o,e,a))}}function r(e,t){for(var i=e.displayNum,n=e.startMonth,a=e.startYear,o=0;i>o;o++){var r,l,h,m=e.range.begin,d=e.range.end,V=m.getFullYear(),c=m.getMonth(),p=d.getFullYear(),U=d.getMonth();if(0===o)l=new Date(p,U-i+2,0),r={begin:e.range.begin,end:l};else if(o===i-1)h=new Date(V,c+i-1,1),r={begin:h,end:e.range.end};else h=new Date(V,c+o,1),l=new Date(p,U-i-o+2,0),r={begin:h,end:l};var u={year:a,month:n+o,rawValue:e.rawValue,range:e.range,viewRange:r};s(e,u,o,t)}}function s(e,t,i,n){var r=e.getChild("monthView"+i);if(r.setProperties(t),n===!0)r.on("change",u.curry(a,e,i)),r.on("changeyear",u.curry(o,e,i)),r.on("changemonth",u.curry(o,e,i))}function l(e,t){var i=f.getId(e,"param-value");u.g(i).value=e.stringifyValue(t);var n=e.getChild("textInput"),a=c(e,t);n.setProperties({rawValue:a}),h(e,t),e.fire("change")}function h(e,t){var i=u.g(f.getId(e,"total-num"));i.innerHTML=t.length}function m(e){e.set("rawValue",[])}function d(e){var t=e.split(",");if(1===t.length)t.push("2046-11-04");else if(""===t[0])t[0]="1983-09-03";else if(""===t[1])t[1]="2046-11-04";return{begin:V(t[0]),end:V(t[1])}}function V(e){function t(e){var t=e.split("-");if(t)return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10));else return null}if(!e)return null;e+="";var i=e.split(" "),n=t(i[0]);if(i[1]){var a=i[1].split(":");n.setHours(a[0]),n.setMinutes(a[1]),n.setSeconds(a[2])}return n}function c(e,t){for(var i=[],n=[],a=0,o=864e5,r=0;r<t.length;r++)if(0===r)i.push(u.date.format(t[r],e.paramFormat)),n.push(t[r]),a++;else if(t[r]-t[r-1]>o){if(t[r-1]-n[a-1]!==0)i.push("至"),i.push(u.date.format(t[r-1],e.paramFormat)),n.push(t[r-1]),a++;i.push("\n"),i.push(u.date.format(t[r],e.paramFormat)),n.push(t[r]),a++}else if(r===t.length-1)i.push("至"),i.push(u.date.format(t[r],e.paramFormat));else continue;return i.join("")}function p(e){for(var t=this.getValue(),i=t.replace(/\n{2,}/g,"\n").split("\n"),n=[],a={},o=!1,r=0,s=i.length;s>r;r++){var l=u.trim(i[r]);if(0!==l.length&&!a[l]){a[l]=1;var h=l.split("至"),m=h[0],d=m;if(h.length>1)d=h[1];if(U(m)&&U(d))n.push(m),n.push(d);else o=!0}else;}var V=n.join(",");e.rawValue=e.parseValue(V),this.setProperties({rawValue:c(e,e.rawValue)}),e.fire("change")}function U(e){var t=/^(\d{4})(-)(\d{2})\2(\d{2})$/,i=e.match(t);if(null==i)return!1;var n=new Date(i[1],i[3]-1,i[4]),a=""+n.getFullYear()+i[2]+(n.getMonth()+1)+i[2]+n.getDate();return e=i[1]+i[2]+(i[3]-1+1)+i[2]+(i[4]-1+1),a===e}require("./Button"),require("./MonthView"),require("./TextBox");var u=require("./lib"),f=require("./controlHelper"),g=require("./InputControl"),y=require("./Layer"),b=require("./main"),k=require("moment"),x=require("underscore");return u.inherits(e,y),e.prototype.render=function(e){document.body.appendChild(e);var i=this.control;e.innerHTML=t(i),i.helper.initChildren(e),r(i,!0)},e.prototype.toggle=function(){var e=this.getElement();if(!e||this.control.helper.isPart(e,"layer-hidden"))r(this.control,!0),this.show();else this.hide()},n.prototype={type:"RichCalendar",initOptions:function(e){var t=new Date,i={now:t,range:{begin:new Date(1983,8,3),end:new Date(2046,10,4)},paramFormat:"YYYY-MM-DD",rawValue:[],displayNum:2,startYear:t.getFullYear(),startMonth:t.getMonth()+1};if(f.extractValueFromInput(this,e),e.range&&"string"==typeof e.range)e.range=d(e.range);u.extend(i,e),this.setProperties(i)},setProperties:function(e){if(null==e.rawValue||0===e.rawValue.length)if(e.value)e.rawValue=this.parseValue(e.value);if(e.rawValue&&e.rawValue.length){var t=e.rawValue[0];e.startYear=t.getFullYear(),e.startMonth=t.getMonth()+1}var i=g.prototype.setProperties.apply(this,arguments);return i},initStructure:function(){if(u.isInput(this.main))f.replaceMain(this);var e=['<div class="${className}" id="${id}">','<textarea data-ui-type="TextBox"',' data-ui-mode="textarea"',' data-ui-width="${textBoxWidth}"',' data-ui-height="${textBoxHeight}"',' data-ui-child-name="textInput"></textarea>','<div data-ui-type="Panel" class="${generalPanelClass}"',' data-ui-child-name="generalPanel">','共<span id="${totalNumId}" ','class="${totalNumClass}"></span>天,','<span data-ui-type="Button" data-ui-skin="link"',' data-ui-child-name="deleteBtn">全部删除</span>',"</div>",'<div data-ui-type="Button" data-ui-skin="calendar"',' data-ui-child-name="modifyBtn">修改时间</div>',"</div>",'<input type="hidden" id="${inputId}" name="${name}"',' value="" />'],t=f.getPartClasses;this.main.innerHTML=u.format(e.join("\n"),{className:t(this,"text").join(" "),id:f.getId(this,"text"),textBoxWidth:this.textBoxWidth||200,textBoxHeight:this.textBoxHeight||100,name:this.name,inputId:f.getId(this,"param-value"),generalPanelClass:t(this,"general-info").join(" "),totalNumId:f.getId(this,"total-num"),totalNumClass:t(this,"total-num").join(" ")}),this.initChildren(this.main)},initEvents:function(){var e=this.getChild("modifyBtn");e.on("click",x.bind(this.layer.toggle,this.layer));var t=this.getChild("generalPanel").getChild("deleteBtn");t.on("click",u.curry(m,this));var i=this.getChild("textInput");i.on("blur",u.curry(p,this))},repaint:f.createRepaint(g.prototype.repaint,{name:["rawValue","range"],paint:function(e,t,i){if(i){if("string"==typeof i)i=d(i);if(!i.begin)i.begin=new Date(1983,8,3);else if(!i.end)i.end=new Date(2046,10,4);e.range=i}if(t)l(e,t);if(e.helper.getPart("months"))r(e)}},{name:["disabled","hidden","readOnly"],paint:function(e,t,i,n){if(t||i||n)e.layer.hide()}}),setRawValue:function(e){this.setProperties({rawValue:e})},getRawValue:function(){return this.rawValue},stringifyValue:function(e){for(var t=[],i=864e5,n=0;n<e.length;n++){if(0===n)t.push(u.date.format(e[n],this.paramFormat));else if(e[n]-e[n-1]>i)t.push(u.date.format(e[n-1],this.paramFormat)),t.push(u.date.format(e[n],this.paramFormat));if(n===e.length-1)t.push(u.date.format(e[n],this.paramFormat))}return t.join(",")},getRanges:function(){for(var e=this.rawValue,t=this.stringifyValue(e).split(","),i=[],n=0;n<t.length-1;n+=2){var a=V(t[n]),o=V(t[n+1]);i.push({begin:a,end:o})}return i},setRanges:function(e){for(var t={},i=0;i<e.length;i++){var n,a=e[i].begin,o=e[i].end;if(a&&o)if(a-o===0)t[a]=a;else for(n=a;o>=n;)t[n]=n,n=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1);else;}var r=[];for(var s in t)r.push(t[s]);r.sort(function(e,t){return e-t}),this.set("rawValue",r)},parseValue:function(e){for(var t=e.split(","),i={},n=0;n<t.length-1;n+=2){var a,o=V(t[n]),r=V(t[n+1]);if(o&&r)if(o-r===0)i[o]=o;else for(a=o;r>=a;)i[a]=a,a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1);else;}var s=[];for(var l in i)s.push(i[l]);return s.sort(function(e,t){return e-t}),s},dispose:function(){if(!f.isInStage(this,"DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;g.prototype.dispose.apply(this,arguments)}}},u.inherits(n,g),b.register(n),n});