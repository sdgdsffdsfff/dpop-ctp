define("er/controller",["require","./Deferred","./URL","./config","./util","./assert","mini-event/EventTarget","eoo","./locator","./router","./events","./permission"],function(require){function e(e,t,i){var n=e.childActionMapping[t.id];if(n){if(e.childActionMapping[t.id]=void 0,n.hijack)if(t.removeEventListener)t.removeEventListener("click",n.hijack,!1);else t.detachEvent("onclick",n.hijack);if(n.action){if(!i)i={url:null,referrer:n.url,container:t.id,isChildAction:!0};if(e.getEventBus().fire("leaveaction",{controller:e,action:n.action,to:i}),"function"==typeof n.action.leave)n.action.leave()}}}function t(t,i,n,a,o){if(e(t,i,o),i.addEventListener)i.addEventListener("click",a,!1);else i.attachEvent("onclick",a);var s={url:o.url,container:i.id,action:n,hijack:a};t.childActionMapping[i.id]=s;var r=require("mini-event/EventTarget");if(n instanceof r)n.on("leave",function(){e(t,i)})}var i=require("./Deferred"),n=require("./URL"),a=require("./config"),o=require("./util"),s=require("./assert"),exports={};exports.constructor=function(){this.actionPathMapping={},this.childActionMapping={},this.currentURL=null,this.currentAction=null,this.globalActionLoader=null,this.childActionLoaders={}},exports.registerAction=function(e){if(!e.hasOwnProperty("length"))e=[e];for(var t=0;t<e.length;t++){var i=e[t];s.hasProperty(i,"path",'action config should contains a "path" property'),this.actionPathMapping[i.path]=i}},exports.getDefaultTitle=function(){return this.defaultTitle},exports.setDefaultTitle=function(e){this.defaultTitle=e},exports.getRouter=function(){return this.router},exports.setRouter=function(e){this.router=e},exports.getLocator=function(){return this.locator},exports.setLocator=function(e){this.locator=e},exports.getEventBus=function(){return this.eventBus},exports.setEventBus=function(e){this.eventBus=e},exports.getPermissionProvider=function(){return this.permissionProvider},exports.setPermissionProvider=function(e){this.permissionProvider=e},exports.getMainContainer=function(){return this.mainContainer||a.mainElement},exports.setMainContainer=function(e){this.mainContainer=e},exports.getNoAuthorityLocation=function(){return this.noAuthorityLocation||a.noAuthorityLocation},exports.setNoAuthorityLocation=function(e){this.noAuthorityLocation=e},exports.getNotFoundLocation=function(){return this.notFoundLocation||a.notFoundLocation},exports.setNotFoundLocation=function(e){this.notFoundLocation=e},exports.start=function(){if(!this.getDefaultTitle())this.setDefaultTitle(a.systemName||document.title);this.getRouter().setBackup(o.bind(this.renderAction,this))},exports.findActionConfig=function(e){var t=e.url.getPath(),i=this.actionPathMapping[t];return i},exports.resolveActionConfig=function(e){return e},exports.checkAuthority=function(e,t){var i=e.authority;if(!i)return!0;var n=this.getPermissionProvider();if("function"==typeof i)return i(t,e,n);if("string"==typeof i)i=i.split("|");for(var a=0;a<i.length;a++)if(n.isAllow(o.trim(i[a])))return!0;return!1},exports.findEligibleActionConfig=function(e){var t=this.findActionConfig(e);if(t&&t.movedTo)return this.getEventBus().fire("actionmoved",{controller:this,url:e.url,config:t,movedTo:t.movedTo}),e.originalURL=e.url,e.url=n.parse(t.movedTo),this.findEligibleActionConfig(e);if(t&&t.childActionOnly&&!e.isChildAction)t=null;if(!t)if(this.getEventBus().fire("actionnotfound",o.mix({controller:this,failType:"NotFound",reason:"Not found"},e)),e.originalURL=e.url,e.url=n.parse(this.getNotFoundLocation()),!this.actionPathMapping[e.url.getPath()])return null;else return this.findEligibleActionConfig(e);var i=this.checkAuthority(t,e);if(!i){this.getEventBus().fire("permissiondenied",o.mix({controller:this,failType:"PermissionDenied",reason:"Permission denied",config:t},e));var a=t.noAuthorityLocation||this.getNoAuthorityLocation();return e.originalURL=e.url,e.url=n.parse(a),this.findEligibleActionConfig(e)}return t},exports.loadAction=function(e){var t=this.findEligibleActionConfig(e);if(t=this.resolveActionConfig(t,e),!t){var n=new i;return n.syncModeEnabled=!1,n.reject("no action configured for url "+e.url.getPath()),n.promise}if(t.title)e.title=t.title,e.args.title=t.title;if(t.documentTitle)e.documentTitle=t.documentTitle,e.args.documentTitle=t.documentTitle;if(t.args)for(var a in t.args)if(t.args.hasOwnProperty(a)){if(!e.args.hasOwnProperty(a))e.args[a]=t.args[a];if(!e.hasOwnProperty(a))e[a]=t.args[a]}var s=new i;s.syncModeEnabled=!1;var r=s.promise,l=!1,h=function(){if(!l)l=!0,this.getEventBus().fire("actionabort",o.mix({controller:this},e))};if(r.abort=o.bind(h,this),!e.isChildAction)this.currentURL=e.url;var V=function(n){if(!l){if(!n){var a="No action implement for "+t.type,r=o.mix({controller:this,failType:"NoModule",config:t,reason:a},e);return this.getEventBus().fire("actionfail",r),this.getEventBus().notifyError(r),void s.reject(a)}if(this.getEventBus().fire("actionloaded",{controller:this,url:e.url,config:t,action:n}),"function"==typeof n)s.resolve(new n,e);else if("function"==typeof n.createRuntimeAction){var h=function(i){if(!i){var n="Action factory returns non-action",a=o.mix({controller:this,failType:"InvalidFactory",config:t,reason:n,action:i},e);this.getEventBus().fire("actionfail",a),this.getEventBus().notifyError(a),s.reject(n)}else s.resolve(i,e)};h=o.bind(h,this);var V=n.createRuntimeAction(e);i.when(V).then(h)}else s.resolve(n,e)}};if(V=o.bind(V,this),"string"==typeof t.type)window.require([t.type],V);else V(t.type);return r},exports.enterAction=function(e,t){if(!t.isChildAction){if(t.url!==this.currentURL)return;if(this.currentAction)if(this.getEventBus().fire("leaveaction",{controller:this,action:this.currentAction,to:o.mix({},t)}),"function"==typeof this.currentAction.leave)this.currentAction.leave();this.currentAction=e,document.title=t.title||t.documentTitle||this.getDefaultTitle()}this.getEventBus().fire("enteraction",o.mix({controller:this,action:e},t));var i=function(){this.getEventBus().fire("enteractioncomplete",o.mix({controller:this,action:e},t))};i=o.bind(i,this);var n=function(e){var i="";if(!e)i="Invoke action.enter() causes error";else if(e.message){if(i=e.message,e.stack)i+="\n"+e.stack}else if(window.JSON&&"function"==typeof JSON.stringify)try{i=JSON.stringify(e)}catch(n){i=e}else i=e;var a=o.mix({failType:"EnterFail",reason:i},t);this.getEventBus().fire("enteractionfail",a),this.getEventBus().notifyError(a)};n=o.bind(n,this);var a=e.enter(t);return a.then(i,n),a},exports.forward=function(e,t,i,n){var a={url:e,container:t,isChildAction:!!n};if(n){var r=this.childActionMapping[t];a.referrer=r?r.url:null}else a.referrer=this.currentURL;o.mix(a,i),a.args=o.mix({},a),o.mix(a.args,e.getQuery()),this.getEventBus().fire("forwardaction",o.mix({controller:this},a));var l=this.loadAction(a);return s.has(l,"loadAction should always return a Promise"),l},exports.renderAction=function(e){if("string"==typeof e)e=n.parse(e);if(this.globalActionLoader&&"function"==typeof this.globalActionLoader.abort)this.globalActionLoader.abort();if(this.currentAction&&"function"==typeof this.currentAction.filterRedirect&&this.currentAction.filterRedirect(e)===!1)return i.rejected("Redirect aborted by previous action");this.globalActionLoader=this.forward(e,this.getMainContainer(),null,!1);var t=this.getEventBus();return this.globalActionLoader.then(o.bind(this.enterAction,this)).fail(o.bind(t.notifyError,t))},exports.enterChildAction=function(i,n){function a(t,i,a){i=i||{};var t=h.resolveURL(t,i);if(i.global){var o=document.getElementById(n.container),s=h.redirect(t,i);if(s&&o)e(V,o);return s}var r=V.childActionMapping[n.container],l=t.toString()!==r.url.toString(),U=l||i.force;if(U)if(i.silent)r.url=t;else V.renderChildAction(t,r.container,a);return U}function s(e){if(e.isChildActionRedirected)return!0;for(var t=e.target||e.srcElement;t&&(!t.id||!V.childActionMapping[t.id]);)t=t.parentNode;if(t.id!==n.container)return e.isChildActionRedirected=!0,!0;else return!1}function r(e){e=e||window.event;var t=e.target||e.srcElement;if("a"===t.nodeName.toLowerCase()){var i=t.getAttribute("href",2)||"";if("#"===i.charAt(0))if(!s(e)){if(e.preventDefault)e.preventDefault();else e.returnValue=!1;for(var n=i.substring(1),r=(t.getAttribute("data-redirect")||"").split(/[,\s]/),l={},h=0;h<r.length;h++){var V=o.trim(r[h]);l[V]=!0}a(n,l)}}}this.childActionLoaders[n.container]=null;var l=document.getElementById(n.container);if(l){var h=this.getLocator(),V=this;return i.redirect=a,i.reload=function(e){this.redirect(n.url,{force:!0},e)},i.back=function(e,t){var i=this.context&&this.context.referrer,n=i||e;this.redirect(n,null,t)},t(this,l,i,r,n),this.enterAction(i,n)}},exports.renderChildAction=function(e,t,a){if(s.has(t),"string"==typeof e)e=n.parse(e);var r=this.childActionLoaders[t];if(r&&"function"==typeof r.abort)r.abort();var l=this.childActionMapping[t],h=l&&l.action;if(h&&"function"==typeof h.filterRedirect&&h.filterRedirect(e)===!1)return i.rejected("Redirect aborted by previous action");var V=this.forward(e,t,a,!0),U=this.getEventBus(),m=V.then(o.bind(this.enterChildAction,this)).fail(o.bind(U.notifyError,U));return m.abort=V.abort,this.childActionLoaders[t]=m,m};var r=require("eoo").create(require("mini-event/EventTarget"),exports),l=new r;return l.setLocator(require("./locator")),l.setRouter(require("./router")),l.setEventBus(require("./events")),l.setPermissionProvider(require("./permission")),l.Controller=r,l});