define("er/ajax",["require","./assert","./util","./Deferred","eoo","mini-event/EventTarget"],function(require){function e(e,t){for(var i=e?encodeURIComponent(e):"",n=[],a=0;a<t.length;a++){var o=t[a];n[a]=this.serializeData("",o)}return i?i+"="+n.join(","):n.join(",")}function t(e,t){if(1===arguments.length)t=e,e="";if(null==t)t="";var i=this.serializeData.getKey,n=e?encodeURIComponent(e):"",a=Object.prototype.toString.call(t);switch(a){case"[object Array]":return this.serializeArray(e,t);case"[object Object]":var o=[];for(var s in t){var r=i(s,e),l=this.serializeData(r,t[s]);o.push(l)}return o.join("&");default:return n?n+"="+encodeURIComponent(t):encodeURIComponent(t)}}var i="_";t.getKey=function(e,t){return t?t+"."+e:e};var exports={};exports.constructor=function(){this.hooks={serializeData:t,serializeArray:e},this.config={cache:!1,timeout:0,charset:""}},exports.request=function(e){if("function"==typeof this.hooks.beforeExecute)this.hooks.beforeExecute(e);var t=require("./assert");t.hasProperty(e,"url","url property is required");var n={method:"POST",data:{},cache:this.config.cache,timeout:this.config.timeout,charset:this.config.charset,async:!0},a=require("./util");e=a.mix(n,e);var o=require("./Deferred"),s=new o;if("function"==typeof this.hooks.beforeCreate){var r=this.hooks.beforeCreate(e,s);if(r===!0){var l=s.promise;return l.abort=function(){},l.setRequestHeader=function(){},l}}var h=window.XMLHttpRequest?new XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP");a.mix(h,e.xhrFields);var l=s.promise,V={abort:function(){h.onreadystatechange=null;try{h.abort()}catch(e){}if(!l.status)l.status=0;l.readyState=h.readyState,l.responseText="",l.responseXML="",s.reject(l)},setRequestHeader:function(e,t){h.setRequestHeader(e,t)},getAllResponseHeaders:function(){return h.getAllResponseHeaders()},getResponseHeader:function(e){return h.getResponseHeader(e)},getRequestOption:function(t){return e[t]}};a.mix(l,V);var U={xhr:l,options:e};l.then(a.bind(this.fire,this,"done",U),a.bind(this.fire,this,"fail",U));var m=function(){if(4===h.readyState){var t=l.status||h.status;if(1223===t)t=204;if(l.status=l.status||t,l.readyState=h.readyState,l.responseText=h.responseText,l.responseXML=h.responseXML,"function"==typeof this.hooks.afterReceive)this.hooks.afterReceive(l,e);if(200>t||t>=300&&304!==t)return void s.reject(l);var i=h.responseText;if("json"===e.dataType)try{i=a.parseJSON(i)}catch(n){return l.error=n,void s.reject(l)}if("function"==typeof this.hooks.afterParse)try{i=this.hooks.afterParse(i,l,e)}catch(n){return l.error=n,void s.reject(l)}s.resolve(i)}};h.onreadystatechange=a.bind(m,this);var p=e.method.toUpperCase(),d={};if("GET"===p)a.mix(d,e.data);if(e.cache===!1)d[i]=+new Date;var c=this.hooks.serializeData("",d,"application/x-www-form-urlencoded"),u=e.url;if(c){var f=u.indexOf("?")>=0?"&":"?";u+=f+c}if(h.open(p,u,e.async),"function"==typeof this.hooks.beforeSend)this.hooks.beforeSend(l,e);if("GET"===p)h.send();else{var y=e.contentType||"application/x-www-form-urlencoded",c=this.hooks.serializeData("",e.data,y,l);if(e.charset)y+=";charset="+e.charset;h.setRequestHeader("Content-Type",y),h.send(c)}if(e.timeout>0){var b=function(){this.fire("timeout",{xhr:l,options:e}),l.status=408,l.abort()},g=setTimeout(a.bind(b,this),e.timeout);l.ensure(function(){clearTimeout(g)})}return l},exports.get=function(e,t,i){var n={method:"GET",url:e,data:t,cache:i||this.config.cache};return this.request(n)},exports.getJSON=function(e,t,i){var n={method:"GET",url:e,data:t,dataType:"json",cache:i||this.config.cache};return this.request(n)},exports.post=function(e,t,i){var n={method:"POST",url:e,data:t,dataType:i||"json"};return this.request(n)},exports.log=function(e,t){var i=new Image,n=window.ER_LOG_POOL||(window.ER_LOG_POOL={}),a=+new Date;n[a]=i,i.onload=i.onerror=i.onabort=function(){i.onload=i.onerror=i.onabort=null,n[a]=null,i=null};var o=this.hooks.serializeData("",t,"application/x-www-form-urlencoded");if(o){var s=e.indexOf("?")>=0?":":"?";e+=s+o}i.src=e};var n=require("eoo").create(require("mini-event/EventTarget"),exports),a=new n;return a.Ajax=n,a});