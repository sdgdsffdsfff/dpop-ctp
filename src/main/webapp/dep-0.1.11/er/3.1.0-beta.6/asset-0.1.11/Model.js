define("er/Model",["require","./util","./Deferred","eoo","mini-event/EventTarget"],function(require){function e(e,t){function i(i){if(t.dump)e.fill(i,h);else e.set(t.name,i,h);return{success:!0,name:t.name,options:t,value:i}}function n(e){return{success:!1,name:t.name,options:t,error:e}}try{var a=t.retrieve(e,t);if(l.isPromise(a)){if("function"==typeof a.abort)e.addPendingWorker(a);return a.then(i,function(t){t=n(t);try{var a=e.handleError(t);return i(a)}catch(o){if(o.success===!1)throw o;else throw n(o)}})}else{var o=i(a);return l.resolved(o)}}catch(r){var s=n(r);return l.rejected(s)}}function t(e,t){for(var i=l.resolved(),a=0;a<t.length;a++){var o=t[a],r=s.bind(n,null,e,o);i=i.then(r)}return i}function i(e,t){var i=[];for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if("function"==typeof o)o={retrieve:o,name:a};else if("function"==typeof o.retrieve)o=s.mix({name:a},o);i.push(n(e,o))}return l.all(i)}function n(n,a){if(!a)return l.resolved();if("function"==typeof a){var o={retrieve:a,dump:!0};return e(n,o)}if(a instanceof Array)return t(n,a);if("function"==typeof a.retrieve)return e(n,a);else return i(n,a)}function a(e,t){for(var i=0;i<e.pendingWorkers.length;i++)if(e.pendingWorkers[i]===t)return void e.pendingWorkers.splice(i,1)}function o(){function e(e){var t={success:!1,name:"$prepare",options:{},error:e};throw t}try{var t=this.prepare();if(l.isPromise(t))return t.fail(e);else return t}catch(i){e(i)}}function r(e,t,i){var n=e.store.hasOwnProperty(t)?"change":"add",a=e.store[t];if(e.store[t]=i,a!==i)return{type:n,name:t,oldValue:a,newValue:i};else return null}var s=require("./util"),l=require("./Deferred"),h={silent:!0},exports={};exports.constructor=function(e){if(this.store={},this.pendingWorkers=[],e)this.fill(e,h);this.initialize()},exports.initialize=s.noop,exports.addPendingWorker=function(e){this.pendingWorkers.push(e),e.ensure(s.bind(a,null,this,e))},exports.datasource=null,exports.getDatasource=function(){return this.datasource},exports.load=function(){try{var e=this.getDatasource(),t=n(this,e);return t.then(s.bind(o,this))}catch(i){return l.rejected(i)}},exports.prepare=s.noop,exports.get=function(e){return this.store[e]},exports.set=function(e,t,i){i=i||{};var n=r(this,e,t);if(n&&!i.silent){var a={changes:[n]};this.fire("change",a)}return t},exports.fill=function(e,t){t=t||{};var i=[];for(var n in e)if(e.hasOwnProperty(n)){var a=r(this,n,e[n]);if(a)i.push(a)}if(i.length&&!t.silent){var o={changes:i};this.fire("change",o)}return e},exports.remove=function(e,t){if(this.store.hasOwnProperty(e)){t=t||{};var i=this.store[e];if(delete this.store[e],!t.silent){var n={changes:[{type:"remove",name:e,oldValue:i,newValue:void 0}]};this.fire("change",n)}return i}},exports.getAsModel=function(e){var t=this.get(e);if(!t||"[object Object]"!=={}.toString.call(t))return new V;else return new V(t)},exports.dump=function(){return s.mix({},this.store)},exports.has=function(e){return this.store.hasOwnProperty(e)},exports.hasValue=function(e){return this.has(e)&&null!=this.store[e]},exports.hasReadableValue=function(e){return this.hasValue(e)&&""!==this.store[e]},exports.valueOf=function(){return this.dump()},exports.clone=function(){return new V(this.store)},exports.handleError=function(e){throw e},exports.dispose=function(){if(this.pendingWorkers){for(var e=0;e<this.pendingWorkers.length;e++){var t=this.pendingWorkers[e];if("function"==typeof t.abort)try{t.abort()}catch(i){}}this.pendingWorkers=null}};var V=require("eoo").create(require("mini-event/EventTarget"),exports);return V});