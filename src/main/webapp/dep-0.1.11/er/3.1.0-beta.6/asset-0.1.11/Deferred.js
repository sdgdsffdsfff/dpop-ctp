define("er/Deferred",["require","./util","./assert","eoo","mini-event/EventTarget"],function(require){function e(e){function t(){for(var t=0;t<i.length;t++){var n=i[t];try{n.apply(e.promise,e._args)}catch(a){}}}if("pending"!==e.state){var i="resolved"===e.state?e._doneCallbacks.slice():e._failCallbacks.slice();if(e.syncModeEnabled)t();else a(t);e._doneCallbacks=[],e._failCallbacks=[]}}function t(e,t,i,n){return function(){if("function"==typeof i){var a=t.resolver;try{var s=i.apply(e.promise,arguments);if(o.isPromise(s))s.then(a.resolve,a.reject);else a.resolve(s)}catch(r){o.fire("exception",{deferred:e,args:[r],reason:r}),a.reject(r)}}else t[n].apply(t,e._args)}}var i=require("./util"),n=require("./assert"),a="function"==typeof window.setImmediate?function(e){window.setImmediate(e)}:function(e){window.setTimeout(e,0)},exports={};exports.constructor=function(){this.state="pending",this._args=null,this._doneCallbacks=[],this._failCallbacks=[],this.promise={done:i.bind(this.done,this),fail:i.bind(this.fail,this),ensure:i.bind(this.ensure,this),then:i.bind(this.then,this)},this.promise.promise=this.promise,this.resolver={resolve:i.bind(this.resolve,this),reject:i.bind(this.reject,this)}},exports.syncModeEnabled=!1,exports.resolve=function(){if("pending"===this.state)this.state="resolved",this._args=[].slice.call(arguments),o.fire("resolve",{deferred:this,args:this._args,reason:this._args[0]}),e(this)},exports.reject=function(){if("pending"===this.state)this.state="rejected",this._args=[].slice.call(arguments),o.fire("reject",{deferred:this,args:this._args,reason:this._args[0]}),e(this)},exports.done=function(e){return this.then(e)},exports.fail=function(e){return this.then(null,e)},exports.ensure=function(e){return this.then(e,e)},exports.then=function(i,n){var a=new o;return a.syncModeEnabled=this.syncModeEnabled,this._doneCallbacks.push(t(this,a,i,"resolve")),this._failCallbacks.push(t(this,a,n,"reject")),e(this),a.promise};var o=require("eoo").create(exports);return require("mini-event/EventTarget").enable(o),o.isPromise=function(e){return e&&"function"==typeof e.then},o.all=function(){function e(e){s--,n.greaterThanOrEquals(s,0,"workingCount should be positive");var t=[].slice.call(arguments,1);if(t.length<=1)t=t[0];if(l[e]=t,0===s)h[r].apply(h,l)}function t(){r="reject",e.apply(this,arguments)}var a=[].concat.apply([],arguments),s=a.length;if(!s)return o.resolved();for(var r="resolve",l=[],h=new o,V=0;V<a.length;V++){var U=a[V];U.then(i.bind(e,U,V),i.bind(t,U,V))}return h.promise},o.resolved=function(){var e=new o;return e.resolve.apply(e,arguments),e.promise},o.rejected=function(){var e=new o;return e.reject.apply(e,arguments),e.promise},o.when=function(e){if(o.isPromise(e))return e;var t=new o;return t.syncModeEnabled=!0,t.resolve(e),t.promise},o.require=function(e){var t=new o;return window.require(e,t.resolver.resolve),t.promise.abort=t.resolver.reject,t.promise},o});