!function(e){function t(e,t){for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i];return e}function i(){this.raw=[],this.length=0}function n(){return"___"+K++}function a(e,t){var i=new Function;i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}function r(e){return C[e]}function o(e){return'"'+e.replace(/\x5C/g,"\\\\").replace(/"/g,'\\"').replace(/\x0A/g,"\\n").replace(/\x09/g,"\\t").replace(/\x0D/g,"\\r")+'"'}function s(e){var t=arguments;return e.replace(/\{([0-9]+)\}/g,function(e,i){return t[i-0+1]})}function l(e){return e=e.replace(/^\s*\*/,""),s('gv({0},["{1}"])',o(e),e.replace(/\[['"]?([^'"]+)['"]?\]/g,function(e,t){return"."+t}).split(".").join('","'))}function h(e,t,i,n,a,r){for(var o=i.length,s=e.split(t),l=0,h=[],d=0,m=s.length;m>d;d++){var c=s[d];if(d){var p=1;for(l++;;){var u=c.indexOf(i);if(0>u){h.push(l>1&&p?t:"",c);break}if(l=n?l-1:0,h.push(l>0&&p?t:"",c.slice(0,u),l>0?i:""),c=c.slice(u+o),p=0,0===l)break}if(0===l)a(h.join("")),r(c),h=[]}else c&&r(c)}if(l>0&&h.length>0)r(t),r(h.join(""))}function d(e,t,i){var n,a=[],r=t.options,s="",m="",c="",p="";if(i)s="ts(",m=")",c=E,p=T,n=r.defaultFilter;return h(e,r.variableOpen,r.variableClose,1,function(e){if(i&&e.indexOf("|")<0&&n)e+="|"+n;var r=e.indexOf("|"),o=(r>0?e.slice(0,r):e).replace(/^\s+/,"").replace(/\s+$/,""),h=r>0?e.slice(r+1):"",u=0===o.indexOf("*"),V=[u?"":s,l(o),u?"":m];if(h){h=d(h,t);for(var U=h.split("|"),f=0,g=U.length;g>f;f++){var y=U[f];if(/^\s*([a-z0-9_-]+)(\((.*)\))?\s*$/i.test(y)){if(V.unshift('fs["'+RegExp.$1+'"]('),RegExp.$3)V.push(",",RegExp.$3);V.push(")")}}}a.push(c,V.join(""),p)},function(e){a.push(c,i?o(e):e,p)}),a.join("")}function m(e,t){this.value=e,this.engine=t}function c(e,t){this.value=e,this.engine=t,this.children=[]}function p(e,t){var i=e.stack,n=t?i.find(function(e){return e instanceof t}):i.bottom();if(n){var a;do{if(a=i.top(),!a.autoClose)throw new Error(a.type+" must be closed manually: "+a.value);a.autoClose(e)}while(a!==n)}return n}function u(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(\s*master\s*=\s*([a-z0-9_-]+)\s*\))?\s*/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.master=RegExp.$3,this.name=RegExp.$1,c.call(this,e,t),this.contents={}}function V(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(\s*master\s*=\s*([a-z0-9_-]+)\s*\))?\s*/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.master=RegExp.$3,this.name=RegExp.$1,c.call(this,e,t),this.contents={}}function U(e,t){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,c.call(this,e,t)}function f(e,t){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,c.call(this,e,t)}function g(e,t){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,c.call(this,e,t)}function y(e,t){if(!/^\s*([a-z0-9_]+)\s*=([\s\S]*)$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,this.expr=RegExp.$2,c.call(this,e,t)}function b(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(([\s\S]*)\))?\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,this.args=RegExp.$3,c.call(this,e,t)}function k(e,t){if(!/^\s*([a-z0-9_-]+)\s*(\(([\s\S]*)\))?\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.name=RegExp.$1,this.args=RegExp.$3,c.call(this,e,t)}function x(e,t){if(!/^\s*(\$\{[\s\S]+\})\s+as\s+\$\{([0-9a-z_]+)\}\s*(,\s*\$\{([0-9a-z_]+)\})?\s*$/i.test(e))throw new Error("Invalid "+this.type+" syntax: "+e);this.list=RegExp.$1,this.item=RegExp.$2,this.index=RegExp.$4,c.call(this,e,t)}function v(e,t){c.call(this,e,t)}function L(e,t){v.call(this,e,t)}function _(e,t){c.call(this,e,t)}function w(e,t){t.targetOrMaster=e;var i=t.engine,n=e.name,a=e instanceof u,r=a?"targets":"masters";if(i[r][n])switch(i.options.namingConflict){case"override":i[r][n]=e,a&&t.targets.push(n);case"ignore":break;default:throw new Error((a?"Target":"Master")+" is exists: "+n)}else i[r][n]=e,a&&t.targets.push(n)}function W(e,t){O[e]=t,t.prototype.type=e}function X(e){this.options={commandOpen:"<!--",commandClose:"-->",variableOpen:"${",variableClose:"}",defaultFilter:"html"},this.config(e),this.masters={},this.targets={},this.filters=t({},J)}function I(e,t){function n(){if(u.length>0){var e=u.join(""),i=new m(e,t);if(i.beforeAdd(d),l.top().addTextNode(i),u=[],t.options.strip&&d.current instanceof c)i.value=e.replace(/^[\x20\t\r]*\n/,"");d.current=i}}function a(e){return e instanceof r}var r,o=t.options.commandOpen,s=t.options.commandClose,l=new i,d={engine:t,targets:[],stack:l},u=[];return h(e,o,s,0,function(e){var i=/^\s*(\/)?([a-z]+)\s*(:([\s\S]*))?$/.exec(e);if(i&&(r=O[i[2].toLowerCase()])&&"function"==typeof r){n();var h=d.current;if(t.options.strip&&h instanceof m)h.value=h.value.replace(/\r?\n[\x20\t]*$/,"\n");if(i[1])h=l.find(a),h&&h.close(d);else{if(h=new r(i[4],t),"function"==typeof h.beforeOpen)h.beforeOpen(d);h.open(d)}d.current=h}else if(!/^\s*\/\//.test(e))u.push(o,e,s);r=null},function(e){u.push(e)}),n(),p(d),d.targets}i.prototype={push:function(e){this.raw[this.length++]=e},pop:function(){if(this.length>0){var e=this.raw[--this.length];return this.raw.length=this.length,e}},top:function(){return this.raw[this.length-1]},bottom:function(){return this.raw[0]},find:function(e){for(var t=this.length;t--;){var i=this.raw[t];if(e(i))return i}}};var K=178245,C={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},J={html:function(e){return e.replace(/[&<>"']/g,r)},url:encodeURIComponent,raw:function(e){return e}},S='var r="";',E="r+=",T=";",P="return r;";if("undefined"!=typeof navigator&&/msie\s*([0-9]+)/i.test(navigator.userAgent)&&RegExp.$1-0<8)S="var r=[],ri=0;",E="r[ri++]=",P='return r.join("");';m.prototype={getRendererBody:function(){var e=this.value,t=this.engine.options;if(!e||t.strip&&/^\s*$/.test(e))return"";else return d(e,this.engine,1)},getContent:function(){return this.value}},c.prototype={addChild:function(e){this.children.push(e)},open:function(e){var t=e.stack.top();this.parent=t,t&&t.addChild(this),e.stack.push(this)},close:function(e){for(;e.stack.pop().constructor!==this.constructor;);},addTextNode:function(e){this.addChild(e)},getRendererBody:function(){for(var e=[],t=this.children,i=0;i<t.length;i++)e.push(t[i].getRendererBody());return e.join("")}};var A='data=data||{};var v={},fs=engine.filters,hg=typeof data.get=="function",gv=function(n,ps){var p=ps[0],d=v[p];if(d==null){if(hg){return data.get(n);}d=data[p];}for(var i=1,l=ps.length;i<l;i++)if(d!=null)d = d[ps[i]];return d;},ts=function(s){if(typeof s==="string"){return s;}if(s==null){s="";}return ""+s;};';a(u,c),a(V,c),a(U,c),a(f,c),a(g,c),a(y,c),a(b,c),a(k,c),a(x,c),a(v,c),a(L,v),a(_,c);var M={READING:1,READED:2,APPLIED:3,READY:4};V.prototype.close=V.prototype.autoClose=u.prototype.close=u.prototype.autoClose=function(e){c.prototype.close.call(this,e),this.state=this.master?M.READED:M.APPLIED,e.targetOrMaster=null},u.prototype.applyMaster=V.prototype.applyMaster=function(){if(this.state>=M.APPLIED)return 1;var e=this.engine.masters[this.master];if(e&&e.applyMaster()){this.children=[];for(var t=0,i=e.children.length;i>t;t++){var n=e.children[t];if(n instanceof f)this.children.push.apply(this.children,(this.contents[n.name]||n).children);else this.children.push(n)}return this.state=M.APPLIED,1}},u.prototype.isReady=function(){function e(n){for(var a=0,r=n.children.length;r>a;a++){var o=n.children[a];if(o instanceof g){var s=t.targets[o.name];i=i&&s&&s.isReady(t)}else if(o instanceof c)e(o)}}if(this.state>=M.READY)return 1;var t=this.engine,i=1;if(this.applyMaster())return e(this),i&&(this.state=M.READY),i;else return void 0},u.prototype.getRenderer=function(){if(this.renderer)return this.renderer;if(this.isReady()){var e=new Function("data","engine",[A,S,this.getRendererBody(),P].join("\n")),t=this.engine;return this.renderer=function(i){return e(i,t)},this.renderer}return null},u.prototype.getContent=function(){if(this.isReady()){for(var e=[],t=this.children,i=0;i<t.length;i++)e.push(t[i].getContent());return e.join("")}return""},u.prototype.open=V.prototype.open=function(e){p(e),c.prototype.open.call(this,e),this.state=M.READING,w(this,e)},g.prototype.open=y.prototype.open=k.prototype.open=function(e){var t=e.stack.top();this.parent=t,t.addChild(this)},k.prototype.beforeOpen=g.prototype.beforeOpen=y.prototype.beforeOpen=x.prototype.beforeOpen=b.prototype.beforeOpen=v.prototype.beforeOpen=m.prototype.beforeAdd=function(e){if(!e.stack.bottom()){var t=new u(n(),e.engine);t.open(e)}},k.prototype.close=g.prototype.close=_.prototype.close=y.prototype.close=function(){},g.prototype.getContent=function(){var e=this.engine.targets[this.name];return e.getContent()},g.prototype.getRendererBody=function(){var e=this.engine.targets[this.name];return e.getRendererBody()},k.prototype.getRendererBody=function(){return s("{0}engine.render({2},{{3}}){1}",E,T,o(this.name),d(this.args,this.engine).replace(/(^|,)\s*([a-z0-9_]+)\s*=/gi,function(e,t,i){return(t||"")+o(i)+":"}))},y.prototype.getRendererBody=function(){if(this.expr)return s("v[{0}]={1};",o(this.name),d(this.expr,this.engine));else return""},v.prototype.getRendererBody=function(){var e=s("if({0}){{1}}",d(this.value,this.engine),c.prototype.getRendererBody.call(this)),t=this["else"];if(t)return[e,s("else{{0}}",t.getRendererBody())].join("");else return e},x.prototype.getRendererBody=function(){return s('var {0}={1};if({0} instanceof Array)for (var {4}=0,{5}={0}.length;{4}<{5};{4}++){v[{2}]={4};v[{3}]={0}[{4}];{6}}else if(typeof {0}==="object")for(var {4} in {0}){v[{2}]={4};v[{3}]={0}[{4}];{6}}',n(),d(this.list,this.engine),o(this.index||n()),o(this.item),n(),n(),c.prototype.getRendererBody.call(this))},b.prototype.getRendererBody=function(){var e=this.args;return s("{2}fs[{5}]((function(){{0}{4}{1}})(){6}){3}",S,P,E,T,c.prototype.getRendererBody.call(this),o(this.name),e?","+d(e,this.engine):"")},U.prototype.open=function(e){p(e,U),c.prototype.open.call(this,e),e.targetOrMaster.contents[this.name]=this},f.prototype.open=function(e){p(e,f),c.prototype.open.call(this,e)},U.prototype.autoClose=v.prototype.autoClose=c.prototype.close,f.prototype.autoClose=function(e){var t=this.parent.children;t.push.apply(t,this.children),this.children.length=0,this.close(e)},v.prototype.addChild=function(e){var t=this["else"];(t?t.children:this.children).push(e)},L.prototype.open=function(e){var t=new _;t.open(e);var i=p(e,v);i.addChild(this),e.stack.push(this)},_.prototype.open=function(e){var t=p(e,v);t["else"]=this,e.stack.push(t)};var O={};W("target",u),W("master",V),W("content",U),W("contentplaceholder",f),W("import",g),W("use",k),W("var",y),W("for",x),W("if",v),W("elif",L),W("else",_),W("filter",b),X.prototype.config=function(e){t(this.options,e)},X.prototype.compile=X.prototype.parse=function(e){if(e){var t=I(e,this);if(t.length)return this.targets[t[0]].getRenderer()}return new Function('return ""')},X.prototype.getRenderer=function(e){var t=this.targets[e];if(t)return t.getRenderer();else return void 0},X.prototype.get=function(e){var t=this.targets[e];if(t)return t.getContent();else return""},X.prototype.render=function(e,t){var i=this.getRenderer(e);if(i)return i(t);else return""},X.prototype.addFilter=function(e,t){if("function"==typeof t)this.filters[e]=t};var F=new X;if(F.Engine=X,"object"==typeof exports&&"object"==typeof module)exports=module.exports=F;else if("function"==typeof define&&define.amd)define([],F);else e.etpl=F}(this);