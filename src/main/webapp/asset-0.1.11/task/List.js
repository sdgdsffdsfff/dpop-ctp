/*! 2015 Baidu Inc. All Rights Reserved */
define("task/List",["require","common/extension/CustomToastHandler","common/util","common/ListAction","eoo"],function(require){var e=require("common/extension/CustomToastHandler"),t=new e,i=require("common/util"),exports={};exports.group="resource",exports.entityDescription="标注任务列表",exports.initBehavior=function(){this.$super(arguments);var e=this,n=this.view,r=this.model.get("inType"),a="#/"+r;n.table=n.get("table"),n.scrollToTop=n.get("scroll-to-top"),n.initBehave(),n.enterDocument(!0),n.on("commitAnswer",i.bind(function(i){var n=this.model.get("data").task.id;this.model.commitAnswer({inType:this.model.get("inType"),list:i.answers,groupId:this.model.get("data").group.id}).then(function(r){if(i.button.enable(),r.hasSuccess){var o={content:"该题已提交！将自动进入下一题"};t.handle(r,o),e.leave(),e.redirect(a+"/task/list~taskId="+n,{force:!0})}else if(t.handle(r,{content:r.resultInfo}),r.resultInfo.indexOf("BELONG TO THIS USER")>0)e.leave(),e.redirect(a+"/task/list~taskId="+n,{force:!0})}).fail(function(){i.button.enable()})},this)),n.on("giveUpGroup",i.bind(function(t){var i=!0;if(t.close)i=!1;if(this.model.data().giveUpGroup({inType:this.model.get("inType"),id:this.model.get("data").group.id,async:i,timeout:1e3}).then(function(i){if(!t.close)if(i.hasSuccess&&!t.url){if(t.args)return void e.redirect(a+"/statistics~reviewTaskId="+t.args);e.redirect(a+"/list")}}),t.url)return void this.redirect(t.url);else return void 0},this)),n.on("gotToLastGroup",i.bind(function(){var t=this.model.getLatestGroupIndex(),i=e.model.get("data").historyGroup;if(-1===t||0===i.length)this.view.noHistoryShow();else if(t>=0){var n=this.model.get("data").historyGroup[t].id;e.redirect(a+"/task/list~id="+n)}else if(-2===t)n=i[i.length-1].id,e.redirect(a+"/task/list~id="+n)},this)),n.on("gotToNextGroup",i.bind(function(){var t=this.model.getLatestGroupIndex(),i=this.model.get("data").historyGroup[t+2].id;e.redirect(a+"/task/list~id="+i)},this)),n.on("redirectToList",i.bind(function(){this.redirect(a+"/list")},this)),n.on("redirectToStatistics",i.bind(function(){var e=this.model.get("data").task.id;if("marker"===r)this.redirect(a+"/statistics~taskId="+e);else if("audit"===r)this.redirect(a+"/statistics~reviewTaskId="+e)},this)),n.on("loadBatchFlashAndImg",i.bind(function(e){var t=e.loadItems,r=e.batchItems,a=Math.ceil(t.length/20),o=e.loadIndex;if(r&&r.length)this.model.data().getImgUrlList({list:i.map(r,function(e){return e.id}),dataType:r[0].dataType,timeout:3e3}).then(function(e){if(o+=1,a>o)n.fire("loadBatchFlashAndImg",{loadItems:t,batchItems:t.slice(20*o,20*o+20),loadIndex:o});if(e.hasSuccess){var s=i.map(r,function(t){return{id:t.originId,imgUrl:e.data[t.originId].imgUrl,type:e.data[t.originId].wuliaoType}});n.loadFlashAndImgs(s)}})},this)),n.on("loadFlashClass",i.bind(function(e){var t=e.loadItems,i=e.loadIndex,r=t[i];if(r)this.model.data().getFlashAdAnalysisType({mcId:r.mcId,mcVersionId:r.mcVersionId,timeout:3e3}).then(function(e){if(i+=1,i<t.length)n.fire("loadFlashClass",{loadItems:t,loadIndex:i});if(e.hasSuccess)n.setFlashContent({id:r.id,info:e.data})})},this)),n.on("tradeChange",i.bind(function(e){var t=e.adTradeId,i=e.id,r=e.callback,a=e.taskType;this.model.data().changeTrade({adTradeId:t,taskType:a}).then(function(e){if(e.hasSuccess)n.model.formatTagBoxData(i,e.data.list),n.getSafetyControl(i+"-tagCtr").set("sample",e.data.sample),r()})},this))};var n=require("common/ListAction"),r=require("eoo").create(n,exports);return r});