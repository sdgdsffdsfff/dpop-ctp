/*! 2015 Baidu Inc. All Rights Reserved */
define("task/ListModel",["require","common/util","er/datasource","er/Deferred","marker/enum","audit/enum","./enum","common/GlobalData","common/ListModel","eoo"],function(require){function e(e){i.each(i.keys(e),function(t){var n=e[t].data;i.each(i.keys(n),function(r){var a=e[t].name,o=n[r].name,s=n[r].data;i.each(i.keys(s),function(e){var t=s[e].name,i=1===e.length?"0"+e:e,n={alias:i,text:a+"-"+o+"-"+t,value:i};l.addElement(n)})})})}function t(e,t){i.extend(e,t);var n=this.getLatestGroupIndex();if(e.hasPrevious=!0,e.hasNext=!0,-1===n)e.hasPrevious=!1;if(-2===n||n+2>=this.get("data").historyGroup.length)e.hasNext=!1;var r=0;if(e.task.addTime&&0!==e.task.addTime)r=new Date(e.task.addTime),e.task.addTime=i.formatTimeToSecond(r);else e.task.addTime=null;if(e.group.doneTime&&0!==e.group.doneTime)r=new Date(e.group.doneTime),e.group.doneTime=i.formatTimeToSecond(r);else e.group.doneTime=null;if(e.isReview){var l=e.task.blind?o.blind:o.noBlind;e.task.reviewTypeDesc=s.fromValue(e.task.moduserLevel).text+"/"+o.fromValue(l).text}e.task.statusAlias=a.fromValue(e.task.status).alias,e.task.statusText=a.fromValue(e.task.status).text,e.list.forEach(function(t){t.dataTypeAlias=e.dataTypeAlias}),e.historyGroup.forEach(function(e){if(e.doneTime)r=new Date(e.doneTime),e.doneTime=i.formatTimeToSecond(r);if(e.startTime)r=new Date(e.startTime),e.startTime=i.formatTimeToSecond(r)})}var i=require("common/util"),n=require("er/datasource"),r=require("er/Deferred"),a=require("marker/enum").Status,o=require("audit/enum").Blind,s=require("audit/enum").ModUserLevel,l=require("./enum").ThirdTrade,h=require("./enum").DataType,u=require("./enum").WuliaoType,d=require("common/GlobalData").getInstance(),exports={},c={canBatchModify:n.constant(!0)},f={tradeList:function(){var e=d.getTrade().then(function(e){return e.levelThree});return e}},p={tagMap:function(){var e=d.getTrade().then(function(e){return i.formatTagmap(e.tagTypeInfo)});return e}};exports.constructor=function(){this.$super(arguments),this.putDatasource(c),this.putDatasource(f),this.putDatasource(p)},exports.prepare=function(){this.$super(arguments);var n=this.get("data");if(!Array.isArray(n.list)||0!==n.list.length){var r=[],a=[];if(i.each(n.list,function(e){var t=e.wuliaoType;if(t===u.picture||t===u.flash||t===u.picText)r.push({type:u.fromValue(t).alias,id:e.refAdId||e.id,dataType:e.dataType,originId:e.id});if(t===u.flash&&n.group.dataType!==h.dsp)a.push({id:e.id,mcId:e.mcId,mcVersionId:e.mcVersionId});if(this.formatTagBoxData(e.id,e.tagInfo.tag),e.tagInfo.boxData=i.map(e.tagInfo.tag,function(e){return{name:e.name,text:e.text}}),e.tagedTagInfo&&e.tagedTagInfo.tag)this.set(e.id+"-attachOriginValue",i.map(e.tagedTagInfo.tag,function(e){return e.value=i.clone(e.tags),i.omit(e,"tags","text")}))},this),this.formatTagBoxData("batch",this.getDefaultTrade().tagInfo.tag),n.list.length)n.hasValue=!0;else n.hasValue=!1;if(this.set("imgUrlList",r),this.set("flashAdList",a),n.dataTypeAlias=h.fromValue(n.group.dataType).alias,n.dataTypeText=h.fromValue(n.group.dataType).text,t.call(this,n,{taskId:this.get("taskId")}),0===l.toArray().length)e(this.get("tradeList"))}},exports.getQuery=function(){var e={};if(this.get("taskId"))e.taskId=this.get("taskId");if(this.get("id"))e.id=this.get("id");if(this.get("inType"))e.inType=this.get("inType");return e},exports.getDataAdIds=function(){var e=this.get("data").list;return e.map(function(e){return e.id})},exports.commitAnswer=function(e){if(e&&this.getDataAdIds().length!==e.list.length)return r.rejected();else return this.data().commitAnswer(e)},exports.getDefaultTrade=function(){var e=this.get("data").list,t=null;if(this.get("data").isReview)t=i.find(e,function(e){return null!==e.tagInfo.adTradeIdLevel3||null!==e.tagedTagInfo.adTradeIdLevel3}),t.defaultTradeId=t.tagInfo.adTradeIdLevel3||t.tagedTagInfo.adTradeIdLevel3;else t=i.find(e,function(e){return null!==e.tagInfo.adTradeIdLevel3}),t.defaultTradeId=t.tagInfo.adTradeIdLevel3;return t},exports.getLatestGroupIndex=function(){var e=this.get("data").historyGroup,t=this.get("data").group.id,i=-1;if(e.forEach(function(e,n){if(e.id===t)i=n}),0===e.length)return-1;else return i-1},exports.setTagDatasource=function(e,t){this.set(e+"-attachDatasource",t)},exports.setDetailData=function(e){d.setDetailData(e)},exports.formatTagBoxData=function(e,t){var n=this.get("tagMap"),r=[],a={};i.each(t,function(t){r.push({text:t.text,name:t.name,datasource:i.assembleAttachGroupData(t.tags,n)}),a[t.name]=i.assembleAttachGroupValue(e,t.tags,n)},this),this.set(e+"-attachDatasource",r),this.set(e+"-attachValue",a)};var m=require("common/ListModel"),g=require("eoo").create(m,exports);return g});