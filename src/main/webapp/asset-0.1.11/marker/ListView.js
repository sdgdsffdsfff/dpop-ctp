/*! 2015 Baidu Inc. All Rights Reserved */
define("marker/ListView",["require","common/util","tpl!b1c6f6b6.tpl.html","etpl","./enum","er/permission","esui/Table","common/ListView","eoo"],function(require){function e(e){var t=e.name,i=this.getSafely("nameContainer");if("name-fetch"===t){var r=this.getSafely("addUser").getValue();this.model.data().getUsers(r).then(function(e){i.setContent(n.render("autoName",{list:e.data})),i.show()})}}function t(e){var t=e.target.getElementsByClassName("auto-name-list-name")[0]||e.target;if(t){var i=t.innerText;this.getSafely("addUser").setValue(i)}}var i=require("common/util");require("tpl!b1c6f6b6.tpl.html");var n=require("etpl"),r=require("./enum").Status,a=require("er/permission"),o=require("./enum").ModUserLevel,exports={};exports.tableFields=[{title:"任务ID",field:"id",sortable:!0,resizable:!1,width:30,stable:!0,content:function(e){return"<span>"+e.id+"</span>"}},{title:"任务名称",field:"taskName",sortable:!1,resizable:!1,width:50,stable:!0,content:function(e){return"<span>"+e.taskName+"</span>"}},{title:"任务类型",field:"taskTypeName",sortable:!1,resizable:!1,width:20,stable:!0,content:function(e){return"<span>"+e.taskTypeName+"</span>"}},{title:"创建人",field:"addUser",sortable:!1,resizable:!1,width:40,stable:!0,content:function(e){return"<span>"+e.addUser+"</span>"}},{title:"创建日期",field:"addTime",sortable:!0,resizable:!1,width:50,stable:!0,content:function(e){var t=new Date(e.addTime);return i.formatTimeToSecond(t)}},{title:"状态",field:"status",sortable:!1,resizable:!1,width:40,stable:!0,content:function(e){var t="";switch(r.fromValue(e.status).alias){case"closed":t="task-status-closed";break;case"toBegin":t="task-status-toBegin";break;case"done":t="task-status-done";break;case"doing":t="task-status-doing"}return'<span class="'+t+'">'+r.fromValue(e.status).text+"</span>"}},{title:"操作",field:"operation",sortable:!1,resizable:!1,width:15,stable:!0,content:function(e){var t=e.status;if(t!==r.toBegin)return'<a data-ui-type="Link" class="table-command-text"href="#/marker/statistics~taskId='+e.id+'">统计</a>';else return void 0}},{title:"",field:"Marker",sortable:!1,resizable:!1,width:15,stable:!0,content:function(e){var t=e.status,i=require("esui/Table"),n=null;if(t===r.toBegin||t===r.doing)n={command:"marker",args:e.id,className:"table-command-text",text:"标注"};return i.command(n)}},{title:"",field:"download",sortable:!1,resizable:!1,width:15,stable:!0,content:function(e){var t=e.status;if(!(t!==r.closed&&t!==r.done||a.isAllow("outerMarkerRole")||a.isAllow("outerAuditRole")))return'<a data-ui-type="Link" class="table-command-text" target="_blank"href="ctp/task/download.do?taskId='+e.id+'">下载</a>';else return void 0}},{title:"",field:"createAudit",sortable:!1,resizable:!1,width:30,stable:!0,content:function(e){var t=e.status,i=require("esui/Table"),n=null;if(!(t!==r.closed||a.isAllow("outerMarkerRole")||a.isAllow("innerMarkerRole")&&e.moduserLevel===o.inner))n={command:"createAudit",args:e.id,className:"table-command-text",text:"生成审核"};return i.command(n)}},{title:"",field:"changeStatus",sortable:!1,resizable:!1,width:40,stable:!0,content:function(e){var t=e.status,i=require("esui/Table"),n=null;if(a.isAllow("managerRole")||a.isAllow("innerAuditRole"))if(t===r.closed)n={command:"restore",args:e.id,className:"table-status-off",text:"启用"};else n={command:"pause",args:e.id,className:"table-status-on",text:"关闭"};return i.command(n)}}],exports.template="markerList",exports.uiEvents={"table:command":"commandHandler","addUser:command":e,"addUser:blur":"hideNamePanel"},exports.enterDocument=function(){this.$super(arguments),this.hideNamePanel();var e=this.getSafely("nameContainer");if(e)e.helper.addDOMEvent(e.main,"click",i.bind(t,this))},exports.commandHandler=function(e){this.$super(arguments);var t=e.name,i=JSON.parse(e.args);if("marker"===t)this.fire("beginMarker",{data:i});else if("createAudit"===t){var n=this.model.getItemById(i).taskName,r="/audit/create~fromPath=marker&id="+i+"&selectIdDimesion="+n,a={url:r};this.popDrawerAction(a).show()}},exports.hideNamePanel=function(){var e=this;setTimeout(function(){e.getSafely("nameContainer").hide()},200)},exports.updateBatchButtonStatus=function(){this.$super(arguments);var e=this.getSelectedItems(),t="javascript:void(0)",n="ctp/task/download.do",o=i.pluck(e,"id"),s=this.getSafely("download");if(i.all(e,function(e){return(e.status===r.closed||e.status===r.done)&&!(a.isAllow("outerMarkerRole")||a.isAllow("outerAuditRole"))})&&e.length)n+="?taskId="+o.join(","),s.removeState("disabled"),s.set("href",n);else s.addState("disabled"),s.set("href",t);if(i.all(e,function(e){return e.status===r.closed&&(a.isAllow("managerRole")||a.isAllow("innerAuditRole"))}))this.getSafely("close").hide(),this.getSafely("restore").show();if(i.all(e,function(e){return e.status!==r.closed&&(a.isAllow("managerRole")||a.isAllow("innerAuditRole"))}))this.getSafely("close").show(),this.getSafely("restore").hide()},exports.submitSearch=function(){var e=this.get("time"),t=e.getRawValue();this.fire("searchAllKey",{begin:t.begin.getTime(),end:t.end.getTime()})};var s=require("common/ListView"),l=require("eoo").create(s,exports);return l});