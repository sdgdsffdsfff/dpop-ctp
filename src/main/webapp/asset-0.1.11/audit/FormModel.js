/*! 2015 Baidu Inc. All Rights Reserved */
define("audit/FormModel",["require","common/util","er/datasource","er/permission","./enum","common/GlobalData","common/FormModel","eoo"],function(require){function e(t,i){var n=[];for(var r in t)if(0!==r){var a={id:10>r?"0"+r:r,text:t[r].name};if(i&&new String(r).length<6)a.id=i+""+a.id;if(t[r].data)a.children=e(t[r].data,r);n.push(a)}return n}function t(e){var t=this.get("originTrade"),n=[];return i.each(e,function(e){if(2===e.id.length)n.push(e);else if(4===e.id.length){if(0===n.length||n.length>0&&n[n.length-1].id!==e.id.slice(0,2))n.push({id:e.id.slice(0,2),text:t[e.id.slice(0,2)].name,children:[e]});else if(n.length>0&&n[n.length-1].id===e.id.slice(0,2))n[n.length-1].children.push(e)}else if(6===e.id.length)if(0===n.length||n.length>0&&n[n.length-1].id!==e.id.slice(0,2))n.push({id:e.id.slice(0,2),text:t[e.id.slice(0,2)].name,children:[{id:e.id.slice(0,4),text:t[e.id.slice(0,2)].data[parseInt(e.id.slice(2,4))].name,children:[e]}]});else if(n.length>0&&n[n.length-1].id===e.id.slice(0,2)){var r=i.find(n[n.length-1].children,function(t){return t.id===e.id.slice(0,4)});if(r)r.children.push(e);else n[n.length-1].children.push({id:e.id.slice(0,4),text:t[e.id.slice(0,2)].data[parseInt(e.id.slice(2,4))].name,children:[e]})}}),n}var i=require("common/util"),n=require("er/datasource"),r=require("er/permission"),a=require("./enum").ModUserLevel,o=require("common/GlobalData").getInstance(),exports={},s=a.toArray(),l={moduserLevels:n.constant(s)},h={tradeList:function(t){var i=o.getTrade().then(function(i){return t.set("originTrade",i.levelThree),{children:e(i.levelThree)}});return i}},d={tagMap:function(){var e=o.getTrade().then(function(e){return i.formatTagmap(e.tagTypeInfo)});return e}},u={canUseTasks:function(e){var t=e.data().getTasks().then(function(e){return{children:i.each(e.data,function(e){e.text=e.id+" "+e.taskName})}});return t}};exports.constructor=function(){if(this.$super(arguments),this.store.entity=1,this.putDatasource(l),r.isAllow("managerRole")||r.isAllow("innerAuditRole"))this.putDatasource(u),this.putDatasource(h),this.putDatasource(d),this.set("allSelectedTrade",{children:[]})},exports.prepare=function(){if(r.isAllow("managerRole")||r.isAllow("innerAuditRole")){this.set("role","all");var e=this.get("tagMap"),t=[],n={};i.each(i.keys(e),function(r){if(i.each(e[r].source,function(e){e.text+="&nbsp"}),e[r].source.unshift({text:"全选",value:"0"}),"general"===e[r].group)t.push(e[r]),n[r]="0"}),this.set("tagDatasource",t),this.set("tagValue",n)}if(r.isAllow("innerMarkerRole"))this.set("role","inner");if(r.isAllow("outerAuditRole"))this.set("role","outer");if("create"===this.get("fromPath"))this.set("allSelectedTask",{children:[]});else if("marker"===this.get("fromPath"))this.set("taskName","每日日常审核任务"),this.set("allSelectedTask",{children:[{id:this.get("id"),text:this.get("selectIdDimesion")}]})},exports.setSelectDatasource=function(e,i){if("id-dimension"===i.id)this.set("allSelectedTask",{children:e});else if("trade-id"===i.id)this.set("allSelectedTrade",{children:t.call(this,this.omitValue(e))})},exports.omitValue=function(e,t){var n=[];return i.each(e,function(e,i){var r=n[n.length-1],a="",o=e.id;if(t)a=r,o=e;else if(0!==i)a=r.id;if(0===i||a.length>=o.length||o.slice(0,a.length)!=a&&a.length<o.length)n.push(e)}),n},exports.setTagDatasource=function(e){var t=this.get("tagMap"),n=[],r={};i.each(e,function(e){n.push(t[e]),r[e]="0"}),this.set("tagDatasource",n),this.set("tagValue",r)},exports.fillEntity=function(e){var t=/^\d+$/;if(t.test(e.groupNum)&&0!==parseInt(e.groupNum))e.groupNum=parseInt(e.groupNum);return e};var c=require("common/FormModel"),p=require("eoo").create(c,exports);return p});